<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Das Gro√üe B√∂rsenspiel - Art Deco Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Source+Sans+Pro:wght@300;400;600&display=swap');
        
        :root {
            --gold-primary: #D4AF37;
            --gold-secondary: #B8860B;
            --gold-light: #F7E7CE;
            --bronze: #CD7F32;
            --dark-blue: #1a237e;
            --navy: #0f1419;
            --cream: #FFF8DC;
            --black: #1C1C1C;
            --white: #FFFFFF;
            --accent-red: #8B0000;
            --success-green: #00FF7F;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans Pro', sans-serif;
            background: linear-gradient(135deg, var(--navy) 0%, var(--dark-blue) 50%, var(--navy) 100%);
            min-height: 100vh;
            color: var(--cream);
            position: relative;
            overflow-x: hidden;
        }

        /* Art Deco Background Pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(212, 175, 55, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(212, 175, 55, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        /* Art Deco Header */
        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            font-weight: 900;
            background: linear-gradient(45deg, var(--gold-primary), var(--gold-light), var(--gold-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 0.5rem;
            letter-spacing: 3px;
        }

        .header .subtitle {
            font-style: italic;
            color: var(--gold-light);
            font-size: 1.2rem;
            letter-spacing: 2px;
        }

        /* Art Deco Decorative Elements */
        .deco-line {
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--gold-primary), transparent);
            margin: 2rem auto;
            width: 200px;
            position: relative;
        }

        .deco-line::before,
        .deco-line::after {
            content: '‚óä';
            position: absolute;
            top: -8px;
            color: var(--gold-primary);
            font-size: 1.2rem;
        }

        .deco-line::before {
            left: -20px;
        }

        .deco-line::after {
            right: -20px;
        }

        /* Game Cards */
        .game-section {
            background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 2px solid var(--gold-primary);
            border-radius: 15px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: 
                0 8px 32px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: var(--gold-primary);
            text-align: center;
            margin-bottom: 2rem;
            letter-spacing: 1px;
        }

        /* Form Styling */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--gold-light);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255,255,255,0.1);
            border: 2px solid var(--gold-secondary);
            border-radius: 8px;
            color: var(--cream);
            font-size: 1rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--gold-primary);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
            background: rgba(255,255,255,0.15);
        }

        .form-control::placeholder {
            color: rgba(255,248,220,0.6);
        }

        /* Art Deco Buttons */
        .btn {
            background: linear-gradient(145deg, var(--gold-primary), var(--gold-secondary));
            color: var(--navy);
            border: none;
            padding: 14px 28px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-block {
            width: 100%;
        }

        .btn-secondary {
            background: linear-gradient(145deg, var(--bronze), #A0522D);
            margin-top: 1rem;
        }

        .btn-danger {
            background: linear-gradient(145deg, #DC143C, #8B0000);
            color: white;
        }

        .btn-loan {
            background: linear-gradient(145deg, #4B0082, #6A0DAD);
            color: white;
        }

        /* Dashboard Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
            border: 1px solid var(--gold-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(212, 175, 55, 0.3);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gold-primary);
            margin-bottom: 0.5rem;
            font-family: 'Playfair Display', serif;
        }

        .stat-label {
            color: var(--gold-light);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-change {
            margin-top: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .positive {
            color: var(--success-green);
        }

        .negative {
            color: #FF6347;
        }

        /* Performance Chart Placeholder */
        .chart-container {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--gold-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            min-height: 300px;
            position: relative;
        }

        /* Portfolio Overview */
        .portfolio-overview {
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Hidden sections */
        .hidden {
            display: none;
        }

        /* Alert Messages */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid;
        }

        .alert-error {
            background: rgba(139, 0, 0, 0.2);
            border-color: var(--accent-red);
            color: #FFB6C1;
        }

        .alert-success {
            background: rgba(0, 128, 0, 0.2);
            border-color: #00FF00;
            color: #90EE90;
        }

        .alert-info {
            background: rgba(0, 123, 255, 0.2);
            border-color: #007BFF;
            color: #87CEEB;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .game-section {
                padding: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Screen Reader Only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus indicators for accessibility */
        *:focus {
            outline: 3px solid var(--gold-primary);
            outline-offset: 2px;
        }

        /* Additional styles from original */
        .stock-price-section {
            border-top: 2px solid var(--gold-secondary);
            padding-top: 2rem;
        }

        .trading-grid {
            margin-bottom: 2rem;
        }

        .trading-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .trading-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(212, 175, 55, 0.3);
        }

        .special-actions-grid {
            margin-bottom: 2rem;
        }

        .special-action-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .special-action-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 8px 32px rgba(212, 175, 55, 0.4);
        }

        /* Top Performer Badge */
        .top-performer {
            background: linear-gradient(45deg, var(--gold-primary), var(--gold-light));
            color: var(--navy);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
            display: inline-block;
        }

        /* Performance Bar */
        .performance-bar {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            height: 40px;
            position: relative;
            overflow: hidden;
            margin-top: 1rem;
        }

        .performance-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold-secondary), var(--gold-primary));
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 1rem;
            color: var(--navy);
            font-weight: 600;
        }

        /* Loan Interest Display */
        .interest-rate-display {
            background: linear-gradient(145deg, rgba(75,0,130,0.2), rgba(106,13,173,0.1));
            border: 2px solid #6A0DAD;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: center;
        }

        .interest-rate-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #9370DB;
            font-family: 'Playfair Display', serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Inside Bankenplatz</h1>
            <p class="subtitle">Marktmanipulations-Edition</p>
            <div class="deco-line"></div>
        </header>

        <!-- Main Menu -->
        <section id="mainMenu" class="game-section">
            <h2 class="section-title">Willkommen im Zentrum der Finanzwelt</h2>
            
            <div style="text-align: center;">
                <button class="btn btn-block" onclick="startNewGame()" aria-describedby="start-game-desc" style="max-width: 400px; margin: 0 auto;">
                    Neues Spiel Starten
                </button>
            </div>
            
            <div class="sr-only">
                <p id="start-game-desc">Starten Sie ein neues B√∂rsenspiel f√ºr alle Mitspieler</p>
            </div>
        </section>

        <!-- Player Setup Section -->
        <section id="playerSetupSection" class="game-section hidden">
            <h2 class="section-title">Spieler-Einrichtung</h2>
            
            <div id="setupAlert"></div>
            
            <form onsubmit="setupPlayer(event)" novalidate>
                <div class="form-group">
                    <label for="playerName">Ihr Spielername</label>
                    <input type="text" id="playerName" class="form-control" 
                           placeholder="z.B. Gordon Gekko" 
                           required maxlength="30"
                           aria-describedby="player-name-help">
                    <small id="player-name-help" style="color: var(--gold-light); margin-top: 0.25rem; display: block;">
                        W√§hlen Sie einen Namen f√ºr das Spiel
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="startingCash">Startkapital (CHF)</label>
                    <input type="number" id="startingCash" class="form-control" 
                           placeholder="z.B. 10000" 
                           required min="1000" max="1000000" step="100"
                           aria-describedby="cash-help">
                    <small id="cash-help" style="color: var(--gold-light); margin-top: 0.25rem; display: block;">
                        Ihr verf√ºgbares Kapital f√ºr Aktieninvestitionen (1'000 - 1'000'000 CHF)
                    </small>
                </div>
                
                <button type="submit" class="btn btn-block">Spiel Starten</button>
                <button type="button" class="btn btn-secondary btn-block" onclick="showMainMenu()">
                    Zur√ºck
                </button>
            </form>
        </section>

        <!-- Stock Price Management Section -->
        <section id="gameDashboard" class="game-section hidden">
            <h2 class="section-title">Aktienpreis-Management</h2>
            <div id="gameInfo"></div>
            
            <!-- Stock Price Update Section -->
            <div class="stock-price-section" style="margin-bottom: 2rem;">
                <h3 style="color: var(--gold-primary); text-align: center; margin-bottom: 1.5rem;">
                    Aktuelle Aktienpreise - Runde <span id="currentRound">0</span>
                </h3>
                
                <div id="stockPriceAlert"></div>
                
                <form id="stockPriceForm" onsubmit="updateStockPrices(event)" novalidate>
                    <div class="stock-grid" style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                        <!-- Stock price inputs will be generated here -->
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button type="submit" class="btn">
                            Preise Aktualisieren & Zum Dashboard
                        </button>

                    </div>
                </form>
            </div>
        </section>

        <!-- Business Development Dashboard -->
        <section id="businessDashboard" class="game-section hidden">
            <h2 class="section-title">üìä Business Development Dashboard</h2>
            <div id="dashboardInfo"></div>
            
            <div id="dashboardAlert"></div>
            
            <!-- Key Performance Indicators -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalValueStat">-</div>
                    <div class="stat-label">Gesamtverm√∂gen</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="liquidityStat">-</div>
                    <div class="stat-label">Liquidit√§t</div>
                    <div class="stat-change" id="liquidityChange">-</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" id="portfolioValueStat">-</div>
                    <div class="stat-label">Portfolio-Wert</div>
                </div>
                
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-around; align-items: center;">
                        <div style="text-align: center;">
                            <div class="stat-value" id="performanceRoundStat" style="font-size: 1.5rem;">-</div>
                            <div class="stat-label" style="font-size: 0.8rem;">Letzte Runde</div>
                        </div>
                        <div style="width: 1px; height: 50px; background: var(--gold-secondary); margin: 0 10px;"></div>
                        <div style="text-align: center;">
                            <div class="stat-value" id="performanceTotalStat" style="font-size: 1.5rem;">-</div>
                            <div class="stat-label" style="font-size: 0.8rem;">Seit Start</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Outstanding Loans Display -->
            <div id="loanDisplay" class="hidden" style="background: linear-gradient(145deg, rgba(75,0,130,0.1), rgba(106,13,173,0.05)); border: 2px solid #6A0DAD; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                <h3 style="color: #9370DB; margin-bottom: 1rem;">üè¶ Ausstehende Darlehen</h3>
                <div id="loanDetails">
                    <!-- Loan details will be shown here -->
                </div>
            </div>
            
            <!-- Performance Visualization -->
            <div class="chart-container">
                <h3 style="color: var(--gold-primary); margin-bottom: 1.5rem;">üìà Verm√∂gensentwicklung</h3>
                <div class="line-chart" id="lineChart" style="width: 100%; height: 300px; position: relative;"></div>
            </div>
            
            <!-- Portfolio Analysis -->
            <div class="portfolio-overview">
                <h3 style="color: var(--gold-primary); margin-bottom: 1.5rem;">üíº Portfolio-Analyse</h3>
                <div id="portfolioAnalysis">
                    <!-- Portfolio breakdown will be generated here -->
                </div>
            </div>
            
            <!-- Top Performers -->
            <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                <h3 style="color: var(--gold-primary); margin-bottom: 1.5rem;">üèÜ Top Performer</h3>
                <div id="topPerformers">
                    <!-- Top performing stocks will be listed here -->
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="text-align: center; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button class="btn" onclick="proceedToTrading()" style="min-width: 200px;">
                    üìà Zum Trading
                </button>
                <button class="btn" onclick="showPenaltyInterface()" style="min-width: 200px; background: linear-gradient(145deg, #FF4500, #CC3700); color: white;">
                    üí∏ Busse Bezahlen
                </button>
                <button class="btn btn-loan" onclick="showLoanInterface()" style="min-width: 200px;">
                    üè¶ CSBS Darlehen
                </button>
                <button class="btn btn-secondary" onclick="showGameDashboard()" style="min-width: 200px;">
                    ‚Üê Zur√ºck zu Preisen
                </button>
            </div>
        </section>

        <!-- Trading Section -->
        <section id="tradingSection" class="game-section hidden">
            <h2 class="section-title">Order-Book & Trading</h2>
            <div id="gameInfoTrading"></div>
            
            <div id="tradingAlert"></div>
            
            <!-- Order Book Form -->
            <form id="orderBookForm" onsubmit="reviewTrades(event)" novalidate>
                <h3 style="color: var(--gold-primary); text-align: center; margin-bottom: 1.5rem;">
                    üìã Order-Book - Runde <span id="tradingRound">0</span>
                </h3>
                
                <div class="trading-grid" style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));">
                    <!-- Trading cards will be generated here -->
                </div>
                
                <div style="text-align: center; margin-top: 2rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button type="submit" class="btn" style="min-width: 200px;">
                        üìä Trades √úberpr√ºfen
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="showBusinessDashboard()" style="min-width: 200px;">
                        ‚Üê Zur√ºck zum Dashboard
                    </button>
                </div>
            </form>
        </section>

        <!-- Trade Confirmation Section -->
        <section id="tradeConfirmSection" class="game-section hidden">
            <h2 class="section-title">Trade-Best√§tigung</h2>
            <div id="gameInfoConfirm"></div>
            
            <div id="confirmAlert"></div>
            
            <div class="confirmation-content">
                <h3 style="color: var(--gold-primary); text-align: center; margin-bottom: 1.5rem;">
                    ‚ö†Ô∏è Best√§tigen Sie Ihre Trades
                </h3>
                
                <div id="tradesSummary" class="trades-summary">
                    <!-- Trade summary will be generated here -->
                </div>
                
                <div class="impact-summary" style="background: rgba(255,255,255,0.05); border: 1px solid var(--gold-secondary); border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0;">
                    <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">üí∞ Finanzielle Auswirkungen:</h4>
                    <div id="financialImpact">
                        <!-- Financial impact will be calculated here -->
                    </div>
                </div>
                
                <div style="text-align: center; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button class="btn" onclick="executeTrades()" style="min-width: 200px;">
                        ‚úÖ Trades Ausf√ºhren
                    </button>
                    <button class="btn" onclick="showTraderTipOff()" style="min-width: 200px; background: linear-gradient(145deg, #FFD700, #FFA500); color: var(--navy);">
                        üïµÔ∏è Trader Tip-Off
                    </button>
                    <button class="btn btn-secondary" onclick="backToOrderBook()" style="min-width: 200px;">
                        ‚Üê Zur√ºck zu Order-Book
                    </button>
                </div>
            </div>
        </section>

        <!-- Special Actions Section -->
        <section id="specialActionsSection" class="game-section hidden">
            <h2 class="section-title">Spezielle Aktionen</h2>
            <div id="gameInfoSpecial"></div>
            
            <div id="specialAlert"></div>
            
            <div class="special-actions-grid" style="display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); margin-bottom: 2rem;">
                
                <!-- Trader Action -->
                <div class="special-action-card" style="background: linear-gradient(145deg, rgba(255,215,0,0.1), rgba(255,215,0,0.05)); border: 2px solid var(--gold-primary); border-radius: 12px; padding: 2rem; backdrop-filter: blur(10px); box-shadow: 0 4px 16px rgba(0,0,0,0.3);">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üÉè</div>
                        <h3 style="color: var(--gold-primary); font-family: 'Playfair Display', serif; margin-bottom: 0.5rem;">Trader</h3>
                        <p style="color: var(--gold-light); font-size: 0.9rem;">Extra-Trade dieser Runde</p>
                    </div>
                    <button class="btn btn-block" onclick="activateTrader()">
                        üöÄ Trader aktivieren
                    </button>
                </div>

                <!-- Dividende Action -->
                <div class="special-action-card" style="background: linear-gradient(145deg, rgba(0,255,0,0.1), rgba(0,255,0,0.05)); border: 2px solid #00FF7F; border-radius: 12px; padding: 2rem; backdrop-filter: blur(10px); box-shadow: 0 4px 16px rgba(0,0,0,0.3);">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üí∞</div>
                        <h3 style="color: #00FF7F; font-family: 'Playfair Display', serif; margin-bottom: 0.5rem;">Dividende</h3>
                        <p style="color: var(--gold-light); font-size: 0.9rem;">Aussch√ºttungen erhalten</p>
                    </div>
                    <button class="btn btn-block" onclick="showDividendInterface()" style="background: linear-gradient(145deg, #00FF7F, #00CC66);">
                        üíé Dividenden verwalten
                    </button>
                </div>

                <!-- Konkurs Action -->
                <div class="special-action-card" style="background: linear-gradient(145deg, rgba(255,69,0,0.1), rgba(255,69,0,0.05)); border: 2px solid #FF4500; border-radius: 12px; padding: 2rem; backdrop-filter: blur(10px); box-shadow: 0 4px 16px rgba(0,0,0,0.3);">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üí•</div>
                        <h3 style="color: #FF6347; font-family: 'Playfair Display', serif; margin-bottom: 0.5rem;">Konkurs</h3>
                        <p style="color: var(--gold-light); font-size: 0.9rem;">Konkurse ausl√∂sen & Aktien retten</p>
                    </div>
                    <button class="btn btn-block" onclick="showBankruptcyInterface()" style="background: linear-gradient(145deg, #FF4500, #CC3700); color: white;">
                        üÜò Konkurs verwalten
                    </button>
                </div>

                <!-- Continue Action -->
                <div class="special-action-card" style="background: linear-gradient(145deg, rgba(138,43,226,0.1), rgba(138,43,226,0.05)); border: 2px solid #9370DB; border-radius: 12px; padding: 2rem; backdrop-filter: blur(10px); box-shadow: 0 4px 16px rgba(0,0,0,0.3);">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">‚û°Ô∏è</div>
                        <h3 style="color: #9370DB; font-family: 'Playfair Display', serif; margin-bottom: 0.5rem;">Weiter</h3>
                        <p style="color: var(--gold-light); font-size: 0.9rem;">Zur n√§chsten Runde</p>
                    </div>
                    <button class="btn btn-block" onclick="continueToNextRound()" style="background: linear-gradient(145deg, #9370DB, #7B68EE);">
                        üèÅ Weiter
                    </button>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button class="btn btn-secondary" onclick="showTradingSection()">
                    ‚Üê Zur√ºck zum Trading
                </button>
            </div>
        </section>

        <!-- Penalty Payment Section -->
        <section id="penaltySection" class="game-section hidden">
            <h2 class="section-title">üí∏ Busse Bezahlen</h2>
            <div id="gameInfoPenalty"></div>
            
            <div id="penaltyAlert"></div>
            
            <form id="penaltyForm" onsubmit="processPenalty(event)" novalidate>
                <h3 style="color: #FF6347; text-align: center; margin-bottom: 1.5rem;">
                    ‚ö†Ô∏è Strafzahlung vom Portfolio-Wert
                </h3>
                
                <div class="form-group">
                    <label for="penaltyPercentage">Busse in % des Portfolio-Wertes</label>
                    <input type="number" 
                           id="penaltyPercentage" 
                           class="form-control" 
                           placeholder="z.B. 10" 
                           min="0" 
                           max="70" 
                           step="0.1"
                           required
                           oninput="updatePenaltyPreview()">
                    <small style="color: var(--gold-light); margin-top: 0.25rem; display: block;">
                        Geben Sie den Prozentsatz des Portfolio-Wertes ein (0-70%)
                    </small>
                </div>
                
                <div id="penaltyPreview" style="background: rgba(255,255,255,0.05); border: 1px solid var(--gold-secondary); border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0;">
                    <!-- Penalty preview will be shown here -->
                </div>
                
                <!-- Quick Stock Liquidation Interface -->
                <div id="quickLiquidation" class="hidden" style="background: linear-gradient(145deg, rgba(255,69,0,0.1), rgba(255,69,0,0.05)); border: 2px solid #FF4500; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0;">
                    <h4 style="color: #FF6347; margin-bottom: 1rem;">üî• Schnell-Liquidation (ohne Best√§tigung)</h4>
                    <p style="color: var(--gold-light); font-size: 0.9rem; margin-bottom: 1rem;">
                        Verkaufen Sie Aktien direkt, um liquide Mittel zu schaffen:
                    </p>
                    <div id="liquidationGrid" style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                        <!-- Stock selling cards will be generated here -->
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                    <button type="submit" class="btn" id="payPenaltyBtn" style="background: linear-gradient(145deg, #FF4500, #CC3700); color: white; margin-right: 1rem;">
                        üí∏ Busse Bezahlen
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="showBusinessDashboard()">
                        ‚Üê Zur√ºck
                    </button>
                </div>
            </form>
        </section>

        <!-- Loan Section -->
        <section id="loanSection" class="game-section hidden">
            <h2 class="section-title">üè¶ CSBS Darlehen</h2>
            <div id="gameInfoLoan"></div>
            
            <div id="loanAlert"></div>
            
            <div class="interest-rate-display">
                <h3 style="color: #9370DB; margin-bottom: 0.5rem;">Ihr pers√∂nlicher Zinssatz:</h3>
                <div class="interest-rate-value" id="interestRateDisplay">-</div>
                <p style="color: var(--gold-light); margin-top: 0.5rem; font-size: 0.9rem;">pro Runde</p>
            </div>
            
            <!-- Existing Loans Display -->
            <div id="existingLoansDisplay" class="hidden" style="background: linear-gradient(145deg, rgba(220,20,60,0.1), rgba(139,0,0,0.05)); border: 2px solid #DC143C; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                <h3 style="color: #FF6347; margin-bottom: 1rem;">üí≥ Bestehende Darlehen</h3>
                <div id="existingLoansList">
                    <!-- Existing loans will be listed here -->
                </div>
            </div>
            
            <!-- Tabs for Loan Actions -->
            <div style="display: flex; gap: 1rem; margin-bottom: 2rem; justify-content: center;">
                <button class="btn" onclick="showLoanTab('new')" id="newLoanTab" style="background: linear-gradient(145deg, #4B0082, #6A0DAD); color: white;">
                    üí∞ Neues Darlehen
                </button>
                <button class="btn btn-secondary" onclick="showLoanTab('repay')" id="repayLoanTab">
                    üí≥ Darlehen Zur√ºckzahlen
                </button>
            </div>
            
            <!-- New Loan Form -->
            <form id="loanForm" onsubmit="processLoan(event)" novalidate>
                <div class="form-group">
                    <label for="loanAmount">Darlehensbetrag (CHF)</label>
                    <input type="number" 
                           id="loanAmount" 
                           class="form-control" 
                           placeholder="z.B. 50000" 
                           min="10000" 
                           step="10000"
                           required
                           oninput="updateLoanPreview()">
                    <small style="color: var(--gold-light); margin-top: 0.25rem; display: block;">
                        Min: <span id="minLoanDisplay">CHF 10'000</span> | 
                        Max: <span id="maxLoanDisplay">-</span>
                    </small>
                </div>
                
                <div id="loanPreview" style="background: rgba(255,255,255,0.05); border: 1px solid var(--gold-secondary); border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0;">
                    <!-- Loan preview will be shown here -->
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                    <button type="submit" class="btn btn-loan" style="margin-right: 1rem;">
                        üè¶ Darlehen Aufnehmen
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="showBusinessDashboard()">
                        ‚Üê Zur√ºck
                    </button>
                </div>
            </form>
            
            <!-- Repayment Form -->
            <form id="repayForm" onsubmit="processRepayment(event)" novalidate class="hidden">
                <div class="form-group">
                    <label for="repayAmount">R√ºckzahlungsbetrag (CHF)</label>
                    <input type="number" 
                           id="repayAmount" 
                           class="form-control" 
                           placeholder="z.B. 10000" 
                           min="100" 
                           step="100"
                           required
                           oninput="updateRepaymentPreview()">
                    <small style="color: var(--gold-light); margin-top: 0.25rem; display: block;">
                        Verf√ºgbare Liquidit√§t: <span id="availableCashDisplay">-</span> | 
                        Gesamtschulden: <span id="totalDebtDisplay">-</span>
                    </small>
                </div>
                
                <div id="repaymentPreview" style="background: rgba(255,255,255,0.05); border: 1px solid var(--gold-secondary); border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0;">
                    <!-- Repayment preview will be shown here -->
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                    <button type="submit" class="btn" style="background: linear-gradient(145deg, #32CD32, #228B22); color: white; margin-right: 1rem;">
                        üí≥ Schulden Zur√ºckzahlen
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="showBusinessDashboard()">
                        ‚Üê Zur√ºck
                    </button>
                </div>
            </form>
        </section>

<!-- Dividend Interface -->
        <section id="dividendSection" class="game-section hidden">
            <h2 class="section-title">üí∞ Dividenden-Verwaltung</h2>
            <div id="gameInfoDividend"></div>
            
            <div id="dividendAlert"></div>
            
            <form id="dividendForm" onsubmit="processDividends(event)" novalidate>
                <h3 style="color: #00FF7F; text-align: center; margin-bottom: 1.5rem;">
                    Dividenden pro Aktie eingeben
                </h3>
                
                <div class="dividend-grid" style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                    <!-- Dividend inputs will be generated here -->
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                    <button type="submit" class="btn" style="background: linear-gradient(145deg, #00FF7F, #00CC66); margin-right: 1rem;">
                        üíé Dividenden aussch√ºtten
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="showSpecialActions()">
                        ‚Üê Zur√ºck
                    </button>
                </div>
            </form>
        </section>

        <!-- Bankruptcy Interface -->
        <section id="bankruptcySection" class="game-section hidden">
            <h2 class="section-title">üí• Konkurs-Verwaltung</h2>
            <div id="gameInfoBankruptcy"></div>
            
            <div id="bankruptcyAlert"></div>
            
            <form id="bankruptcyForm" onsubmit="processBankruptcy(event)" novalidate>
                <h3 style="color: #FF6347; text-align: center; margin-bottom: 1.5rem;">
                    ‚ö†Ô∏è Konkurs nur bei Firmen mit ausgef√ºllten Feldern
                </h3>
                <p style="text-align: center; color: var(--gold-light); margin-bottom: 2rem;">
                    <strong>Wichtig:</strong> Nur wenn BEIDE Felder ausgef√ºllt sind, gehen Aktien in Konkurs.<br>
                    Ohne vollst√§ndige Eingabe bleiben Ihre Aktien erhalten.
                </p>
                
                <div class="bankruptcy-grid" style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));">
                    <!-- Bankruptcy inputs will be generated here -->
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                    <button type="submit" class="btn" style="background: linear-gradient(145deg, #FF4500, #CC3700); color: white; margin-right: 1rem;">
                        üÜò Konkurs abwickeln
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="showSpecialActions()">
                        ‚Üê Zur√ºck
                    </button>
                </div>
            </form>
        </section>
    </div>

    <script>
        // Stock titles constant - bereinigt ohne Sonderzeichen
        const STOCK_TITLES = [
            'CSBS',
            'Rochartis', 
            'HBB',
            'Richemontre',
            'Nestleau',  // vereinfacht von "Nest l'√©au"
            'Zurichler Versicherungen'
        ];
        
        // Display names f√ºr die Anzeige
        const STOCK_DISPLAY_NAMES = {
            'CSBS': 'CSBS',
            'Rochartis': 'Rochartis',
            'HBB': 'HBB',
            'Richemontre': 'Richemontre',
            'Nestleau': 'Nest l\'√©au',
            'Zurichler Versicherungen': 'Zurichler Versicherungen'
        };
        
        // Hilfsfunktion f√ºr Anzeigenamen
        function getStockDisplayName(stock) {
            return STOCK_DISPLAY_NAMES[stock] || stock;
        }

        // Game state
        let currentGame = null;
        let currentPlayer = null;
        let previousStockPrices = null;
        let needsRoundIncrement = false; // Track if we need to increment round

        // Initialize app
        function initApp() {
            // Check if player is already in a game
            const savedGame = localStorage.getItem('currentGame');
            const savedPlayer = localStorage.getItem('currentPlayer');
            
            if (savedGame && savedPlayer) {
                try {
                    currentGame = JSON.parse(savedGame);
                    currentPlayer = JSON.parse(savedPlayer);
                    // Initialize previousStockPrices with current prices
                    previousStockPrices = {...currentGame.stockPrices};
                    showGameDashboard();
                } catch (e) {
                    // Clear corrupted data
                    localStorage.removeItem('currentGame');
                    localStorage.removeItem('currentPlayer');
                    previousStockPrices = null;
                    showMainMenu();
                }
            } else {
                previousStockPrices = null;
                showMainMenu();
            }
        }

        // Navigation functions
        function showMainMenu() {
            // Check if there's an active game
            if (currentGame && currentPlayer) {
                if (confirm('Es gibt ein aktives Spiel. M√∂chten Sie wirklich zum Hauptmen√º zur√ºckkehren? (Das Spiel bleibt gespeichert)')) {
                    hideAllSections();
                    document.getElementById('mainMenu').classList.remove('hidden');
                }
            } else {
                hideAllSections();
                document.getElementById('mainMenu').classList.remove('hidden');
            }
        }

        function startNewGame() {
            hideAllSections();
            document.getElementById('playerSetupSection').classList.remove('hidden');
            document.getElementById('playerName').focus();
        }

        function showGameDashboard() {
            hideAllSections();
            document.getElementById('gameDashboard').classList.remove('hidden');
            updateGameInfo();
            generateStockPriceInputs();
        }

        function showBusinessDashboard() {
            hideAllSections();
            document.getElementById('businessDashboard').classList.remove('hidden');
            updateDashboardInfo();
            updateDashboardStats();
            updateLoanDisplay();
            generateLineChart();
            generatePortfolioAnalysis();
            generateTopPerformers();
        }

        function hideAllSections() {
            const sections = ['mainMenu', 'playerSetupSection', 'gameDashboard', 'businessDashboard', 'tradingSection', 'tradeConfirmSection', 'specialActionsSection', 'dividendSection', 'bankruptcySection', 'penaltySection', 'loanSection'];
            sections.forEach(section => {
                document.getElementById(section).classList.add('hidden');
            });
        }

        // Game setup functions
        function setupPlayer(event) {
            event.preventDefault();
            
            const playerName = document.getElementById('playerName').value.trim();
            const startingCash = parseInt(document.getElementById('startingCash').value);
            
            // Validation
            if (!playerName) {
                showAlert('setupAlert', 'Bitte geben Sie einen Spielernamen ein.', 'error');
                return;
            }
            
            if (!startingCash || startingCash < 1000 || startingCash > 1000000) {
                showAlert('setupAlert', 'Das Startkapital muss zwischen 1\'000 und 1\'000\'000 CHF liegen.', 'error');
                return;
            }
            
            // Create new game
            const stockPrices = STOCK_TITLES.reduce((acc, stock) => {
                acc[stock] = 100; // Default starting price
                return acc;
            }, {});
            
            const newGame = {
                created: new Date().toISOString(),
                round: 0, // Start at round 0
                stockPrices: stockPrices,
                priceHistory: [{...stockPrices}]
            };
            
            // Initialize previousStockPrices
            previousStockPrices = {...stockPrices};
            needsRoundIncrement = true; // Will increment to 1 on first price update
            
            // Create player with purchase tracking
            const player = {
                name: playerName,
                cash: startingCash,
                initialCash: startingCash,
                portfolio: STOCK_TITLES.reduce((acc, stock) => {
                    acc[stock] = 0;
                    return acc;
                }, {}),
                purchaseHistory: STOCK_TITLES.reduce((acc, stock) => {
                    acc[stock] = [];
                    return acc;
                }, {}),
                transactions: [],
                totalValue: startingCash,
                valueHistory: [startingCash],
                portfolioValueHistory: [0],
                cashHistory: [startingCash],
                loans: [], // Track active loans
                totalDebt: 0
            };
            
            // Set current game and player
            currentGame = newGame;
            currentPlayer = player;
            localStorage.setItem('currentGame', JSON.stringify(currentGame));
            localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
            
            showAlert('setupAlert', 'Spiel erfolgreich gestartet!', 'success');
            
            setTimeout(() => {
                showGameDashboard();
            }, 1000);
        }

        function leaveGame() {
            if (confirm('M√∂chten Sie das Spiel wirklich beenden?')) {
                currentGame = null;
                currentPlayer = null;
                previousStockPrices = null;
                needsRoundIncrement = false;
                localStorage.removeItem('currentGame');
                localStorage.removeItem('currentPlayer');
                showMainMenu();
            }
        }

        // Utility functions
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="alert alert-${type}" role="alert">
                    ${message}
                </div>
            `;
            
            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 3000);
            }
        }

        function updateGameInfo() {
            if (!currentGame || !currentPlayer) return;
            
            // Calculate portfolio value
            calculatePortfolioValue();
            
            const gameInfoHtml = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h3 style="color: var(--gold-primary); margin-bottom: 0.5rem;">
                        Inside Bankenplatz
                    </h3>
                    <p style="color: var(--gold-light);">
                        Runde ${currentGame.round} ‚Ä¢ 
                        Spieler: <strong>${currentPlayer.name}</strong> ‚Ä¢ 
                        Liquidit√§t: <strong>${formatCurrency(currentPlayer.cash)}</strong> ‚Ä¢ 
                        Gesamtverm√∂gen: <strong style="color: var(--gold-primary);">${formatCurrency(currentPlayer.totalValue)}</strong>
                    </p>
                </div>
            `;
            document.getElementById('gameInfo').innerHTML = gameInfoHtml;
            
            // Update current round display
            const currentRoundElement = document.getElementById('currentRound');
            if (currentRoundElement) {
                currentRoundElement.textContent = currentGame.round;
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('de-CH', {
                style: 'currency',
                currency: 'CHF',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatPercentage(value) {
            const sign = value >= 0 ? '+' : '';
            return `${sign}${value.toFixed(1)}%`;
        }

        // Stock Price Management Functions
        function generateStockPriceInputs() {
            const stockGrid = document.querySelector('.stock-grid');
            stockGrid.innerHTML = '';
            
            STOCK_TITLES.forEach(stock => {
                const currentPrice = currentGame.stockPrices[stock];
                const stockCard = document.createElement('div');
                stockCard.className = 'stock-price-card';
                stockCard.style.cssText = `
                    background: rgba(255,255,255,0.05);
                    border: 1px solid var(--gold-secondary);
                    border-radius: 8px;
                    padding: 1.5rem;
                    backdrop-filter: blur(5px);
                `;
                
                stockCard.innerHTML = `
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="price_${stock.replace(/[^a-zA-Z0-9]/g, '_')}" 
                               style="font-weight: 600; color: var(--gold-primary); margin-bottom: 0.5rem; display: block;">
                            ${getStockDisplayName(stock)}
                        </label>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <input type="number" 
                                   id="price_${stock.replace(/[^a-zA-Z0-9]/g, '_')}" 
                                   class="form-control stock-price-input"
                                   value="${currentPrice}"
                                   min="0" 
                                   max="1000" 
                                   step="10"
                                   required
                                   style="flex: 1;"
                                   aria-describedby="help_${stock.replace(/[^a-zA-Z0-9]/g, '_')}">
                            <span style="color: var(--gold-light); font-weight: 600;">CHF</span>
                        </div>
                        <small id="help_${stock.replace(/[^a-zA-Z0-9]/g, '_')}" 
                               style="color: var(--gold-light); margin-top: 0.25rem; display: block;">
                            0-1000 CHF in 10er-Schritten
                        </small>
                    </div>
                `;
                
                stockGrid.appendChild(stockCard);
            });
        }

        function updateStockPrices(event) {
            event.preventDefault();
            
            const newPrices = {};
            let hasErrors = false;
            
            // Check if we need to increment round
            if (needsRoundIncrement) {
                currentGame.round += 1;
                needsRoundIncrement = false;
            }
            
            // Process interest on loans only if loans exist
            if (currentPlayer.loans && currentPlayer.loans.length > 0) {
                currentPlayer.loans.forEach(loan => {
                    loan.totalOwed = loan.totalOwed * (1 + loan.interestRate / 100);
                });
                
                // Update total debt
                currentPlayer.totalDebt = currentPlayer.loans.reduce((sum, loan) => sum + loan.totalOwed, 0);
            }
            
            // Save previous prices before updating
            if (currentGame.stockPrices) {
                previousStockPrices = {...currentGame.stockPrices};
            }
            
            // Validate and collect new prices
            STOCK_TITLES.forEach(stock => {
                const inputId = `price_${stock.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const input = document.getElementById(inputId);
                const price = Number(input.value);
                
                if (isNaN(price) || price < 0 || price > 1000 || price % 10 !== 0) {
                    input.style.borderColor = 'var(--accent-red)';
                    hasErrors = true;
                } else {
                    input.style.borderColor = 'var(--gold-secondary)';
                    newPrices[stock] = price;
                }
            });
            
            if (hasErrors) {
                showAlert('stockPriceAlert', 'Bitte √ºberpr√ºfen Sie die Eingaben. Preise m√ºssen zwischen 0-1000 CHF in 10er-Schritten liegen.', 'error');
                return;
            }
            
            // Update game state
            currentGame.stockPrices = newPrices;
            
            // Add to price history
            if (!currentGame.priceHistory) {
                currentGame.priceHistory = [];
            }
            currentGame.priceHistory[currentGame.round] = {...newPrices};
            
            // Calculate new portfolio value
            calculatePortfolioValue();
            
            // Save to localStorage
            localStorage.setItem('currentGame', JSON.stringify(currentGame));
            localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
            
            // Update displays
            updateGameInfo();
            
            showAlert('stockPriceAlert', 'Aktienpreise erfolgreich aktualisiert! Weiter zum Dashboard...', 'success');
            
            setTimeout(() => {
                showBusinessDashboard();
            }, 1500);
        }

        function calculatePortfolioValue() {
            let totalStockValue = 0;
            
            STOCK_TITLES.forEach(stock => {
                const holdings = currentPlayer.portfolio[stock];
                const price = currentGame.stockPrices[stock];
                totalStockValue += holdings * price;
            });
            
            // Include debt in total value calculation
            currentPlayer.totalValue = currentPlayer.cash + totalStockValue - (currentPlayer.totalDebt || 0);
            
            // Update value history
            if (!currentPlayer.valueHistory) {
                currentPlayer.valueHistory = [];
            }
            
            // Only add if it's a new round
            if (currentPlayer.valueHistory.length <= currentGame.round) {
                currentPlayer.valueHistory.push(currentPlayer.totalValue);
            } else {
                // Update current round value
                currentPlayer.valueHistory[currentGame.round] = currentPlayer.totalValue;
            }
            
            // Update portfolio value history
            if (!currentPlayer.portfolioValueHistory) {
                currentPlayer.portfolioValueHistory = [];
            }
            if (currentPlayer.portfolioValueHistory.length <= currentGame.round) {
                currentPlayer.portfolioValueHistory.push(totalStockValue);
            } else {
                currentPlayer.portfolioValueHistory[currentGame.round] = totalStockValue;
            }
            
            // Update cash history
            if (!currentPlayer.cashHistory) {
                currentPlayer.cashHistory = [];
            }
            if (currentPlayer.cashHistory.length <= currentGame.round) {
                currentPlayer.cashHistory.push(currentPlayer.cash);
            } else {
                currentPlayer.cashHistory[currentGame.round] = currentPlayer.cash;
            }
        }

        // Calculate average purchase price
        function getAveragePurchasePrice(stock) {
            if (!currentPlayer.purchaseHistory || !currentPlayer.purchaseHistory[stock]) {
                return 0;
            }
            
            const purchases = currentPlayer.purchaseHistory[stock];
            if (purchases.length === 0) return 0;
            
            let totalShares = 0;
            let totalCost = 0;
            
            purchases.forEach(purchase => {
                totalShares += purchase.amount;
                totalCost += purchase.amount * purchase.price;
            });
            
            return totalShares > 0 ? totalCost / totalShares : 0;
        }

        // Calculate realized profit/loss for a stock from sales
        function calculateRealizedProfit(stock) {
            if (!currentPlayer.transactions) return 0;
            
            let realizedProfit = 0;
            const sales = currentPlayer.transactions.filter(t => t.stock === stock && (t.type === 'sell' || t.type === 'quick_sell'));
            
            sales.forEach(sale => {
                // Get average purchase price at time of sale
                const avgPurchasePrice = getAveragePurchasePriceAtTime(stock, sale);
                const profitPerShare = sale.price - avgPurchasePrice;
                realizedProfit += profitPerShare * sale.amount;
            });
            
            return realizedProfit;
        }
        
        // Helper function to get average purchase price at a specific point
        function getAveragePurchasePriceAtTime(stock, sale) {
            if (!currentPlayer.purchaseHistory || !currentPlayer.purchaseHistory[stock]) {
                return sale.price; // If no history, assume break-even
            }
            
            // For simplicity, use current average purchase price
            // In a more complex implementation, you'd track historical purchase prices
            return getAveragePurchasePrice(stock) || sale.price;
        }

        // Business Dashboard Functions
        function updateDashboardInfo() {
            if (!currentGame || !currentPlayer) return;
            
            const gameInfoHtml = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h3 style="color: var(--gold-primary); margin-bottom: 0.5rem;">
                        Business Intelligence - Runde ${currentGame.round}
                    </h3>
                    <p style="color: var(--gold-light);">
                        Spieler: <strong>${currentPlayer.name}</strong> ‚Ä¢ 
                        Zeit f√ºr strategische Entscheidungen
                    </p>
                </div>
            `;
            document.getElementById('dashboardInfo').innerHTML = gameInfoHtml;
        }

        function updateDashboardStats() {
            calculatePortfolioValue();
            
            // Total Value
            document.getElementById('totalValueStat').textContent = formatCurrency(currentPlayer.totalValue);
            
            // Liquidity
            document.getElementById('liquidityStat').textContent = formatCurrency(currentPlayer.cash);
            const absTotal = Math.abs(currentPlayer.totalValue) || 1; // Avoid division by zero
            const liquidityRatio = (currentPlayer.cash / absTotal) * 100;
            document.getElementById('liquidityChange').textContent = `${liquidityRatio.toFixed(1)}% des Verm√∂gens`;
            
            // Portfolio Value (stocks only, without cash but including debt for accuracy)
            const portfolioValue = currentPlayer.totalValue - currentPlayer.cash + (currentPlayer.totalDebt || 0);
            document.getElementById('portfolioValueStat').textContent = formatCurrency(portfolioValue);
            
            // Performance - Last Round
            let performanceRound = 0;
            if (currentPlayer.valueHistory && currentPlayer.valueHistory.length >= 2) {
                const currentValue = currentPlayer.valueHistory[currentPlayer.valueHistory.length - 1];
                const previousValue = currentPlayer.valueHistory[currentPlayer.valueHistory.length - 2];
                performanceRound = previousValue !== 0 ? ((currentValue - previousValue) / Math.abs(previousValue)) * 100 : 0;
            }
            const performanceRoundElement = document.getElementById('performanceRoundStat');
            performanceRoundElement.textContent = formatPercentage(performanceRound);
            performanceRoundElement.style.color = performanceRound >= 0 ? 'var(--success-green)' : '#FF6347';
            
            // Performance - Total
            const initialCash = currentPlayer.initialCash || 1; // Avoid division by zero
            const performanceTotal = ((currentPlayer.totalValue - initialCash) / initialCash) * 100;
            const performanceTotalElement = document.getElementById('performanceTotalStat');
            performanceTotalElement.textContent = formatPercentage(performanceTotal);
            performanceTotalElement.style.color = performanceTotal >= 0 ? 'var(--success-green)' : '#FF6347';
        }

        function updateLoanDisplay() {
            const loanDisplay = document.getElementById('loanDisplay');
            const loanDetails = document.getElementById('loanDetails');
            
            if (!currentPlayer.loans || currentPlayer.loans.length === 0) {
                loanDisplay.classList.add('hidden');
                return;
            }
            
            loanDisplay.classList.remove('hidden');
            
            let totalDebt = 0;
            let loanHtml = '<div style="display: grid; gap: 1rem;">';
            
            currentPlayer.loans.forEach((loan, index) => {
                totalDebt += loan.totalOwed;
                loanHtml += `
                    <div style="background: rgba(255,255,255,0.05); border-left: 4px solid #6A0DAD; padding: 1rem; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--cream);">Darlehen #${index + 1}</span>
                            <span style="color: #FF6347; font-weight: 600;">${formatCurrency(loan.totalOwed)}</span>
                        </div>
                        <div style="color: var(--gold-light); font-size: 0.9rem;">
                            Aufgenommen: Runde ${loan.round} ‚Ä¢ 
                            Zinssatz: ${loan.interestRate.toFixed(2)}% ‚Ä¢ 
                            Urspr√ºnglich: ${formatCurrency(loan.principal)}
                        </div>
                    </div>
                `;
            });
            
            loanHtml += `
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(106,13,173,0.3);">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9370DB; font-weight: 600;">Gesamtschulden:</span>
                        <span style="color: #FF6347; font-weight: 700; font-size: 1.2rem;">${formatCurrency(totalDebt)}</span>
                    </div>
                </div>
            `;
            
            loanDetails.innerHTML = loanHtml;
            currentPlayer.totalDebt = totalDebt;
        }

        function generateLineChart() {
            const container = document.getElementById('lineChart');
            
            if (!currentPlayer.valueHistory || currentPlayer.valueHistory.length === 0) {
                container.innerHTML = '<p style="color: var(--gold-light); text-align: center;">Noch keine Daten verf√ºgbar</p>';
                return;
            }
            
            // Skip Round 0 in display - only show from Round 1 onwards
            const values = currentPlayer.valueHistory.length > 1 ? currentPlayer.valueHistory.slice(1) : [...currentPlayer.valueHistory];
            
            if (values.length === 0) {
                container.innerHTML = '<p style="color: var(--gold-light); text-align: center;">Noch keine Daten verf√ºgbar</p>';
                return;
            }
            
            const maxValue = Math.max(...values);
            const minValue = Math.min(0, ...values); // 0 as minimum unless negative values
            const range = maxValue - minValue;
            
            // Calculate average with 0 as minimum for display position
            const positiveValues = values.map(v => Math.max(0, v));
            const avgValue = (Math.max(...positiveValues) + 0) / 2; // Midpoint between 0 and max
            
            // Create SVG
            const width = container.clientWidth || 600;
            const height = 300;
            const padding = { top: 20, right: 20, bottom: 60, left: 100 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            // Helper function for short number format
            function formatShortCurrency(amount) {
                if (Math.abs(amount) >= 1000000) {
                    return `${(amount / 1000000).toFixed(1)}M`;
                } else if (Math.abs(amount) >= 10000) {
                    return `${(amount / 1000).toFixed(0)}k`;
                } else {
                    return amount.toFixed(0);
                }
            }
            
            const svg = `
                <svg viewBox="0 0 ${width} ${height}" style="width: 100%; height: 100%;">
                    <!-- Grid lines -->
                    <g stroke="rgba(212, 175, 55, 0.2)">
                        <!-- Vertical axis line -->
                        <line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${height - padding.bottom}"/>
                        <!-- Horizontal axis line -->
                        <line x1="${padding.left}" y1="${height - padding.bottom}" x2="${width - padding.right}" y2="${height - padding.bottom}"/>
                        
                        <!-- Horizontal grid lines -->
                        <line x1="${padding.left}" y1="${padding.top}" x2="${width - padding.right}" y2="${padding.top}" stroke-dasharray="3,3"/>
                        <line x1="${padding.left}" y1="${padding.top + chartHeight * 0.5}" 
                              x2="${width - padding.right}" y2="${padding.top + chartHeight * 0.5}" 
                              stroke-dasharray="3,3"/>
                    </g>
                    
                    <!-- Y-axis labels -->
                    <text x="${padding.left - 10}" y="${padding.top}" fill="var(--gold-light)" text-anchor="end" font-size="12">
                        CHF ${formatShortCurrency(maxValue)}
                    </text>
                    <text x="${padding.left - 10}" y="${padding.top + chartHeight * 0.5}" 
                          fill="var(--gold-light)" text-anchor="end" font-size="12">
                        CHF ${formatShortCurrency(avgValue)}
                    </text>
                    <text x="${padding.left - 10}" y="${height - padding.bottom}" fill="var(--gold-light)" text-anchor="end" font-size="12">
                        CHF ${formatShortCurrency(minValue)}
                    </text>
                    
                    <!-- Line path -->
                    <polyline
                        fill="none"
                        stroke="var(--gold-primary)"
                        stroke-width="3"
                        points="${values.map((value, index) => {
                            const x = padding.left + (index * chartWidth / Math.max(1, values.length - 1));
                            const y = padding.top + ((maxValue - value) / (range || 1)) * chartHeight;
                            return `${x},${y}`;
                        }).join(' ')}"
                    />
                    
                    <!-- Data points and labels -->
                    ${values.map((value, index) => {
                        const x = padding.left + (index * chartWidth / Math.max(1, values.length - 1));
                        const y = padding.top + ((maxValue - value) / (range || 1)) * chartHeight;
                        const roundNumber = index + 1; // Start from Round 1, not 0
                        return `
                            <circle cx="${x}" cy="${y}" r="5" fill="var(--gold-primary)"/>
                            <text x="${x}" y="${height - padding.bottom + 20}" fill="var(--gold-light)" text-anchor="middle" font-size="11">
                                R${roundNumber}
                            </text>
                            <text x="${x}" y="${height - padding.bottom + 35}" fill="var(--cream)" text-anchor="middle" font-size="10" font-weight="600">
                                ${formatShortCurrency(value)}
                            </text>
                        `;
                    }).join('')}
                </svg>
            `;
            
            container.innerHTML = svg;
        }

        function generatePortfolioAnalysis() {
            const container = document.getElementById('portfolioAnalysis');
            let totalPortfolioValue = 0;
            const holdings = [];
            
            STOCK_TITLES.forEach(stock => {
                const shares = currentPlayer.portfolio[stock] || 0;
                const price = currentGame.stockPrices[stock] || 0;
                const value = shares * price;
                totalPortfolioValue += value;
                
                if (shares > 0) {
                    const avgPrice = getAveragePurchasePrice(stock);
                    const profitPercent = avgPrice > 0 ? ((price - avgPrice) / avgPrice) * 100 : 0;
                    
                    holdings.push({
                        stock: stock,
                        shares: shares,
                        price: price,
                        avgPrice: avgPrice,
                        value: value,
                        profitPercent: profitPercent
                    });
                }
            });
            
            if (holdings.length === 0) {
                container.innerHTML = '<p style="color: var(--gold-light); text-align: center;">Keine Aktien im Portfolio</p>';
                return;
            }
            
            // Sort by value
            holdings.sort((a, b) => b.value - a.value);
            
            let html = '<div style="display: grid; gap: 1rem;">';
            
            holdings.forEach(holding => {
                const percentage = totalPortfolioValue > 0 ? 
                    (holding.value / totalPortfolioValue) * 100 : 0;
                const profitColor = holding.profitPercent >= 0 ? 'var(--success-green)' : '#FF6347';
                
                html += `
                    <div style="background: rgba(255,255,255,0.05); border-left: 4px solid var(--gold-primary); padding: 1rem; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: var(--gold-primary); font-weight: 600;">${getStockDisplayName(holding.stock)}</span>
                            <span style="color: var(--cream); font-weight: 600;">${formatCurrency(holding.value)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; color: var(--gold-light); font-size: 0.9rem;">
                            <span>${holding.shares} St√ºck @ ${formatCurrency(holding.avgPrice > 0 ? holding.avgPrice : holding.price)}</span>
                            <span>
                                ${formatCurrency(holding.price)} 
                                <span style="color: ${profitColor};">(${formatPercentage(holding.profitPercent)})</span>
                            </span>
                        </div>
                        <div class="performance-bar" style="margin-top: 0.5rem; position: relative;">
                            <div class="performance-fill" style="width: ${Math.min(100, percentage)}%; position: relative;"></div>
                            <span style="position: absolute; left: 85%; top: 50%; transform: translate(-50%, -50%); background: white; color: var(--navy); padding: 2px 8px; border-radius: 4px; font-weight: 600; font-size: 0.85rem; white-space: nowrap; z-index: 10;">
                                ${percentage.toFixed(1)}%
                            </span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function generateTopPerformers() {
            const container = document.getElementById('topPerformers');
            const performers = [];
            
            STOCK_TITLES.forEach(stock => {
                const realizedProfit = calculateRealizedProfit(stock);
                
                // Only include stocks with actual sales
                if (realizedProfit !== 0) {
                    performers.push({
                        stock: stock,
                        profit: realizedProfit,
                        percentReturn: 0 // Not calculating percentage for realized trades
                    });
                }
            });
            
            if (performers.length === 0) {
                container.innerHTML = '<p style="color: var(--gold-light); text-align: center;">Noch keine realisierten Gewinne/Verluste</p>';
                return;
            }
            
            // Sort by realized profit
            performers.sort((a, b) => b.profit - a.profit);
            
            let html = '<div style="display: grid; gap: 0.75rem;">';
            
            performers.forEach((performer, index) => {
                const icon = index === 0 && performer.profit > 0 ? 'ü•á' : 
                            index === 1 && performer.profit > 0 ? 'ü•à' : 
                            index === 2 && performer.profit > 0 ? 'ü•â' : '';
                const profitColor = performer.profit >= 0 ? 'var(--success-green)' : '#FF6347';
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <span style="color: var(--cream);">
                            ${icon} ${getStockDisplayName(performer.stock)}
                            ${index === 0 && performer.profit > 0 ? '<span class="top-performer">TOP</span>' : ''}
                        </span>
                        <div style="text-align: right;">
                            <span style="color: ${profitColor}; font-weight: 600;">
                                ${performer.profit >= 0 ? '+' : ''}${formatCurrency(performer.profit)}
                            </span>
                            <br>
                            <span style="color: var(--gold-light); font-size: 0.85rem;">
                                (Realisiert)
                            </span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function proceedToTrading() {
            showTradingSection();
        }

        // Trading System Functions
        function showTradingSection() {
            hideAllSections();
            document.getElementById('tradingSection').classList.remove('hidden');
            updateTradingInfo();
            generateTradingCards();
        }

        function showTradeConfirmation() {
            hideAllSections();
            document.getElementById('tradeConfirmSection').classList.remove('hidden');
            updateConfirmInfo();
        }

        function backToOrderBook() {
            showTradingSection();
        }

        function updateTradingInfo() {
            if (!currentGame || !currentPlayer) return;
            
            calculatePortfolioValue();
            
            const gameInfoHtml = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h3 style="color: var(--gold-primary); margin-bottom: 0.5rem;">
                        Inside Bankenplatz - Trading
                    </h3>
                    <p style="color: var(--gold-light);">
                        Runde ${currentGame.round} ‚Ä¢ 
                        Spieler: <strong>${currentPlayer.name}</strong> ‚Ä¢ 
                        Verf√ºgbare Liquidit√§t: <strong style="color: var(--gold-primary);">${formatCurrency(currentPlayer.cash)}</strong>
                    </p>
                </div>
            `;
            document.getElementById('gameInfoTrading').innerHTML = gameInfoHtml;
            
            document.getElementById('tradingRound').textContent = currentGame.round;
        }

        function updateConfirmInfo() {
            if (!currentGame || !currentPlayer) return;
            
            const gameInfoHtml = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h3 style="color: var(--gold-primary); margin-bottom: 0.5rem;">
                        Inside Bankenplatz - Best√§tigung
                    </h3>
                    <p style="color: var(--gold-light);">
                        Runde ${currentGame.round} ‚Ä¢ 
                        Spieler: <strong>${currentPlayer.name}</strong> ‚Ä¢ 
                        Aktuelle Liquidit√§t: <strong>${formatCurrency(currentPlayer.cash)}</strong>
                    </p>
                </div>
            `;
            document.getElementById('gameInfoConfirm').innerHTML = gameInfoHtml;
        }

        function generateTradingCards() {
            const tradingGrid = document.querySelector('.trading-grid');
            tradingGrid.innerHTML = '';
            
            STOCK_TITLES.forEach(stock => {
                const currentPrice = currentGame.stockPrices[stock];
                const currentHoldings = currentPlayer.portfolio[stock];
                const stockId = stock.replace(/[^a-zA-Z0-9]/g, '_');
                
                const tradingCard = document.createElement('div');
                tradingCard.className = 'trading-card';
                tradingCard.style.cssText = `
                    background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
                    border: 2px solid var(--gold-secondary);
                    border-radius: 12px;
                    padding: 1.5rem;
                    backdrop-filter: blur(10px);
                    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
                `;
                
                tradingCard.innerHTML = `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <h4 style="color: var(--gold-primary); margin-bottom: 0.5rem; font-family: 'Playfair Display', serif;">
                            ${getStockDisplayName(stock)}
                        </h4>
                        <div style="display: flex; justify-content: space-between; color: var(--gold-light); font-size: 0.9rem;">
                            <span>Preis: <strong>${formatCurrency(currentPrice)}</strong></span>
                            <span>Besitz: <strong>${currentHoldings} Stk.</strong></span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="trade-action">
                            <label style="color: var(--gold-light); font-weight: 600; margin-bottom: 0.5rem; display: block;">
                                üìà Kaufen
                            </label>
                            <div style="display: flex; gap: 0.25rem;">
                                <input type="number" 
                                       id="buy_${stockId}"
                                       class="form-control trade-input" 
                                       placeholder="Anzahl"
                                       min="0" 
                                       step="1"
                                       style="text-align: center; flex: 1;">
                                <button type="button" 
                                        class="btn" 
                                        onclick="setMaxBuy('${stock}')"
                                        style="padding: 8px 12px; font-size: 0.9rem; min-width: auto;">
                                    MAX
                                </button>
                            </div>
                        </div>
                        
                        <div class="trade-action">
                            <label style="color: var(--gold-light); font-weight: 600; margin-bottom: 0.5rem; display: block;">
                                üìâ Verkaufen
                            </label>
                            <div style="display: flex; gap: 0.25rem;">
                                <input type="number" 
                                       id="sell_${stockId}"
                                       class="form-control trade-input" 
                                       placeholder="Anzahl"
                                       min="0" 
                                       max="${currentHoldings}"
                                       step="1"
                                       style="text-align: center; flex: 1;">
                                <button type="button" 
                                        class="btn" 
                                        onclick="setMaxSell('${stock}')"
                                        style="padding: 8px 12px; font-size: 0.9rem; min-width: auto;">
                                    MAX
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="trade-preview" style="margin-top: 1rem; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 6px; text-align: center; color: var(--gold-light); font-size: 0.9rem;">
                        <span id="preview_${stockId}">Geben Sie Mengen ein f√ºr Kostenvorschau</span>
                    </div>
                `;
                
                tradingGrid.appendChild(tradingCard);
                
                // Add event listeners for real-time preview
                const buyInput = document.getElementById(`buy_${stockId}`);
                const sellInput = document.getElementById(`sell_${stockId}`);
                
                buyInput.addEventListener('input', () => updateTradePreview(stock));
                sellInput.addEventListener('input', () => updateTradePreview(stock));
                
                // Prevent buying and selling at the same time
                buyInput.addEventListener('input', () => {
                    if (buyInput.value > 0) {
                        sellInput.value = '';
                    }
                });
                
                sellInput.addEventListener('input', () => {
                    if (sellInput.value > 0) {
                        buyInput.value = '';
                    }
                });
            });
        }

        function setMaxBuy(stock) {
            const stockId = stock.replace(/[^a-zA-Z0-9]/g, '_');
            const price = currentGame.stockPrices[stock];
            const maxShares = Math.floor(currentPlayer.cash / price);
            
            const buyInput = document.getElementById(`buy_${stockId}`);
            const sellInput = document.getElementById(`sell_${stockId}`);
            
            buyInput.value = maxShares;
            sellInput.value = ''; // Clear sell input
            updateTradePreview(stock);
        }
        
        function setMaxSell(stock) {
            const stockId = stock.replace(/[^a-zA-Z0-9]/g, '_');
            const holdings = currentPlayer.portfolio[stock] || 0;
            
            const buyInput = document.getElementById(`buy_${stockId}`);
            const sellInput = document.getElementById(`sell_${stockId}`);
            
            sellInput.value = holdings;
            buyInput.value = ''; // Clear buy input
            updateTradePreview(stock);
        }

        function updateTradePreview(stock) {
            const stockId = stock.replace(/[^a-zA-Z0-9]/g, '_');
            const buyInput = document.getElementById(`buy_${stockId}`);
            const sellInput = document.getElementById(`sell_${stockId}`);
            const preview = document.getElementById(`preview_${stockId}`);
            
            const buyAmount = parseInt(buyInput.value) || 0;
            const sellAmount = parseInt(sellInput.value) || 0;
            const price = currentGame.stockPrices[stock];
            
            if (buyAmount > 0) {
                const cost = buyAmount * price;
                const affordable = cost <= currentPlayer.cash;
                preview.innerHTML = `
                    <span style="color: ${affordable ? 'var(--gold-primary)' : 'var(--accent-red)'};">
                        Kauf: ${buyAmount} √ó ${formatCurrency(price)} = ${formatCurrency(cost)}
                        ${affordable ? '‚úÖ' : '‚ùå Nicht genug Liquidit√§t!'}
                    </span>
                `;
            } else if (sellAmount > 0) {
                const revenue = sellAmount * price;
                preview.innerHTML = `
                    <span style="color: var(--gold-primary);">
                        Verkauf: ${sellAmount} √ó ${formatCurrency(price)} = ${formatCurrency(revenue)} ‚úÖ
                    </span>
                `;
            } else {
                preview.innerHTML = 'Geben Sie Mengen ein f√ºr Kostenvorschau';
            }
        }

        function reviewTrades(event) {
            event.preventDefault();
            
            // Collect all trades
            const trades = [];
            let totalCost = 0;
            let totalRevenue = 0;
            let hasInvalidTrades = false;
            
            // Use for loop instead of forEach to properly handle errors
            for (let i = 0; i < STOCK_TITLES.length; i++) {
                const stock = STOCK_TITLES[i];
                const stockId = stock.replace(/[^a-zA-Z0-9]/g, '_');
                const buyAmount = parseInt(document.getElementById(`buy_${stockId}`).value) || 0;
                const sellAmount = parseInt(document.getElementById(`sell_${stockId}`).value) || 0;
                const price = currentGame.stockPrices[stock];
                const currentHoldings = currentPlayer.portfolio[stock];
                
                // Validation
                if (buyAmount > 0 && sellAmount > 0) {
                    showAlert('tradingAlert', `Fehler bei ${getStockDisplayName(stock)}: Sie k√∂nnen nicht gleichzeitig kaufen und verkaufen.`, 'error');
                    hasInvalidTrades = true;
                    break;
                }
                
                if (sellAmount > currentHoldings) {
                    showAlert('tradingAlert', `Fehler bei ${getStockDisplayName(stock)}: Sie k√∂nnen nicht mehr verkaufen als Sie besitzen (${currentHoldings} Stk.).`, 'error');
                    hasInvalidTrades = true;
                    break;
                }
                
                if (buyAmount > 0) {
                    const cost = buyAmount * price;
                    totalCost += cost;
                    trades.push({
                        stock: stock,
                        action: 'buy',
                        amount: buyAmount,
                        price: price,
                        total: cost
                    });
                }
                
                if (sellAmount > 0) {
                    const revenue = sellAmount * price;
                    totalRevenue += revenue;
                    trades.push({
                        stock: stock,
                        action: 'sell',
                        amount: sellAmount,
                        price: price,
                        total: revenue
                    });
                }
            }
            
            if (hasInvalidTrades) return;
            
            // Check if player has enough cash
            if (totalCost > currentPlayer.cash) {
                showAlert('tradingAlert', `Nicht gen√ºgend Liquidit√§t! Ben√∂tigt: ${formatCurrency(totalCost)}, Verf√ºgbar: ${formatCurrency(currentPlayer.cash)}`, 'error');
                return;
            }
            
            // Allow no trades
            if (trades.length === 0) {
                showAlert('tradingAlert', 'Keine Trades eingegeben. Weiter zu speziellen Aktionen...', 'success');
                setTimeout(() => {
                    showSpecialActions();
                }, 1500);
                return;
            }
            
            // Store trades for confirmation
            currentPlayer.pendingTrades = trades;
            currentPlayer.pendingCost = totalCost;
            currentPlayer.pendingRevenue = totalRevenue;
            
            showTradeConfirmation();
            generateTradesSummary();
        }

        function generateTradesSummary() {
            const summaryContainer = document.getElementById('tradesSummary');
            const financialContainer = document.getElementById('financialImpact');
            
            if (!currentPlayer.pendingTrades || currentPlayer.pendingTrades.length === 0) {
                summaryContainer.innerHTML = '<p>Keine Trades zu best√§tigen.</p>';
                return;
            }
            
            // Generate trades summary
            let summaryHtml = '<div class="trades-list">';
            
            currentPlayer.pendingTrades.forEach(trade => {
                const actionIcon = trade.action === 'buy' ? 'üìà' : 'üìâ';
                const actionText = trade.action === 'buy' ? 'KAUF' : 'VERKAUF';
                const actionColor = trade.action === 'buy' ? 'var(--accent-red)' : 'var(--gold-primary)';
                const actionBg = trade.action === 'buy' ? 'rgba(255,255,255,0.9)' : 'transparent';
                const textColor = trade.action === 'buy' ? 'var(--navy)' : 'var(--gold-primary)';
                
                summaryHtml += `
                    <div style="background: rgba(255,255,255,0.05); border-left: 4px solid ${actionColor}; padding: 1rem; margin-bottom: 0.5rem; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--cream); font-weight: 600;">
                                ${actionIcon} ${actionText} ${getStockDisplayName(trade.stock)}
                            </span>
                            <span style="color: ${textColor}; font-weight: 600; background: ${actionBg}; padding: 2px 8px; border-radius: 4px;">
                                ${formatCurrency(trade.total)}
                            </span>
                        </div>
                        <div style="color: var(--gold-light); font-size: 0.9rem; margin-top: 0.25rem;">
                            ${trade.amount} St√ºck √ó ${formatCurrency(trade.price)}
                        </div>
                    </div>
                `;
            });
            
            summaryHtml += '</div>';
            summaryContainer.innerHTML = summaryHtml;
            
            // Generate financial impact
            const netCashFlow = currentPlayer.pendingRevenue - currentPlayer.pendingCost;
            const newCashBalance = currentPlayer.cash + netCashFlow;
            
            let portfolioChanges = '';
            const portfolioImpact = {};
            
            currentPlayer.pendingTrades.forEach(trade => {
                if (!portfolioImpact[trade.stock]) {
                    portfolioImpact[trade.stock] = 0;
                }
                
                if (trade.action === 'buy') {
                    portfolioImpact[trade.stock] += trade.amount;
                } else {
                    portfolioImpact[trade.stock] -= trade.amount;
                }
            });
            
            Object.keys(portfolioImpact).forEach(stock => {
                const change = portfolioImpact[stock];
                const currentHoldings = currentPlayer.portfolio[stock];
                const newHoldings = currentHoldings + change;
                const changeIcon = change > 0 ? 'üìà' : 'üìâ';
                const changeColor = change > 0 ? 'var(--gold-primary)' : 'var(--navy)';
                const changeBg = change > 0 ? 'transparent' : 'rgba(255,255,255,0.9)';
                
                portfolioChanges += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: var(--cream);">${getStockDisplayName(stock)}:</span>
                        <span style="color: ${changeColor}; background: ${changeBg}; padding: 2px 6px; border-radius: 4px; font-weight: 600;">
                            ${currentHoldings} ‚Üí ${newHoldings} Stk. ${changeIcon}
                        </span>
                    </div>
                `;
            });
            
            const financialHtml = `
                <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div>
                        <strong style="color: var(--gold-primary);">Liquidit√§t:</strong><br>
                        <span style="color: var(--cream);">Aktuell: ${formatCurrency(currentPlayer.cash)}</span><br>
                        <span style="color: ${netCashFlow >= 0 ? 'var(--gold-primary)' : 'var(--navy)'}; background: ${netCashFlow >= 0 ? 'transparent' : 'rgba(255,255,255,0.9)'}; padding: 2px 6px; border-radius: 4px; font-weight: 600;">
                            Nach Trades: ${formatCurrency(newCashBalance)}
                        </span>
                    </div>
                    <div>
                        <strong style="color: var(--gold-primary);">Cash Flow:</strong><br>
                        ${currentPlayer.pendingCost > 0 ? `<span style="color: var(--navy); background: rgba(255,255,255,0.9); padding: 2px 6px; border-radius: 4px; font-weight: 600;">Ausgaben: ${formatCurrency(currentPlayer.pendingCost)}</span><br>` : ''}
                        ${currentPlayer.pendingRevenue > 0 ? `<span style="color: var(--gold-primary); font-weight: 600;">Einnahmen: ${formatCurrency(currentPlayer.pendingRevenue)}</span><br>` : ''}
                        <span style="color: ${netCashFlow >= 0 ? 'var(--gold-primary)' : 'var(--navy)'}; background: ${netCashFlow >= 0 ? 'transparent' : 'rgba(255,255,255,0.9)'}; padding: 2px 6px; border-radius: 4px; font-weight: 600;">
                            Netto: ${formatCurrency(netCashFlow)}
                        </span>
                    </div>
                </div>
                ${portfolioChanges ? `<div style="margin-top: 1rem;"><strong style="color: var(--gold-primary);">Portfolio-√Ñnderungen:</strong><br><br>${portfolioChanges}</div>` : ''}
            `;
            
            financialContainer.innerHTML = financialHtml;
        }

        function executeTrades() {
            if (!currentPlayer.pendingTrades || currentPlayer.pendingTrades.length === 0) {
                showAlert('confirmAlert', 'Keine Trades zu ausf√ºhren.', 'error');
                return;
            }
            
            // Execute all trades
            currentPlayer.pendingTrades.forEach(trade => {
                const timestamp = new Date().toISOString();
                
                if (trade.action === 'buy') {
                    // Deduct cash
                    currentPlayer.cash -= trade.total;
                    // Add stocks to portfolio
                    currentPlayer.portfolio[trade.stock] += trade.amount;
                    
                    // Track purchase for average price calculation
                    if (!currentPlayer.purchaseHistory) {
                        currentPlayer.purchaseHistory = {};
                    }
                    if (!currentPlayer.purchaseHistory[trade.stock]) {
                        currentPlayer.purchaseHistory[trade.stock] = [];
                    }
                    currentPlayer.purchaseHistory[trade.stock].push({
                        amount: trade.amount,
                        price: trade.price,
                        round: currentGame.round
                    });
                    
                    // Record transaction
                    currentPlayer.transactions.push({
                        round: currentGame.round,
                        timestamp: timestamp,
                        type: 'buy',
                        stock: trade.stock,
                        amount: trade.amount,
                        price: trade.price,
                        total: trade.total
                    });
                    
                } else if (trade.action === 'sell') {
                    // Add cash
                    currentPlayer.cash += trade.total;
                    // Remove stocks from portfolio
                    currentPlayer.portfolio[trade.stock] -= trade.amount;
                    
                    // Update purchase history (FIFO)
                    if (currentPlayer.purchaseHistory && currentPlayer.purchaseHistory[trade.stock]) {
                        let toSell = trade.amount;
                        const newHistory = [];
                        
                        for (const purchase of currentPlayer.purchaseHistory[trade.stock]) {
                            if (toSell <= 0) {
                                newHistory.push(purchase);
                            } else if (purchase.amount > toSell) {
                                newHistory.push({
                                    ...purchase,
                                    amount: purchase.amount - toSell
                                });
                                toSell = 0;
                            } else {
                                toSell -= purchase.amount;
                            }
                        }
                        
                        currentPlayer.purchaseHistory[trade.stock] = newHistory;
                    }
                    
                    // Record transaction
                    currentPlayer.transactions.push({
                        round: currentGame.round,
                        timestamp: timestamp,
                        type: 'sell',
                        stock: trade.stock,
                        amount: trade.amount,
                        price: trade.price,
                        total: trade.total
                    });
                }
            });
            
            // Clear pending trades
            delete currentPlayer.pendingTrades;
            delete currentPlayer.pendingCost;
            delete currentPlayer.pendingRevenue;
            
            // Update portfolio value
            calculatePortfolioValue();
            
            // Save game state
            localStorage.setItem('currentGame', JSON.stringify(currentGame));
            localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
            
            showAlert('confirmAlert', '‚úÖ Alle Trades erfolgreich ausgef√ºhrt!', 'success');
            
            setTimeout(() => {
                showSpecialActions();
            }, 1500);
        }

        // Special Actions Functions
        function showSpecialActions() {
            hideAllSections();
            document.getElementById('specialActionsSection').classList.remove('hidden');
            updateSpecialInfo();
        }

        function showDividendInterface() {
            hideAllSections();
            document.getElementById('dividendSection').classList.remove('hidden');
            updateDividendInfo();
            generateDividendInputs();
        }

        function showBankruptcyInterface() {
            hideAllSections();
            document.getElementById('bankruptcySection').classList.remove('hidden');
            updateBankruptcyInfo();
            generateBankruptcyInputs();
        }

        function updateSpecialInfo() {
            if (!currentGame || !currentPlayer) return;
            
            calculatePortfolioValue();
            
            const gameInfoHtml = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h3 style="color: var(--gold-primary); margin-bottom: 0.5rem;">
                        Inside Bankenplatz - Spezielle Aktionen
                    </h3>
                    <p style="color: var(--gold-light);">
                        Runde ${currentGame.round} ‚Ä¢ 
                        Spieler: <strong>${currentPlayer.name}</strong> ‚Ä¢ 
                        Liquidit√§t: <strong>${formatCurrency(currentPlayer.cash)}</strong> ‚Ä¢ 
                        Gesamtverm√∂gen: <strong style="color: var(--gold-primary);">${formatCurrency(currentPlayer.totalValue)}</strong>
                    </p>
                </div>
            `;
            document.getElementById('gameInfoSpecial').innerHTML = gameInfoHtml;
        }

        function updateDividendInfo() {
            if (!currentGame || !currentPlayer) return;
            
            const gameInfoHtml = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h3 style="color: #00FF7F; margin-bottom: 0.5rem;">
                        Dividenden-Aussch√ºttung
                    </h3>
                    <p style="color: var(--gold-light);">
                        Runde ${currentGame.round} ‚Ä¢ 
                        Aktuelle Liquidit√§t: <strong>${formatCurrency(currentPlayer.cash)}</strong>
                    </p>
                </div>
            `;
            document.getElementById('gameInfoDividend').innerHTML = gameInfoHtml;
        }

        function updateBankruptcyInfo() {
            if (!currentGame || !currentPlayer) return;
            
            const gameInfoHtml = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h3 style="color: #FF6347; margin-bottom: 0.5rem;">
                        Konkurs-Abwicklung
                    </h3>
                    <p style="color: var(--gold-light);">
                        Runde ${currentGame.round} ‚Ä¢ 
                        Verf√ºgbare Liquidit√§t: <strong>${formatCurrency(currentPlayer.cash)}</strong>
                    </p>
                </div>
            `;
            document.getElementById('gameInfoBankruptcy').innerHTML = gameInfoHtml;
        }

        // Trader Functionality - Single trade with dropdown
        function activateTrader() {
            hideAllSections();
            
            // Create trader interface
            const traderHtml = `
                <section class="game-section">
                    <h2 class="section-title">üÉè Trader - Extra Trade</h2>
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <h3 style="color: var(--gold-primary); margin-bottom: 0.5rem;">
                            Spezial-Trade - Runde ${currentGame.round}
                        </h3>
                        <p style="color: var(--gold-light);">
                            W√§hlen Sie eine Aktie und f√ºhren Sie einen Extra-Trade aus
                        </p>
                        <p style="color: var(--cream); font-size: 1.1rem; margin-top: 1rem;">
                            Verf√ºgbare Liquidit√§t: <strong style="color: var(--gold-primary);">${formatCurrency(currentPlayer.cash)}</strong>
                        </p>
                    </div>
                    
                    <div id="traderAlert"></div>
                    
                    <form id="traderForm" onsubmit="executeTraderTrade(event)" style="max-width: 500px; margin: 0 auto;">
                        <div class="form-group">
                            <label for="traderStock">Aktie ausw√§hlen</label>
                            <select id="traderStock" class="form-control" required onchange="updateTraderPreview()">
                                <option value="">-- Aktie w√§hlen --</option>
                                ${STOCK_TITLES.map(stock => `
                                    <option value="${stock}">${getStockDisplayName(stock)} - ${formatCurrency(currentGame.stockPrices[stock])}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div id="traderStockInfo" style="background: rgba(255,255,255,0.05); border: 1px solid var(--gold-secondary); border-radius: 8px; padding: 1rem; margin: 1rem 0; display: none;">
                            <!-- Stock info will appear here -->
                        </div>
                        
                        <div class="form-group">
                            <label for="traderPrice">üí∞ Aktueller Preis (CHF)</label>
                            <input type="number" id="traderPrice" class="form-control" min="0" max="1000" step="10" placeholder="Preis" oninput="updateTraderPreview()">
                            <small style="color: var(--gold-light); margin-top: 0.25rem; display: block;">
                                Falls sich der Preis ge√§ndert hat, hier aktualisieren (0-1000 CHF in 10er-Schritten)
                            </small>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="traderBuy">üìà Kaufen (Anzahl)</label>
                                <input type="number" id="traderBuy" class="form-control" min="0" step="1" placeholder="0" oninput="updateTraderPreview()">
                            </div>
                            <div class="form-group">
                                <label for="traderSell">üìâ Verkaufen (Anzahl)</label>
                                <input type="number" id="traderSell" class="form-control" min="0" step="1" placeholder="0" oninput="updateTraderPreview()">
                            </div>
                        </div>
                        
                        <div id="traderPreview" style="background: rgba(255,215,0,0.1); border: 2px solid var(--gold-primary); border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                            <p style="color: var(--gold-light); text-align: center;">W√§hlen Sie eine Aktie und geben Sie die Menge ein</p>
                        </div>
                        
                        <div style="text-align: center; margin-top: 2rem;">
                            <button type="submit" class="btn" style="background: linear-gradient(145deg, var(--gold-primary), var(--gold-secondary)); margin-right: 1rem;">
                                üÉè Trade Ausf√ºhren
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('tempTraderSection').remove(); showSpecialActions()">
                                ‚Üê Zur√ºck
                            </button>
                        </div>
                    </form>
                </section>
            `;
            
            // Add trader section temporarily
            const container = document.querySelector('.container');
            const tempSection = document.createElement('div');
            tempSection.id = 'tempTraderSection';
            tempSection.innerHTML = traderHtml;
            container.appendChild(tempSection);
        }
        
        function updateTraderPreview() {
            const stock = document.getElementById('traderStock').value;
            const buyAmount = parseInt(document.getElementById('traderBuy').value) || 0;
            const sellAmount = parseInt(document.getElementById('traderSell').value) || 0;
            const customPrice = parseInt(document.getElementById('traderPrice').value) || 0;
            const infoDiv = document.getElementById('traderStockInfo');
            const previewDiv = document.getElementById('traderPreview');
            
            if (!stock) {
                infoDiv.style.display = 'none';
                previewDiv.innerHTML = '<p style="color: var(--gold-light); text-align: center;">W√§hlen Sie eine Aktie und geben Sie die Menge ein</p>';
                document.getElementById('traderPrice').value = '';
                return;
            }
            
            const originalPrice = currentGame.stockPrices[stock];
            const price = customPrice > 0 ? customPrice : originalPrice;
            const holdings = currentPlayer.portfolio[stock] || 0;
            
            // Set price input to original price if not already set
            if (!customPrice) {
                document.getElementById('traderPrice').value = originalPrice;
            }
            
            // Show stock info
            infoDiv.style.display = 'block';
            infoDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--gold-primary); font-weight: 600;">${getStockDisplayName(stock)}</span>
                    <span style="color: var(--cream);">
                        Besitz: <strong>${holdings} Stk.</strong> | 
                        Original-Preis: <strong>${formatCurrency(originalPrice)}</strong>
                        ${customPrice && customPrice !== originalPrice ? ` | <span style="color: #FFD700;">Neuer Preis: ${formatCurrency(customPrice)}</span>` : ''}
                    </span>
                </div>
            `;
            
            // Update sell limit
            document.getElementById('traderSell').max = holdings;
            
            // Update preview
            if (buyAmount > 0 && sellAmount > 0) {
                previewDiv.innerHTML = '<p style="color: #FF6347; text-align: center;">‚ö†Ô∏è Sie k√∂nnen nicht gleichzeitig kaufen und verkaufen!</p>';
            } else if (buyAmount > 0) {
                const cost = buyAmount * price;
                const canAfford = cost <= currentPlayer.cash;
                previewDiv.innerHTML = `
                    <div style="text-align: center;">
                        <h4 style="color: var(--gold-primary); margin-bottom: 0.5rem;">üìà Kauf-Trade</h4>
                        <p style="color: ${canAfford ? 'var(--cream)' : '#FF6347'};">
                            ${buyAmount} √ó ${formatCurrency(price)} = ${formatCurrency(cost)}
                            ${canAfford ? '‚úÖ' : '‚ùå Nicht genug Liquidit√§t!'}
                        </p>
                    </div>
                `;
            } else if (sellAmount > 0) {
                const revenue = sellAmount * price;
                previewDiv.innerHTML = `
                    <div style="text-align: center;">
                        <h4 style="color: var(--gold-primary); margin-bottom: 0.5rem;">üìâ Verkauf-Trade</h4>
                        <p style="color: var(--cream);">
                            ${sellAmount} √ó ${formatCurrency(price)} = ${formatCurrency(revenue)} ‚úÖ
                        </p>
                    </div>
                `;
            } else {
                previewDiv.innerHTML = '<p style="color: var(--gold-light); text-align: center;">Geben Sie eine Kauf- oder Verkaufsmenge ein</p>';
            }
        }
        
        function executeTraderTrade(event) {
            event.preventDefault();
            
            const stock = document.getElementById('traderStock').value;
            const buyAmount = parseInt(document.getElementById('traderBuy').value) || 0;
            const sellAmount = parseInt(document.getElementById('traderSell').value) || 0;
            const customPrice = parseInt(document.getElementById('traderPrice').value) || 0;
            
            if (!stock) {
                showAlert('traderAlert', 'Bitte w√§hlen Sie eine Aktie aus.', 'error');
                return;
            }
            
            if (buyAmount === 0 && sellAmount === 0) {
                showAlert('traderAlert', 'Bitte geben Sie eine Kauf- oder Verkaufsmenge ein.', 'error');
                return;
            }
            
            if (buyAmount > 0 && sellAmount > 0) {
                showAlert('traderAlert', 'Sie k√∂nnen nicht gleichzeitig kaufen und verkaufen.', 'error');
                return;
            }
            
            // Validate custom price
            if (customPrice && (customPrice < 0 || customPrice > 1000 || customPrice % 10 !== 0)) {
                showAlert('traderAlert', 'Der Preis muss zwischen 0-1000 CHF in 10er-Schritten liegen.', 'error');
                return;
            }
            
            const price = customPrice > 0 ? customPrice : currentGame.stockPrices[stock];
            const holdings = currentPlayer.portfolio[stock] || 0;
            
            if (buyAmount > 0) {
                const cost = buyAmount * price;
                if (cost > currentPlayer.cash) {
                    showAlert('traderAlert', 'Nicht gen√ºgend liquide Mittel f√ºr diesen Kauf.', 'error');
                    return;
                }
                
                // Execute buy
                currentPlayer.cash -= cost;
                currentPlayer.portfolio[stock] = (currentPlayer.portfolio[stock] || 0) + buyAmount;
                
                // Track purchase
                if (!currentPlayer.purchaseHistory[stock]) {
                    currentPlayer.purchaseHistory[stock] = [];
                }
                currentPlayer.purchaseHistory[stock].push({
                    amount: buyAmount,
                    price: price,
                    round: currentGame.round
                });
                
                showAlert('traderAlert', `üÉè Trader-Kauf erfolgreich! ${buyAmount} ${getStockDisplayName(stock)} f√ºr ${formatCurrency(cost)} gekauft (Preis: ${formatCurrency(price)}).`, 'success');
                
            } else if (sellAmount > 0) {
                if (sellAmount > holdings) {
                    showAlert('traderAlert', 'Sie k√∂nnen nicht mehr verkaufen als Sie besitzen.', 'error');
                    return;
                }
                
                const revenue = sellAmount * price;
                
                // Execute sell
                currentPlayer.cash += revenue;
                currentPlayer.portfolio[stock] -= sellAmount;
                
                // Update purchase history (FIFO)
                if (currentPlayer.purchaseHistory && currentPlayer.purchaseHistory[stock]) {
                    let toSell = sellAmount;
                    const newHistory = [];
                    
                    for (const purchase of currentPlayer.purchaseHistory[stock]) {
                        if (toSell <= 0) {
                            newHistory.push(purchase);
                        } else if (purchase.amount > toSell) {
                            newHistory.push({
                                ...purchase,
                                amount: purchase.amount - toSell
                            });
                            toSell = 0;
                        } else {
                            toSell -= purchase.amount;
                        }
                    }
                    
                    currentPlayer.purchaseHistory[stock] = newHistory;
                }
                
                showAlert('traderAlert', `üÉè Trader-Verkauf erfolgreich! ${sellAmount} ${getStockDisplayName(stock)} f√ºr ${formatCurrency(revenue)} verkauft (Preis: ${formatCurrency(price)}).`, 'success');
            }
            
            // Save game state
            calculatePortfolioValue();
            localStorage.setItem('currentGame', JSON.stringify(currentGame));
            localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
            
            // Clean up and return
            setTimeout(() => {
                const tempSection = document.getElementById('tempTraderSection');
                if (tempSection) {
                    tempSection.remove();
                }
                showSpecialActions();
            }, 2000);
        }

        // Dividend Functionality
        function generateDividendInputs() {
            const dividendGrid = document.querySelector('.dividend-grid');
            dividendGrid.innerHTML = '';
            
            STOCK_TITLES.forEach(stock => {
                const currentHoldings = currentPlayer.portfolio[stock];
                const stockId = stock.replace(/[^a-zA-Z0-9]/g, '_');
                
                const dividendCard = document.createElement('div');
                dividendCard.className = 'dividend-card';
                dividendCard.style.cssText = `
                    background: linear-gradient(145deg, rgba(0,255,127,0.1), rgba(0,255,127,0.05));
                    border: 2px solid #00FF7F;
                    border-radius: 12px;
                    padding: 1.5rem;
                    backdrop-filter: blur(10px);
                    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
                `;
                
                dividendCard.innerHTML = `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <h4 style="color: #00FF7F; margin-bottom: 0.5rem; font-family: 'Playfair Display', serif;">
                            ${getStockDisplayName(stock)}
                        </h4>
                        <div style="color: var(--gold-light); font-size: 0.9rem;">
                            Besitz: <strong>${currentHoldings} St√ºck</strong>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="dividend_${stockId}" style="color: #00FF7F; font-weight: 600; margin-bottom: 0.5rem; display: block;">
                            üí∞ Dividende pro Aktie (CHF)
                        </label>
                        <input type="number" 
                               id="dividend_${stockId}"
                               class="form-control dividend-input" 
                               placeholder="z.B. 5"
                               min="0" 
                               max="100" 
                               step="0.1"
                               style="text-align: center;">
                    </div>
                    
                    <div class="dividend-preview" style="padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 6px; text-align: center; color: var(--gold-light); font-size: 0.9rem;">
                        <span id="div_preview_${stockId}">
                            ${currentHoldings === 0 ? 'Keine Aktien im Besitz' : 'Dividende eingeben f√ºr Berechnung'}
                        </span>
                    </div>
                `;
                
                dividendGrid.appendChild(dividendCard);
                
                // Add event listener for real-time preview
                if (currentHoldings > 0) {
                    const dividendInput = document.getElementById(`dividend_${stockId}`);
                    dividendInput.addEventListener('input', () => updateDividendPreview(stock));
                }
            });
        }

        function updateDividendPreview(stock) {
            const stockId = stock.replace(/[^a-zA-Z0-9]/g, '_');
            const dividendInput = document.getElementById(`dividend_${stockId}`);
            const preview = document.getElementById(`div_preview_${stockId}`);
            
            const dividendPerShare = parseFloat(dividendInput.value) || 0;
            const holdings = currentPlayer.portfolio[stock];
            const totalDividend = dividendPerShare * holdings;
            
            if (dividendPerShare > 0) {
                preview.innerHTML = `
                    <span style="color: #00FF7F; font-weight: 600;">
                        üí∞ ${holdings} √ó ${formatCurrency(dividendPerShare)} = ${formatCurrency(totalDividend)}
                    </span>
                `;
            } else {
                preview.innerHTML = 'Dividende eingeben f√ºr Berechnung';
            }
        }

        function processDividends(event) {
            event.preventDefault();
            
            let totalDividends = 0;
            const dividendTransactions = [];
            
            STOCK_TITLES.forEach(stock => {
                const stockId = stock.replace(/[^a-zA-Z0-9]/g, '_');
                const dividendInput = document.getElementById(`dividend_${stockId}`);
                const dividendPerShare = parseFloat(dividendInput.value) || 0;
                const holdings = currentPlayer.portfolio[stock];
                
                if (dividendPerShare > 0 && holdings > 0) {
                    const stockDividend = dividendPerShare * holdings;
                    totalDividends += stockDividend;
                    
                    dividendTransactions.push({
                        stock: stock,
                        perShare: dividendPerShare,
                        holdings: holdings,
                        total: stockDividend,
                        timestamp: new Date().toISOString()
                    });
                }
            });
            
            if (totalDividends === 0) {
                showAlert('dividendAlert', 'Keine Dividenden eingegeben oder keine Aktien im Besitz.', 'error');
                return;
            }
            
            // Add dividends to cash
            currentPlayer.cash += totalDividends;
            
            // Record dividend transactions
            if (!currentPlayer.dividendHistory) {
                currentPlayer.dividendHistory = [];
            }
            
            dividendTransactions.forEach(div => {
                currentPlayer.dividendHistory.push({
                    round: currentGame.round,
                    stock: div.stock,
                    perShare: div.perShare,
                    holdings: div.holdings,
                    total: div.total,
                    timestamp: div.timestamp
                });
            });
            
            // Update portfolio value
            calculatePortfolioValue();
            
            // Save game state
            localStorage.setItem('currentGame', JSON.stringify(currentGame));
            localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
            
            showAlert('dividendAlert', `üí∞ Dividenden erfolgreich ausgesch√ºttet! Gesamtbetrag: ${formatCurrency(totalDividends)}`, 'success');
            
            setTimeout(() => {
                showSpecialActions();
            }, 2000);
        }

        // Bankruptcy Functionality
        function generateBankruptcyInputs() {
            const bankruptcyGrid = document.querySelector('.bankruptcy-grid');
            bankruptcyGrid.innerHTML = '';
            
            STOCK_TITLES.forEach(stock => {
                const currentHoldings = currentPlayer.portfolio[stock];
                const stockId = stock.replace(/[^a-zA-Z0-9]/g, '_');
                
                const bankruptcyCard = document.createElement('div');
                bankruptcyCard.className = 'bankruptcy-card';
                bankruptcyCard.style.cssText = `
                    background: linear-gradient(145deg, rgba(255,69,0,0.1), rgba(255,69,0,0.05));
                    border: 2px solid #FF4500;
                    border-radius: 12px;
                    padding: 1.5rem;
                    backdrop-filter: blur(10px);
                    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
                `;
                
                bankruptcyCard.innerHTML = `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <h4 style="color: #FF6347; margin-bottom: 0.5rem; font-family: 'Playfair Display', serif;">
                            ${getStockDisplayName(stock)}
                        </h4>
                        <div style="color: var(--gold-light); font-size: 0.9rem;">
                            Aktuelle Best√§nde: <strong>${currentHoldings} St√ºck</strong>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label for="rescue_amount_${stockId}" style="color: #FF6347; font-weight: 600; margin-bottom: 0.5rem; display: block; font-size: 0.9rem;">
                                üÜò Aktien retten
                            </label>
                            <input type="number" 
                                   id="rescue_amount_${stockId}"
                                   class="form-control bankruptcy-input" 
                                   placeholder="Anzahl"
                                   min="0" 
                                   max="${currentHoldings}"
                                   step="1"
                                   style="text-align: center;">
                        </div>
                        
                        <div class="form-group">
                            <label for="rescue_cost_${stockId}" style="color: #FF6347; font-weight: 600; margin-bottom: 0.5rem; display: block; font-size: 0.9rem;">
                                üí∏ Rettungskosten
                            </label>
                            <input type="number" 
                                   id="rescue_cost_${stockId}"
                                   class="form-control bankruptcy-input" 
                                   placeholder="CHF pro Stk."
                                   min="0" 
                                   max="1000"
                                   step="1"
                                   style="text-align: center;">
                        </div>
                    </div>
                    
                    <div class="bankruptcy-preview" style="padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 6px; text-align: center; color: var(--gold-light); font-size: 0.9rem;">
                        <span id="bankruptcy_preview_${stockId}">
                            ${currentHoldings === 0 ? 'Keine Aktien im Besitz' : '‚úÖ Kein Konkurs - Rettungskosten eingeben f√ºr Konkurs'}
                        </span>
                    </div>
                `;
                
                bankruptcyGrid.appendChild(bankruptcyCard);
                
                // Add event listeners for real-time preview
                if (currentHoldings > 0) {
                    const rescueAmountInput = document.getElementById(`rescue_amount_${stockId}`);
                    const rescueCostInput = document.getElementById(`rescue_cost_${stockId}`);
                    
                    rescueAmountInput.addEventListener('input', () => updateBankruptcyPreview(stock));
                    rescueCostInput.addEventListener('input', () => updateBankruptcyPreview(stock));
                }
            });
        }

        function updateBankruptcyPreview(stock) {
            const stockId = stock.replace(/[^a-zA-Z0-9]/g, '_');
            const rescueAmountInput = document.getElementById(`rescue_amount_${stockId}`);
            const rescueCostInput = document.getElementById(`rescue_cost_${stockId}`);
            const preview = document.getElementById(`bankruptcy_preview_${stockId}`);
            
            const rescueAmount = parseInt(rescueAmountInput.value) || 0;
            const rescueCostPerShare = parseFloat(rescueCostInput.value) || 0;
            const currentHoldings = currentPlayer.portfolio[stock];
            
            // Konkurs nur wenn BEIDE Felder ausgef√ºllt
            if (rescueCostPerShare > 0 && rescueAmount >= 0) {
                const lostStocks = currentHoldings - rescueAmount;
                const totalCost = rescueAmount * rescueCostPerShare;
                const affordable = totalCost <= currentPlayer.cash;
                const validAmount = rescueAmount <= currentHoldings;
                
                let previewHtml = `
                    <div style="color: ${affordable && validAmount ? '#00FF7F' : '#FF6347'};">
                        ‚ö†Ô∏è <strong>KONKURS AKTIV</strong><br>
                        üí∞ Kosten: ${formatCurrency(totalCost)} ${affordable ? '‚úÖ' : '‚ùå'}<br>
                        üÜò Gerettet: ${rescueAmount} Stk.<br>
                        üí• Verloren: ${lostStocks} Stk.
                    </div>
                `;
                preview.innerHTML = previewHtml;
            } else {
                preview.innerHTML = `
                    <div style="color: #00FF7F;">
                        ‚úÖ Kein Konkurs - Aktien bleiben erhalten<br>
                        <small>Beide Felder ausf√ºllen f√ºr Konkurs</small>
                    </div>
                `;
            }
        }

        function processBankruptcy(event) {
            event.preventDefault();
            
            let totalCost = 0;
            const bankruptcyTransactions = [];
            let hasValidTransactions = false;
            let hasError = false;
            
            // Use for loop for proper error handling
            for (let i = 0; i < STOCK_TITLES.length; i++) {
                const stock = STOCK_TITLES[i];
                const stockId = stock.replace(/[^a-zA-Z0-9]/g, '_');
                const rescueAmountInput = document.getElementById(`rescue_amount_${stockId}`);
                const rescueCostInput = document.getElementById(`rescue_cost_${stockId}`);
                
                const rescueAmount = parseInt(rescueAmountInput.value) || 0;
                const rescueCostPerShare = parseFloat(rescueCostInput.value) || 0;
                const currentHoldings = currentPlayer.portfolio[stock];
                
                // Konkurs findet NUR statt wenn BEIDE Felder ausgef√ºllt sind
                if (rescueCostPerShare > 0 && rescueAmount >= 0) {
                    // Konkurs findet statt f√ºr diese Aktie
                    if (rescueAmount > currentHoldings) {
                        showAlert('bankruptcyAlert', `Fehler bei ${getStockDisplayName(stock)}: Sie k√∂nnen nicht mehr Aktien retten als Sie besitzen (${currentHoldings} Stk.).`, 'error');
                        hasError = true;
                        break;
                    }
                    
                    const stockCost = rescueAmount * rescueCostPerShare;
                    const lostStocks = currentHoldings - rescueAmount;
                    
                    totalCost += stockCost;
                    bankruptcyTransactions.push({
                        stock: stock,
                        rescued: rescueAmount,
                        lost: lostStocks,
                        costPerShare: rescueCostPerShare,
                        totalCost: stockCost
                    });
                    hasValidTransactions = true;
                }
                // Wenn nichts eingegeben wurde ‚Üí kein Konkurs, Aktien bleiben erhalten
            }
            
            if (hasError) return;
            
            if (!hasValidTransactions) {
                showAlert('bankruptcyAlert', 'Keine Konkurs-Aktionen eingegeben. Geben Sie Rettungskosten ein, um einen Konkurs auszul√∂sen.', 'error');
                return;
            }
            
            if (totalCost > currentPlayer.cash) {
                showAlert('bankruptcyAlert', `Nicht gen√ºgend Liquidit√§t f√ºr Rettungsaktionen! Ben√∂tigt: ${formatCurrency(totalCost)}, Verf√ºgbar: ${formatCurrency(currentPlayer.cash)}`, 'error');
                return;
            }
            
            // Process bankruptcy transactions
            bankruptcyTransactions.forEach(transaction => {
                // Deduct rescue costs
                currentPlayer.cash -= transaction.totalCost;
                
                // Update portfolio (remove lost stocks, keep rescued ones)
                currentPlayer.portfolio[transaction.stock] = transaction.rescued;
                
                // Record bankruptcy transaction
                if (!currentPlayer.bankruptcyHistory) {
                    currentPlayer.bankruptcyHistory = [];
                }
                
                currentPlayer.bankruptcyHistory.push({
                    round: currentGame.round,
                    stock: transaction.stock,
                    rescued: transaction.rescued,
                    lost: transaction.lost,
                    costPerShare: transaction.costPerShare,
                    totalCost: transaction.totalCost,
                    timestamp: new Date().toISOString()
                });
            });
            
            // Update portfolio value
            calculatePortfolioValue();
            
            // Save game state
            localStorage.setItem('currentGame', JSON.stringify(currentGame));
            localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
            
            const summary = bankruptcyTransactions.map(t => 
                `${getStockDisplayName(t.stock)}: ${t.rescued} gerettet, ${t.lost} verloren`
            ).join('<br>');
            
            showAlert('bankruptcyAlert', `üí• Konkurs abgewickelt!<br>${summary}<br>Gesamtkosten: ${formatCurrency(totalCost)}`, 'success');
            
            setTimeout(() => {
                showSpecialActions();
            }, 3000);
        }

        // Penalty Functions
        function showPenaltyInterface() {
            hideAllSections();
            document.getElementById('penaltySection').classList.remove('hidden');
            updatePenaltyInfo();
            updatePenaltyPreview();
        }

        function updatePenaltyInfo() {
            if (!currentGame || !currentPlayer) return;
            
            calculatePortfolioValue();
            
            const gameInfoHtml = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h3 style="color: #FF6347; margin-bottom: 0.5rem;">
                        Strafzahlung - Runde ${currentGame.round}
                    </h3>
                    <p style="color: var(--gold-light);">
                        Spieler: <strong>${currentPlayer.name}</strong> ‚Ä¢ 
                        Liquidit√§t: <strong>${formatCurrency(currentPlayer.cash)}</strong> ‚Ä¢ 
                        Portfolio-Wert: <strong>${formatCurrency(currentPlayer.totalValue - currentPlayer.cash + (currentPlayer.totalDebt || 0))}</strong>
                    </p>
                </div>
            `;
            document.getElementById('gameInfoPenalty').innerHTML = gameInfoHtml;
        }

        function updatePenaltyPreview() {
            const percentageInput = document.getElementById('penaltyPercentage');
            const percentage = parseFloat(percentageInput.value) || 0;
            const portfolioValue = currentPlayer.totalValue - currentPlayer.cash + (currentPlayer.totalDebt || 0);
            const penaltyAmount = (portfolioValue * percentage) / 100;
            
            const previewContainer = document.getElementById('penaltyPreview');
            const liquidationContainer = document.getElementById('quickLiquidation');
            
            if (percentage === 0) {
                previewContainer.innerHTML = '<p style="color: var(--gold-light); text-align: center;">Geben Sie einen Prozentsatz ein f√ºr die Berechnung</p>';
                liquidationContainer.classList.add('hidden');
                return;
            }
            
            const canPayCash = penaltyAmount <= currentPlayer.cash;
            const needToSell = penaltyAmount - currentPlayer.cash;
            
            let html = `
                <h4 style="color: var(--gold-primary); margin-bottom: 1rem;">üí∞ Bussen-Details:</h4>
                <div style="display: grid; gap: 0.5rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Portfolio-Wert:</span>
                        <strong>${formatCurrency(portfolioValue)}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Busse (${percentage}%):</span>
                        <strong style="color: #FF6347;">${formatCurrency(penaltyAmount)}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Verf√ºgbare Liquidit√§t:</span>
                        <strong>${formatCurrency(currentPlayer.cash)}</strong>
                    </div>`;
            
            if (canPayCash) {
                html += `
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(0,255,127,0.1); border-radius: 8px;">
                        <span style="color: var(--success-green);">‚úÖ Busse kann vollst√§ndig aus liquiden Mitteln bezahlt werden</span>
                    </div>`;
                liquidationContainer.classList.add('hidden');
                document.getElementById('payPenaltyBtn').disabled = false;
            } else {
                html += `
                    <div style="display: flex; justify-content: space-between; color: #FF6347;">
                        <span>Fehlbetrag:</span>
                        <strong>${formatCurrency(needToSell)}</strong>
                    </div>
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,69,0,0.1); border-radius: 8px;">
                        <span style="color: #FF6347;">‚ö†Ô∏è Nicht gen√ºgend liquide Mittel! Verkaufen Sie Aktien unten.</span>
                    </div>`;
                liquidationContainer.classList.remove('hidden');
                generateQuickLiquidation();
                updatePenaltyButtonState();
            }
            
            html += '</div>';
            previewContainer.innerHTML = html;
        }

        function generateQuickLiquidation() {
            const gridContainer = document.getElementById('liquidationGrid');
            gridContainer.innerHTML = '';
            
            STOCK_TITLES.forEach(stock => {
                const holdings = currentPlayer.portfolio[stock] || 0;
                if (holdings === 0) return;
                
                const price = currentGame.stockPrices[stock];
                const stockId = stock.replace(/[^a-zA-Z0-9]/g, '_');
                
                const card = document.createElement('div');
                card.style.cssText = `
                    background: rgba(255,255,255,0.05);
                    border: 1px solid #FF4500;
                    border-radius: 8px;
                    padding: 1rem;
                `;
                
                card.innerHTML = `
                    <div style="margin-bottom: 0.75rem;">
                        <h5 style="color: #FF6347; margin-bottom: 0.25rem;">${getStockDisplayName(stock)}</h5>
                        <div style="color: var(--gold-light); font-size: 0.9rem;">
                            Besitz: ${holdings} @ ${formatCurrency(price)}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="number" 
                               id="quick_sell_${stockId}"
                               class="form-control" 
                               placeholder="Anzahl"
                               min="0" 
                               max="${holdings}"
                               step="1"
                               style="flex: 1; padding: 0.5rem;">
                        <button type="button" 
                                class="btn" 
                                onclick="quickSellStock('${stock}')"
                                style="background: linear-gradient(145deg, #FF4500, #CC3700); color: white; padding: 0.5rem 1rem;">
                            Verkaufen
                        </button>
                    </div>
                    <div id="quick_preview_${stockId}" style="margin-top: 0.5rem; color: var(--gold-light); font-size: 0.85rem; text-align: center;">
                        <!-- Preview will appear here -->
                    </div>
                `;
                
                gridContainer.appendChild(card);
                
                // Add input listener for preview
                const input = document.getElementById(`quick_sell_${stockId}`);
                input.addEventListener('input', () => {
                    const amount = parseInt(input.value) || 0;
                    const revenue = amount * price;
                    const preview = document.getElementById(`quick_preview_${stockId}`);
                    if (amount > 0) {
                        preview.innerHTML = `Erl√∂s: ${formatCurrency(revenue)}`;
                    } else {
                        preview.innerHTML = '';
                    }
                });
            });
        }

        function quickSellStock(stock) {
            const stockId = stock.replace(/[^a-zA-Z0-9]/g, '_');
            const input = document.getElementById(`quick_sell_${stockId}`);
            const amount = parseInt(input.value) || 0;
            
            if (amount <= 0) {
                showAlert('penaltyAlert', 'Bitte geben Sie eine g√ºltige Anzahl ein.', 'error');
                return;
            }
            
            if (amount > currentPlayer.portfolio[stock]) {
                showAlert('penaltyAlert', 'Sie k√∂nnen nicht mehr verkaufen als Sie besitzen.', 'error');
                return;
            }
            
            const price = currentGame.stockPrices[stock];
            const revenue = amount * price;
            
            // Execute sale immediately
            currentPlayer.cash += revenue;
            currentPlayer.portfolio[stock] -= amount;
            
            // Update purchase history (FIFO)
            if (currentPlayer.purchaseHistory && currentPlayer.purchaseHistory[stock]) {
                let toSell = amount;
                const newHistory = [];
                
                for (const purchase of currentPlayer.purchaseHistory[stock]) {
                    if (toSell <= 0) {
                        newHistory.push(purchase);
                    } else if (purchase.amount > toSell) {
                        newHistory.push({
                            ...purchase,
                            amount: purchase.amount - toSell
                        });
                        toSell = 0;
                    } else {
                        toSell -= purchase.amount;
                    }
                }
                
                currentPlayer.purchaseHistory[stock] = newHistory;
            }
            
            // Record transaction
            currentPlayer.transactions.push({
                round: currentGame.round,
                timestamp: new Date().toISOString(),
                type: 'quick_sell',
                stock: stock,
                amount: amount,
                price: price,
                total: revenue,
                reason: 'penalty_liquidation'
            });
            
            // Update portfolio value
            calculatePortfolioValue();
            
            // Save game state
            localStorage.setItem('currentGame', JSON.stringify(currentGame));
            localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
            
            // Clear input
            input.value = '';
            
            // Update preview
            updatePenaltyPreview();
            
            showAlert('penaltyAlert', `‚úÖ ${amount} ${getStockDisplayName(stock)} verkauft f√ºr ${formatCurrency(revenue)}`, 'success');
        }

        function updatePenaltyButtonState() {
            const percentage = parseFloat(document.getElementById('penaltyPercentage').value) || 0;
            const portfolioValue = currentPlayer.totalValue - currentPlayer.cash + (currentPlayer.totalDebt || 0);
            const penaltyAmount = (portfolioValue * percentage) / 100;
            const canPay = currentPlayer.cash >= penaltyAmount;
            
            document.getElementById('payPenaltyBtn').disabled = !canPay;
            if (!canPay) {
                document.getElementById('payPenaltyBtn').textContent = '‚ùå Nicht genug Liquidit√§t';
            } else {
                document.getElementById('payPenaltyBtn').textContent = 'üí∏ Busse Bezahlen';
            }
        }

        function processPenalty(event) {
            event.preventDefault();
            
            const percentage = parseFloat(document.getElementById('penaltyPercentage').value) || 0;
            
            if (percentage <= 0 || percentage > 70) {
                showAlert('penaltyAlert', 'Bitte geben Sie einen g√ºltigen Prozentsatz zwischen 0 und 70 ein.', 'error');
                return;
            }
            
            const portfolioValue = currentPlayer.totalValue - currentPlayer.cash + (currentPlayer.totalDebt || 0);
            const penaltyAmount = (portfolioValue * percentage) / 100;
            
            if (currentPlayer.cash < penaltyAmount) {
                showAlert('penaltyAlert', `Nicht gen√ºgend liquide Mittel! Verkaufen Sie zuerst Aktien im Bereich unten.`, 'error');
                return;
            }
            
            // Deduct penalty from cash AND from totalValue
            currentPlayer.cash -= penaltyAmount;
            
            // Record penalty
            if (!currentPlayer.penaltyHistory) {
                currentPlayer.penaltyHistory = [];
            }
            
            currentPlayer.penaltyHistory.push({
                round: currentGame.round,
                percentage: percentage,
                portfolioValue: portfolioValue,
                amount: penaltyAmount,
                timestamp: new Date().toISOString()
            });
            
            // Update portfolio value
            calculatePortfolioValue();
            
            // Save game state
            localStorage.setItem('currentGame', JSON.stringify(currentGame));
            localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
            
            showAlert('penaltyAlert', `üí∏ Busse von ${formatCurrency(penaltyAmount)} erfolgreich bezahlt!`, 'success');
            
            setTimeout(() => {
                showBusinessDashboard();
            }, 2000);
        }

        // Loan Functions
        function showLoanInterface() {
            hideAllSections();
            document.getElementById('loanSection').classList.remove('hidden');
            updateLoanInfo();
            calculateLoanTerms();
            showLoanTab('new');
            updateExistingLoansDisplay();
        }

        function showLoanTab(tab) {
            if (tab === 'new') {
                document.getElementById('loanForm').classList.remove('hidden');
                document.getElementById('repayForm').classList.add('hidden');
                document.getElementById('newLoanTab').style.background = 'linear-gradient(145deg, #4B0082, #6A0DAD)';
                document.getElementById('repayLoanTab').style.background = 'linear-gradient(145deg, var(--bronze), #A0522D)';
            } else {
                document.getElementById('loanForm').classList.add('hidden');
                document.getElementById('repayForm').classList.remove('hidden');
                document.getElementById('repayLoanTab').style.background = 'linear-gradient(145deg, #32CD32, #228B22)';
                document.getElementById('newLoanTab').style.background = 'linear-gradient(145deg, var(--bronze), #A0522D)';
                updateRepaymentInfo();
            }
        }

        function updateExistingLoansDisplay() {
            const container = document.getElementById('existingLoansDisplay');
            const listContainer = document.getElementById('existingLoansList');
            
            if (!currentPlayer.loans || currentPlayer.loans.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            let html = '<div style="display: grid; gap: 0.75rem;">';
            
            currentPlayer.loans.forEach((loan, index) => {
                html += `
                    <div style="background: rgba(255,255,255,0.05); border-left: 4px solid #DC143C; padding: 1rem; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--cream);">Darlehen #${index + 1}</span>
                            <span style="color: #FF6347; font-weight: 600;">${formatCurrency(loan.totalOwed)}</span>
                        </div>
                        <div style="color: var(--gold-light); font-size: 0.9rem;">
                            Runde ${loan.round} ‚Ä¢ Zinssatz: ${loan.interestRate.toFixed(2)}% ‚Ä¢ Ursprung: ${formatCurrency(loan.principal)}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            listContainer.innerHTML = html;
        }

        function updateRepaymentInfo() {
            document.getElementById('availableCashDisplay').textContent = formatCurrency(currentPlayer.cash);
            document.getElementById('totalDebtDisplay').textContent = formatCurrency(currentPlayer.totalDebt || 0);
            updateRepaymentPreview();
        }

        function updateRepaymentPreview() {
            const repayAmount = parseInt(document.getElementById('repayAmount').value) || 0;
            const previewContainer = document.getElementById('repaymentPreview');
            
            if (repayAmount === 0) {
                previewContainer.innerHTML = '<p style="color: var(--gold-light); text-align: center;">Geben Sie einen R√ºckzahlungsbetrag ein</p>';
                return;
            }
            
            if (repayAmount > currentPlayer.cash) {
                previewContainer.innerHTML = `
                    <p style="color: #FF6347; text-align: center;">
                        ‚ö†Ô∏è Nicht gen√ºgend liquide Mittel! Verf√ºgbar: ${formatCurrency(currentPlayer.cash)}
                    </p>
                `;
                return;
            }
            
            if (repayAmount > currentPlayer.totalDebt) {
                previewContainer.innerHTML = `
                    <p style="color: #FF6347; text-align: center;">
                        ‚ö†Ô∏è R√ºckzahlungsbetrag √ºbersteigt Gesamtschulden von ${formatCurrency(currentPlayer.totalDebt)}
                    </p>
                `;
                return;
            }
            
            const newDebt = currentPlayer.totalDebt - repayAmount;
            const newCash = currentPlayer.cash - repayAmount;
            
            let html = `
                <h4 style="color: #32CD32; margin-bottom: 1rem;">üìä R√ºckzahlungsdetails:</h4>
                <div style="display: grid; gap: 0.5rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>R√ºckzahlungsbetrag:</span>
                        <strong>${formatCurrency(repayAmount)}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Aktuelle Schulden:</span>
                        <strong style="color: #FF6347;">${formatCurrency(currentPlayer.totalDebt)}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid rgba(50,205,50,0.3);">
                        <span>Neue Schulden:</span>
                        <strong style="color: ${newDebt === 0 ? '#32CD32' : '#FF6347'};">${formatCurrency(newDebt)}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Neue Liquidit√§t:</span>
                        <strong>${formatCurrency(newCash)}</strong>
                    </div>
                </div>
            `;
            
            previewContainer.innerHTML = html;
        }

        function processRepayment(event) {
            event.preventDefault();
            
            const repayAmount = parseInt(document.getElementById('repayAmount').value) || 0;
            
            if (repayAmount <= 0 || repayAmount > currentPlayer.cash) {
                showAlert('loanAlert', 'Ung√ºltiger R√ºckzahlungsbetrag oder nicht gen√ºgend liquide Mittel.', 'error');
                return;
            }
            
            // Allow exact repayment of total debt
            if (repayAmount > currentPlayer.totalDebt) {
                showAlert('loanAlert', `R√ºckzahlungsbetrag kann nicht h√∂her als Gesamtschulden von ${formatCurrency(currentPlayer.totalDebt)} sein.`, 'error');
                return;
            }
            
            // Process repayment - pay off loans starting with highest interest rate
            let remainingPayment = repayAmount;
            currentPlayer.loans.sort((a, b) => b.interestRate - a.interestRate);
            
            const newLoans = [];
            for (const loan of currentPlayer.loans) {
                if (remainingPayment >= loan.totalOwed) {
                    remainingPayment -= loan.totalOwed;
                    // Loan fully paid off
                } else if (remainingPayment > 0) {
                    loan.totalOwed -= remainingPayment;
                    newLoans.push(loan);
                    remainingPayment = 0;
                } else {
                    newLoans.push(loan);
                }
            }
            
            currentPlayer.loans = newLoans;
            currentPlayer.cash -= repayAmount;
            currentPlayer.totalDebt -= repayAmount;
            
            // Update portfolio value
            calculatePortfolioValue();
            
            // Save game state
            localStorage.setItem('currentGame', JSON.stringify(currentGame));
            localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
            
            showAlert('loanAlert', `üí≥ R√ºckzahlung von ${formatCurrency(repayAmount)} erfolgreich! Verbleibende Schulden: ${formatCurrency(currentPlayer.totalDebt)}`, 'success');
            
            setTimeout(() => {
                showBusinessDashboard();
            }, 2000);
        }

        function updateLoanInfo() {
            if (!currentGame || !currentPlayer) return;
            
            calculatePortfolioValue();
            
            const gameInfoHtml = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h3 style="color: #9370DB; margin-bottom: 0.5rem;">
                        CSBS Darlehensabteilung
                    </h3>
                    <p style="color: var(--gold-light);">
                        Runde ${currentGame.round} ‚Ä¢ 
                        Spieler: <strong>${currentPlayer.name}</strong> ‚Ä¢ 
                        Bonit√§t basierend auf Verm√∂gen und Performance
                    </p>
                </div>
            `;
            document.getElementById('gameInfoLoan').innerHTML = gameInfoHtml;
        }

        function calculateLoanTerms() {
            calculatePortfolioValue();
            
            // Calculate interest rate
            const performance = currentPlayer.initialCash !== 0 ? 
                ((currentPlayer.totalValue - currentPlayer.initialCash) / currentPlayer.initialCash) * 100 : 0;
            
            // Base rate = 7.5%
            let interestRate = 7.5;
            
            // Adjust for wealth: -(Verm√∂gen - 100'000)/200'000
            const wealthAdjustment = -(currentPlayer.totalValue - 100000) / 200000;
            interestRate += wealthAdjustment;
            
            // Adjust for performance: -Performance/10
            const performanceAdjustment = -performance / 10;
            interestRate += performanceAdjustment;
            
            // Risk premium based on current debt
            const debtRatio = currentPlayer.totalDebt && currentPlayer.totalValue > 0 ? 
                currentPlayer.totalDebt / Math.abs(currentPlayer.totalValue) : 0;
            const riskPremium = Math.min(debtRatio * 5, 5); // Cap at 5% max risk premium
            interestRate += riskPremium;
            
            // Apply bounds
            interestRate = Math.max(0.3, Math.min(13, interestRate));
            
            // Calculate max loan - ensure positive value
            const baseMaxLoan = Math.max(100000, Math.abs(currentPlayer.totalValue) * 4);
            const maxLoan = Math.round(baseMaxLoan / 10000) * 10000; // Round to nearest 10,000
            
            // Update display
            document.getElementById('interestRateDisplay').textContent = `${interestRate.toFixed(2)}%`;
            document.getElementById('maxLoanDisplay').textContent = formatCurrency(maxLoan);
            
            // Store for later use
            currentPlayer.loanTerms = {
                interestRate: interestRate,
                maxLoan: maxLoan,
                minLoan: 10000
            };
            
            // Set max attribute on input
            const loanAmountInput = document.getElementById('loanAmount');
            loanAmountInput.max = maxLoan;
            
            updateLoanPreview();
        }

        function updateLoanPreview() {
            const loanAmount = parseInt(document.getElementById('loanAmount').value) || 0;
            const previewContainer = document.getElementById('loanPreview');
            
            if (!currentPlayer.loanTerms) {
                calculateLoanTerms();
            }
            
            if (loanAmount === 0) {
                previewContainer.innerHTML = '<p style="color: var(--gold-light); text-align: center;">Geben Sie einen Darlehensbetrag ein</p>';
                return;
            }
            
            const { interestRate, maxLoan, minLoan } = currentPlayer.loanTerms;
            
            if (loanAmount < minLoan || loanAmount > maxLoan) {
                previewContainer.innerHTML = `
                    <p style="color: #FF6347; text-align: center;">
                        ‚ö†Ô∏è Darlehensbetrag muss zwischen ${formatCurrency(minLoan)} und ${formatCurrency(maxLoan)} liegen
                    </p>
                `;
                return;
            }
            
            const interestPerRound = loanAmount * (interestRate / 100);
            const totalAfterOneRound = loanAmount + interestPerRound;
            
            let html = `
                <h4 style="color: #9370DB; margin-bottom: 1rem;">üìä Darlehenskonditionen:</h4>
                <div style="display: grid; gap: 0.5rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Darlehensbetrag:</span>
                        <strong>${formatCurrency(loanAmount)}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Zinssatz pro Runde:</span>
                        <strong style="color: #9370DB;">${interestRate.toFixed(2)}%</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Zinsen pro Runde:</span>
                        <strong style="color: #FF6347;">${formatCurrency(interestPerRound)}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid rgba(106,13,173,0.3);">
                        <span>Schuld nach 1 Runde:</span>
                        <strong style="color: #FF6347;">${formatCurrency(totalAfterOneRound)}</strong>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(106,13,173,0.1); border-radius: 8px;">
                    <p style="color: var(--gold-light); font-size: 0.9rem; margin: 0;">
                        ‚ö†Ô∏è <strong>Wichtig:</strong> Zinsen werden automatisch bei jeder Preis√§nderung berechnet und zu Ihrer Schuld addiert.
                    </p>
                </div>
            `;
            
            previewContainer.innerHTML = html;
        }

        function processLoan(event) {
            event.preventDefault();
            
            const loanAmount = parseInt(document.getElementById('loanAmount').value) || 0;
            
            if (!currentPlayer.loanTerms) {
                calculateLoanTerms();
            }
            
            const { interestRate, maxLoan, minLoan } = currentPlayer.loanTerms;
            
            if (loanAmount < minLoan || loanAmount > maxLoan) {
                showAlert('loanAlert', `Darlehensbetrag muss zwischen ${formatCurrency(minLoan)} und ${formatCurrency(maxLoan)} liegen.`, 'error');
                return;
            }
            
            // Add loan to player
            if (!currentPlayer.loans) {
                currentPlayer.loans = [];
            }
            
            currentPlayer.loans.push({
                round: currentGame.round,
                principal: loanAmount,
                interestRate: interestRate,
                totalOwed: loanAmount,
                timestamp: new Date().toISOString()
            });
            
            // Add cash
            currentPlayer.cash += loanAmount;
            
            // Update total debt
            currentPlayer.totalDebt = (currentPlayer.totalDebt || 0) + loanAmount;
            
            // Update portfolio value
            calculatePortfolioValue();
            
            // Save game state
            localStorage.setItem('currentGame', JSON.stringify(currentGame));
            localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
            
            showAlert('loanAlert', `üè¶ Darlehen von ${formatCurrency(loanAmount)} erfolgreich aufgenommen! Zinssatz: ${interestRate.toFixed(2)}% pro Runde.`, 'success');
            
            setTimeout(() => {
                showBusinessDashboard();
            }, 2000);
        }

        // Continue to Next Round
        function continueToNextRound() {
            // Set flag to increment round on next price update
            needsRoundIncrement = true;
            
            // Save game state
            localStorage.setItem('currentGame', JSON.stringify(currentGame));
            localStorage.setItem('currentPlayer', JSON.stringify(currentPlayer));
            
            showAlert('specialAlert', `‚û°Ô∏è Runde ${currentGame.round} abgeschlossen! Zur n√§chsten Runde...`, 'success');
            
            setTimeout(() => {
                // Go back to stock price management for the new round
                showGameDashboard();
            }, 2000);
        }

        // Trader Tip-Off Function
        function showTraderTipOff() {
            if (!currentPlayer.pendingTrades || currentPlayer.pendingTrades.length === 0) {
                alert('Keine Trades verf√ºgbar f√ºr Tip-Off!');
                return;
            }
            
            // Select random trade
            const randomIndex = Math.floor(Math.random() * currentPlayer.pendingTrades.length);
            const randomTrade = currentPlayer.pendingTrades[randomIndex];
            
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(145deg, var(--navy), var(--dark-blue));
                border: 3px solid var(--gold-primary);
                border-radius: 15px;
                padding: 2rem;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 0 50px rgba(212, 175, 55, 0.5);
            `;
            
            const actionText = randomTrade.action === 'buy' ? 'KAUFT' : 'VERKAUFT';
            const actionColor = randomTrade.action === 'buy' ? '#00FF7F' : '#FF6347';
            const actionIcon = randomTrade.action === 'buy' ? 'üìà' : 'üìâ';
            
            modalContent.innerHTML = `
                <div style="text-align: center;">
                    <h2 style="color: var(--gold-primary); font-family: 'Playfair Display', serif; margin-bottom: 1.5rem;">
                        üïµÔ∏è TRADER TIP-OFF üïµÔ∏è
                    </h2>
                    <div style="background: rgba(255,215,0,0.1); border: 2px solid var(--gold-primary); border-radius: 10px; padding: 2rem; margin-bottom: 1.5rem;">
                        <p style="color: var(--gold-light); font-size: 1.1rem; margin-bottom: 1rem;">
                            <em>"Psst... Ich habe geh√∂rt, dass jemand einen interessanten Trade plant..."</em>
                        </p>
                        <div style="background: rgba(0,0,0,0.5); border-radius: 8px; padding: 1.5rem; margin-top: 1rem;">
                            <p style="font-size: 1.3rem; color: var(--cream); margin-bottom: 1rem;">
                                <strong>${currentPlayer.name}</strong> ${actionIcon} <strong style="color: ${actionColor};">${actionText}</strong>
                            </p>
                            <p style="font-size: 1.8rem; color: var(--gold-primary); font-weight: bold; margin-bottom: 0.5rem;">
                                ${randomTrade.amount} √ó ${getStockDisplayName(randomTrade.stock)}
                            </p>
                            <p style="font-size: 1.2rem; color: var(--gold-light);">
                                zu je ${formatCurrency(randomTrade.price)}
                            </p>
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gold-secondary);">
                                <p style="font-size: 1.4rem; color: ${actionColor}; font-weight: bold;">
                                    Gesamtwert: ${formatCurrency(randomTrade.total)}
                                </p>
                            </div>
                        </div>
                    </div>
                    <p style="color: var(--gold-light); font-size: 0.9rem; margin-bottom: 1.5rem;">
                        üí° <em>Nutzen Sie diese Information weise...</em>
                    </p>
                    <button class="btn" onclick="this.closest('div').parentElement.remove()" style="min-width: 200px;">
                        ü§ê Verstanden
                    </button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>

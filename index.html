<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inside Bankenplatz â€“ Marktmanipulations-Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Source+Sans+Pro:wght@300;400;600&display=swap');

        /* â”€â”€â”€ Design Tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        :root {
            --gold:        #D4AF37;
            --gold-dim:    #B8860B;
            --gold-light:  #F7E7CE;
            --bronze:      #CD7F32;
            --navy:        #0f1419;
            --dark-blue:   #1a237e;
            --cream:       #FFF8DC;
            --red:         #8B0000;
            --green:       #00FF7F;
            --purple:      #6A0DAD;
            --purple-light:#9370DB;
            --danger:      #DC143C;
            --orange:      #FF4500;
        }

        /* â”€â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Source Sans Pro', sans-serif;
            background: linear-gradient(135deg, var(--navy) 0%, var(--dark-blue) 50%, var(--navy) 100%);
            min-height: 100vh;
            color: var(--cream);
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed; inset: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(212,175,55,.10) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(212,175,55,.10) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* â”€â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        .hidden { display: none !important; }

        /* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .header { text-align: center; margin-bottom: 3rem; }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2.2rem, 5vw, 3.5rem);
            font-weight: 900;
            background: linear-gradient(45deg, var(--gold), var(--gold-light), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 3px;
        }

        .header .subtitle {
            font-style: italic;
            color: var(--gold-light);
            font-size: 1.2rem;
            letter-spacing: 2px;
        }

        .deco-line {
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
            margin: 2rem auto;
            width: 200px;
            position: relative;
        }
        .deco-line::before, .deco-line::after {
            content: 'â—Š';
            position: absolute;
            top: -8px;
            color: var(--gold);
            font-size: 1.2rem;
        }
        .deco-line::before { left: -20px; }
        .deco-line::after  { right: -20px; }

        /* â”€â”€â”€ Cards & Sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .game-section {
            background: linear-gradient(145deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
            border: 2px solid var(--gold);
            border-radius: 15px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.10);
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: var(--gold);
            text-align: center;
            margin-bottom: 2rem;
            letter-spacing: 1px;
        }

        /* â”€â”€â”€ Forms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .form-group { margin-bottom: 1.5rem; }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--gold-light);
            margin-bottom: .5rem;
            font-size: 1.1rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255,255,255,.10);
            border: 2px solid var(--gold-dim);
            border-radius: 8px;
            color: var(--cream);
            font-size: 1rem;
            transition: border-color .3s, box-shadow .3s, background .3s;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212,175,55,.20);
            background: rgba(255,255,255,.15);
        }
        .form-control::placeholder { color: rgba(255,248,220,.6); }

        select.form-control option { background: var(--navy); color: var(--cream); }

        /* â”€â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn {
            background: linear-gradient(145deg, var(--gold), var(--gold-dim));
            color: var(--navy);
            border: none;
            padding: 14px 28px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: transform .25s, box-shadow .25s;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,.4), transparent);
            transition: left .5s;
        }
        .btn:hover::before { left: 100%; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,175,55,.4); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }

        .btn-block { width: 100%; }

        .btn-secondary  { background: linear-gradient(145deg, var(--bronze), #A0522D); color: #fff; }
        .btn-danger     { background: linear-gradient(145deg, var(--danger), var(--red)); color: #fff; }
        .btn-loan       { background: linear-gradient(145deg, #4B0082, var(--purple)); color: #fff; }
        .btn-green      { background: linear-gradient(145deg, #32CD32, #228B22); color: #fff; }
        .btn-orange     { background: linear-gradient(145deg, var(--orange), #CC3700); color: #fff; }

        /* â”€â”€â”€ Stat Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(145deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
            border: 1px solid var(--gold-dim);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: transform .3s, box-shadow .3s;
        }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(212,175,55,.3); }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: .5rem;
            font-family: 'Playfair Display', serif;
        }
        .stat-label { color: var(--gold-light); font-size: .9rem; text-transform: uppercase; letter-spacing: 1px; }
        .stat-change { margin-top: .5rem; font-size: 1rem; font-weight: 600; }

        .positive { color: var(--green); }
        .negative { color: #FF6347; }

        /* â”€â”€â”€ Alerts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid;
            animation: fadeIn .3s ease;
        }
        @keyframes fadeIn { from { opacity:0; transform:translateY(-4px); } to { opacity:1; transform:none; } }

        .alert-error   { background: rgba(139,0,0,.2);     border-color: var(--red);     color: #FFB6C1; }
        .alert-success { background: rgba(0,128,0,.2);     border-color: #00FF00;        color: #90EE90; }
        .alert-info    { background: rgba(0,123,255,.2);   border-color: #007BFF;        color: #87CEEB; }

        /* â”€â”€â”€ Performance Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .performance-bar {
            background: rgba(0,0,0,.3);
            border-radius: 8px;
            height: 36px;
            position: relative;
            overflow: hidden;
            margin-top: 1rem;
        }
        .performance-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold-dim), var(--gold));
            transition: width 1s ease;
            min-width: 0;
        }
        /* Label always centered in the bar (or overlaid when bar is short) */
        .performance-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--navy);
            background: rgba(255,255,255,.85);
            padding: 1px 8px;
            border-radius: 4px;
            font-weight: 700;
            font-size: .85rem;
            white-space: nowrap;
            z-index: 2;
        }

        /* â”€â”€â”€ Chart Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chart-container {
            background: rgba(0,0,0,.3);
            border: 1px solid var(--gold-dim);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            min-height: 280px;
        }

        /* â”€â”€â”€ Modal Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn .2s ease;
        }
        .modal-box {
            background: linear-gradient(145deg, var(--navy), var(--dark-blue));
            border: 3px solid var(--gold);
            border-radius: 15px;
            padding: 2rem;
            max-width: 520px;
            width: 90%;
            box-shadow: 0 0 60px rgba(212,175,55,.5);
        }

        /* â”€â”€â”€ Top Performer Badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .badge-top {
            background: linear-gradient(45deg, var(--gold), var(--gold-light));
            color: var(--navy);
            padding: .2rem .75rem;
            border-radius: 20px;
            font-size: .8rem;
            font-weight: 600;
            margin-left: .5rem;
        }

        /* â”€â”€â”€ Interest Rate Display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .interest-rate-display {
            background: linear-gradient(145deg, rgba(75,0,130,.2), rgba(106,13,173,.1));
            border: 2px solid var(--purple);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: center;
        }
        .interest-rate-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--purple-light);
            font-family: 'Playfair Display', serif;
        }

        /* â”€â”€â”€ Section Info Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .info-bar {
            text-align: center;
            margin-bottom: 2rem;
        }
        .info-bar h3 { color: var(--gold); margin-bottom: .5rem; }
        .info-bar p  { color: var(--gold-light); }

        /* â”€â”€â”€ Divider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .section-divider {
            border: none;
            border-top: 1px solid rgba(212,175,55,.3);
            margin: 2rem 0;
        }

        /* â”€â”€â”€ Utility Flex Rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn-row {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 2rem;
        }
        .btn-row .btn { min-width: 180px; }

        /* â”€â”€â”€ Special Action Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .special-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .special-card {
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: transform .3s, box-shadow .3s;
            cursor: pointer;
        }
        .special-card:hover { transform: translateY(-6px); box-shadow: 0 8px 32px rgba(212,175,55,.4); }
        .special-card .icon { font-size: 3rem; margin-bottom: .5rem; }
        .special-card h3  { font-family: 'Playfair Display', serif; margin-bottom: .5rem; }
        .special-card p   { font-size: .9rem; color: var(--gold-light); }

        /* â”€â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 640px) {
            .container   { padding: 1rem; }
            .game-section { padding: 1.5rem; }
            .stats-grid  { grid-template-columns: 1fr; }
            .btn-row     { flex-direction: column; }
            .btn-row .btn { min-width: unset; width: 100%; }
        }

        /* Trading cards: stack buy/sell on narrow phones */
        @media (max-width: 400px) {
            .trade-cols { grid-template-columns: 1fr !important; }
        }

        /* â”€â”€â”€ Accessibility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sr-only {
            position: absolute; width: 1px; height: 1px;
            padding: 0; margin: -1px; overflow: hidden;
            clip: rect(0,0,0,0); white-space: nowrap; border: 0;
        }
        *:focus-visible { outline: 3px solid var(--gold); outline-offset: 2px; }
    </style>
</head>
<body>
<div class="container">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <header class="header">
        <h1>Inside Bankenplatz</h1>
        <p class="subtitle">Marktmanipulations-Edition</p>
        <div class="deco-line"></div>
    </header>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN MENU â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="mainMenu" class="game-section">
        <h2 class="section-title">Willkommen im Zentrum der Finanzwelt</h2>
        <div style="text-align:center;">
            <button class="btn" onclick="startNewGame()" style="max-width:400px;">
                Neues Spiel Starten
            </button>
        </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• PLAYER SETUP â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="playerSetupSection" class="game-section hidden">
        <h2 class="section-title">Spieler-Einrichtung</h2>
        <div id="setupAlert"></div>
        <form onsubmit="setupPlayer(event)" novalidate>
            <div class="form-group">
                <label for="playerName">Spielername</label>
                <input type="text" id="playerName" class="form-control"
                       placeholder="z.B. Gordon Gekko" required maxlength="30">
            </div>
            <div class="form-group">
                <label for="startingCash">Startkapital (CHF)</label>
                <input type="number" id="startingCash" class="form-control"
                       placeholder="z.B. 10000" required min="1000" max="1000000" step="100">
                <small style="color:var(--gold-light);display:block;margin-top:.25rem;">
                    1'000 â€“ 1'000'000 CHF
                </small>
            </div>
            <div class="btn-row">
                <button type="submit" class="btn">Spiel Starten</button>
                <button type="button" class="btn btn-secondary" onclick="showMainMenu()">â† ZurÃ¼ck</button>
            </div>
        </form>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• PRICE MANAGEMENT â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="gameDashboard" class="game-section hidden">
        <h2 class="section-title">Aktienpreis-Management</h2>
        <div id="gameInfo"></div>
        <div id="stockPriceAlert"></div>
        <form id="stockPriceForm" onsubmit="updateStockPrices(event)" novalidate>
            <h3 style="color:var(--gold);text-align:center;margin-bottom:1.5rem;">
                Aktuelle Preise â€“ Runde <span id="currentRound">0</span>
            </h3>
            <div id="stockGrid" style="display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));"></div>
            <div class="btn-row">
                <button type="submit" class="btn">Preise Aktualisieren â†’ Dashboard</button>
            </div>
        </form>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• BUSINESS DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="businessDashboard" class="game-section hidden">
        <h2 class="section-title">ğŸ“Š Business Dashboard</h2>
        <div id="dashboardInfo"></div>
        <div id="dashboardAlert"></div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalValueStat">â€“</div>
                <div class="stat-label">GesamtvermÃ¶gen</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="liquidityStat">â€“</div>
                <div class="stat-label">LiquiditÃ¤t</div>
                <div class="stat-change" id="liquidityRatio">â€“</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="portfolioValueStat">â€“</div>
                <div class="stat-label">Portfolio-Wert</div>
            </div>
            <div class="stat-card">
                <div style="display:flex;justify-content:space-around;align-items:center;">
                    <div style="text-align:center;">
                        <div class="stat-value" id="perfRoundStat" style="font-size:1.4rem;">â€“</div>
                        <div class="stat-label" style="font-size:.75rem;">Letzte Runde</div>
                    </div>
                    <div style="width:1px;height:50px;background:var(--gold-dim);"></div>
                    <div style="text-align:center;">
                        <div class="stat-value" id="perfTotalStat" style="font-size:1.4rem;">â€“</div>
                        <div class="stat-label" style="font-size:.75rem;">Seit Start</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loans -->
        <div id="loanDisplayDash" class="hidden" style="background:linear-gradient(145deg,rgba(75,0,130,.10),rgba(106,13,173,.05));border:2px solid var(--purple);border-radius:12px;padding:1.5rem;margin-bottom:2rem;">
            <h3 style="color:var(--purple-light);margin-bottom:1rem;">ğŸ¦ Ausstehende Darlehen</h3>
            <div id="loanDetailsDash"></div>
        </div>

        <!-- Chart -->
        <div class="chart-container">
            <h3 style="color:var(--gold);margin-bottom:1.5rem;">ğŸ“ˆ VermÃ¶gensentwicklung</h3>
            <div id="lineChart" style="width:100%;height:260px;position:relative;"></div>
        </div>

        <!-- Portfolio Analysis -->
        <div style="background:rgba(0,0,0,.2);border-radius:12px;padding:1.5rem;margin-bottom:2rem;">
            <h3 style="color:var(--gold);margin-bottom:1.5rem;">ğŸ’¼ Portfolio-Analyse</h3>
            <div id="portfolioAnalysis"></div>
        </div>

        <!-- Top Performers -->
        <div style="background:rgba(0,0,0,.2);border-radius:12px;padding:1.5rem;margin-bottom:2rem;">
            <h3 style="color:var(--gold);margin-bottom:1.5rem;">ğŸ† Realisierte Performance</h3>
            <div id="topPerformers"></div>
        </div>

        <div class="btn-row">
            <button class="btn" onclick="proceedToTrading()">ğŸ“ˆ Zum Trading</button>
            <button class="btn btn-orange" onclick="showPenaltyInterface()">ğŸ’¸ Busse Bezahlen</button>
            <button class="btn btn-loan" onclick="showLoanInterface()">ğŸ¦ CSBS Darlehen</button>
            <button class="btn btn-secondary" onclick="showGameDashboard()">â† ZurÃ¼ck zu Preisen</button>
            <button class="btn btn-danger" onclick="endGame()" style="min-width:unset;padding:14px 18px;">ğŸ Spiel Beenden</button>
        </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• TRADING â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="tradingSection" class="game-section hidden">
        <h2 class="section-title">Order-Book & Trading</h2>
        <div id="tradingInfo"></div>
        <div id="tradingAlert"></div>
        <form id="orderBookForm" onsubmit="reviewTrades(event)" novalidate>
            <h3 style="color:var(--gold);text-align:center;margin-bottom:1.5rem;">
                ğŸ“‹ Order-Book â€“ Runde <span id="tradingRound">0</span>
            </h3>
            <div id="tradingGrid" style="display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));margin-bottom:2rem;"></div>
            <div class="btn-row">
                <button type="submit" class="btn">ğŸ“Š Trades ÃœberprÃ¼fen</button>
                <button type="button" class="btn btn-secondary" onclick="showBusinessDashboard()">â† Zum Dashboard</button>
            </div>
        </form>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• TRADE CONFIRMATION â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="tradeConfirmSection" class="game-section hidden">
        <h2 class="section-title">Trade-BestÃ¤tigung</h2>
        <div id="confirmInfo"></div>
        <div id="confirmAlert"></div>
        <h3 style="color:var(--gold);text-align:center;margin-bottom:1.5rem;">âš ï¸ BestÃ¤tigen Sie Ihre Trades</h3>
        <div id="tradesSummary"></div>
        <div style="background:rgba(255,255,255,.05);border:1px solid var(--gold-dim);border-radius:8px;padding:1.5rem;margin:1.5rem 0;">
            <h4 style="color:var(--gold);margin-bottom:1rem;">ğŸ’° Finanzielle Auswirkungen</h4>
            <div id="financialImpact"></div>
        </div>
        <div class="btn-row">
            <button class="btn" onclick="executeTrades()">âœ… Trades AusfÃ¼hren</button>
            <button class="btn" onclick="showTraderTipOff()" style="background:linear-gradient(145deg,#FFD700,#FFA500);color:var(--navy);">ğŸ•µï¸ Tip-Off</button>
            <button class="btn btn-secondary" onclick="showTradingSection()">â† Order-Book</button>
        </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SPECIAL ACTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="specialActionsSection" class="game-section hidden">
        <h2 class="section-title">Spezielle Aktionen</h2>
        <div id="specialInfo"></div>
        <div id="specialAlert"></div>

        <div class="special-grid">
            <div class="special-card" style="background:linear-gradient(145deg,rgba(255,215,0,.1),rgba(255,215,0,.05));border:2px solid var(--gold);">
                <div class="icon">ğŸƒ</div>
                <h3 style="color:var(--gold);">Trader</h3>
                <p>Extra-Trade dieser Runde</p>
                <button class="btn btn-block" style="margin-top:1rem;" onclick="showTraderModal()">ğŸš€ Aktivieren</button>
            </div>
            <div class="special-card" style="background:linear-gradient(145deg,rgba(0,255,127,.1),rgba(0,255,127,.05));border:2px solid var(--green);">
                <div class="icon">ğŸ’°</div>
                <h3 style="color:var(--green);">Dividende</h3>
                <p>AusschÃ¼ttungen erhalten</p>
                <button class="btn btn-block btn-green" style="margin-top:1rem;" onclick="showDividendInterface()">ğŸ’ Verwalten</button>
            </div>
            <div class="special-card" style="background:linear-gradient(145deg,rgba(255,69,0,.1),rgba(255,69,0,.05));border:2px solid var(--orange);">
                <div class="icon">ğŸ’¥</div>
                <h3 style="color:#FF6347;">Konkurs</h3>
                <p>Konkurse & Rettung</p>
                <button class="btn btn-block btn-orange" style="margin-top:1rem;" onclick="showBankruptcyInterface()">ğŸ†˜ Verwalten</button>
            </div>
            <div class="special-card" style="background:linear-gradient(145deg,rgba(138,43,226,.1),rgba(138,43,226,.05));border:2px solid var(--purple-light);">
                <div class="icon">â¡ï¸</div>
                <h3 style="color:var(--purple-light);">Weiter</h3>
                <p>Zur nÃ¤chsten Runde</p>
                <button class="btn btn-block" onclick="continueToNextRound()" style="margin-top:1rem;background:linear-gradient(145deg,var(--purple-light),#7B68EE);color:#fff;">ğŸ NÃ¤chste Runde</button>
            </div>
        </div>

        <div style="text-align:center;">
            <button class="btn btn-secondary" onclick="showTradingSection()">â† ZurÃ¼ck zum Trading</button>
        </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• PENALTY â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="penaltySection" class="game-section hidden">
        <h2 class="section-title">ğŸ’¸ Busse Bezahlen</h2>
        <div id="penaltyInfo"></div>
        <div id="penaltyAlert"></div>
        <form id="penaltyForm" onsubmit="processPenalty(event)" novalidate>
            <h3 style="color:#FF6347;text-align:center;margin-bottom:1.5rem;">âš ï¸ Strafzahlung vom Portfolio-Wert</h3>
            <div class="form-group">
                <label for="penaltyPercentage">Busse in % des Portfolio-Wertes (0â€“70%)</label>
                <input type="number" id="penaltyPercentage" class="form-control"
                       placeholder="z.B. 10" min="0" max="70" step="0.1" required
                       oninput="updatePenaltyPreview()">
            </div>
            <div id="penaltyPreview" style="background:rgba(255,255,255,.05);border:1px solid var(--gold-dim);border-radius:8px;padding:1.5rem;margin:1.5rem 0;"></div>
            <!-- Quick Liquidation -->
            <div id="quickLiquidation" class="hidden" style="background:linear-gradient(145deg,rgba(255,69,0,.1),rgba(255,69,0,.05));border:2px solid var(--orange);border-radius:12px;padding:1.5rem;margin:1.5rem 0;">
                <h4 style="color:#FF6347;margin-bottom:1rem;">ğŸ”¥ Schnell-Liquidation</h4>
                <p style="color:var(--gold-light);font-size:.9rem;margin-bottom:1rem;">Verkaufen Sie Aktien, um liquide Mittel zu schaffen:</p>
                <div id="liquidationGrid" style="display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));"></div>
            </div>
            <div class="btn-row">
                <button type="submit" class="btn btn-orange" id="payPenaltyBtn">ğŸ’¸ Busse Bezahlen</button>
                <button type="button" class="btn btn-secondary" onclick="showBusinessDashboard()">â† ZurÃ¼ck</button>
            </div>
        </form>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOAN â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="loanSection" class="game-section hidden">
        <h2 class="section-title">ğŸ¦ CSBS Darlehen</h2>
        <div id="loanInfo"></div>
        <div id="loanAlert"></div>
        <div class="interest-rate-display">
            <h3 style="color:var(--purple-light);margin-bottom:.5rem;">Ihr persÃ¶nlicher Zinssatz</h3>
            <div class="interest-rate-value" id="interestRateDisplay">â€“</div>
            <p style="color:var(--gold-light);margin-top:.5rem;font-size:.9rem;">pro Runde</p>
        </div>
        <div id="existingLoansDisplay" class="hidden" style="background:linear-gradient(145deg,rgba(220,20,60,.1),rgba(139,0,0,.05));border:2px solid var(--danger);border-radius:12px;padding:1.5rem;margin-bottom:2rem;">
            <h3 style="color:#FF6347;margin-bottom:1rem;">ğŸ’³ Bestehende Darlehen</h3>
            <div id="existingLoansList"></div>
        </div>
        <div style="display:flex;gap:1rem;margin-bottom:2rem;justify-content:center;">
            <button class="btn btn-loan" onclick="showLoanTab('new')" id="tabNewLoan">ğŸ’° Neues Darlehen</button>
            <button class="btn btn-secondary" onclick="showLoanTab('repay')" id="tabRepayLoan">ğŸ’³ ZurÃ¼ckzahlen</button>
        </div>
        <!-- New Loan Form -->
        <form id="loanForm" onsubmit="processLoan(event)" novalidate>
            <div class="form-group">
                <label for="loanAmount">Darlehensbetrag (CHF)</label>
                <input type="number" id="loanAmount" class="form-control"
                       placeholder="z.B. 50000" min="10000" step="10000" required
                       oninput="updateLoanPreview()">
                <small style="color:var(--gold-light);display:block;margin-top:.25rem;">
                    Min: CHF 10'000 | Max: <span id="maxLoanDisplay">â€“</span>
                </small>
            </div>
            <div id="loanPreview" style="background:rgba(255,255,255,.05);border:1px solid var(--gold-dim);border-radius:8px;padding:1.5rem;margin:1.5rem 0;"></div>
            <div class="btn-row">
                <button type="submit" class="btn btn-loan">ğŸ¦ Darlehen Aufnehmen</button>
                <button type="button" class="btn btn-secondary" onclick="showBusinessDashboard()">â† ZurÃ¼ck</button>
            </div>
        </form>
        <!-- Repay Form -->
        <form id="repayForm" onsubmit="processRepayment(event)" novalidate class="hidden">
            <div class="form-group">
                <label for="repayAmount">RÃ¼ckzahlungsbetrag (CHF)</label>
                <input type="number" id="repayAmount" class="form-control"
                       placeholder="z.B. 10000" min="100" step="100" required
                       oninput="updateRepaymentPreview()">
                <small style="color:var(--gold-light);display:block;margin-top:.25rem;">
                    LiquiditÃ¤t: <span id="availableCashDisplay">â€“</span> | 
                    Schulden: <span id="totalDebtDisplay">â€“</span>
                </small>
            </div>
            <div id="repaymentPreview" style="background:rgba(255,255,255,.05);border:1px solid var(--gold-dim);border-radius:8px;padding:1.5rem;margin:1.5rem 0;"></div>
            <div class="btn-row">
                <button type="submit" class="btn btn-green">ğŸ’³ Schulden ZurÃ¼ckzahlen</button>
                <button type="button" class="btn btn-secondary" onclick="showBusinessDashboard()">â† ZurÃ¼ck</button>
            </div>
        </form>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• DIVIDENDS â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="dividendSection" class="game-section hidden">
        <h2 class="section-title">ğŸ’° Dividenden-Verwaltung</h2>
        <div id="dividendInfo"></div>
        <div id="dividendAlert"></div>
        <form id="dividendForm" onsubmit="processDividends(event)" novalidate>
            <h3 style="color:var(--green);text-align:center;margin-bottom:1.5rem;">Dividenden pro Aktie eingeben</h3>
            <div id="dividendGrid" style="display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));"></div>
            <div class="btn-row">
                <button type="submit" class="btn btn-green">ğŸ’ AusschÃ¼tten</button>
                <button type="button" class="btn btn-secondary" onclick="showSpecialActions()">â† ZurÃ¼ck</button>
            </div>
        </form>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• BANKRUPTCY â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="bankruptcySection" class="game-section hidden">
        <h2 class="section-title">ğŸ’¥ Konkurs-Verwaltung</h2>
        <div id="bankruptcyInfo"></div>
        <div id="bankruptcyAlert"></div>
        <form id="bankruptcyForm" onsubmit="processBankruptcy(event)" novalidate>
            <h3 style="color:#FF6347;text-align:center;margin-bottom:1rem;">âš ï¸ Konkurs nur bei Firmen mit BEIDEN ausgefÃ¼llten Feldern</h3>
            <p style="text-align:center;color:var(--gold-light);margin-bottom:2rem;">
                Nur wenn <strong>Rettungskosten &gt; 0</strong>, gehen Aktien in Konkurs.<br>
                Leere Felder = Aktien bleiben erhalten.
            </p>
            <div id="bankruptcyGrid" style="display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));"></div>
            <div class="btn-row">
                <button type="submit" class="btn btn-orange">ğŸ†˜ Konkurs Abwickeln</button>
                <button type="button" class="btn btn-secondary" onclick="showSpecialActions()">â† ZurÃ¼ck</button>
            </div>
        </form>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• END GAME / FINAL DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="finalDashboard" class="game-section hidden">
        <h2 class="section-title">ğŸ Spiel Beendet</h2>
        <div id="finalSummary"></div>
        <div class="btn-row">
            <button class="btn" onclick="startNewGame()">ğŸ”„ Neues Spiel</button>
            <button class="btn btn-secondary" onclick="showMainMenu()">â† HauptmenÃ¼</button>
        </div>
    </section>

</div><!-- /.container -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• TRADER MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="traderModal" class="modal-overlay hidden" onclick="closeTraderModal(event)">
    <div class="modal-box">
        <h2 style="color:var(--gold);font-family:'Playfair Display',serif;text-align:center;margin-bottom:1.5rem;">
            ğŸƒ Trader â€“ Extra Trade
        </h2>
        <div id="traderAlert"></div>
        <form id="traderForm" onsubmit="executeTraderTrade(event)" novalidate>
            <div class="form-group">
                <label for="traderStock">Aktie auswÃ¤hlen</label>
                <select id="traderStock" class="form-control" required onchange="updateTraderPreview()">
                    <option value="">â€“ Aktie wÃ¤hlen â€“</option>
                </select>
            </div>
            <div class="form-group">
                <label for="traderPrice">Preis (CHF) â€“ anpassen falls geÃ¤ndert</label>
                <input type="number" id="traderPrice" class="form-control"
                       min="0" max="1000" step="10" placeholder="Preis"
                       oninput="updateTraderPreview()">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                <div class="form-group">
                    <label for="traderBuy">ğŸ“ˆ Kaufen</label>
                    <input type="number" id="traderBuy" class="form-control" min="0" step="1" placeholder="0" oninput="updateTraderPreview()">
                </div>
                <div class="form-group">
                    <label for="traderSell">ğŸ“‰ Verkaufen</label>
                    <input type="number" id="traderSell" class="form-control" min="0" step="1" placeholder="0" oninput="updateTraderPreview()">
                </div>
            </div>
            <div id="traderPreview" style="background:rgba(255,215,0,.1);border:2px solid var(--gold);border-radius:8px;padding:1rem;margin:1rem 0;text-align:center;color:var(--gold-light);">
                WÃ¤hlen Sie eine Aktie und Menge
            </div>
            <div class="btn-row">
                <button type="submit" class="btn">ğŸƒ Trade AusfÃ¼hren</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('traderModal')">â† Abbrechen</button>
            </div>
        </form>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• TIP-OFF MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tipOffModal" class="modal-overlay hidden" onclick="closeModal('tipOffModal')">
    <div class="modal-box" style="text-align:center;">
        <h2 style="color:var(--gold);font-family:'Playfair Display',serif;margin-bottom:1.5rem;">
            ğŸ•µï¸ TRADER TIP-OFF ğŸ•µï¸
        </h2>
        <div id="tipOffContent" style="background:rgba(255,215,0,.1);border:2px solid var(--gold);border-radius:10px;padding:2rem;margin-bottom:1.5rem;"></div>
        <p style="color:var(--gold-light);font-size:.9rem;margin-bottom:1.5rem;">
            ğŸ’¡ <em>Nutzen Sie diese Information weise...</em>
        </p>
        <button class="btn" onclick="closeModal('tipOffModal')">ğŸ¤ Verstanden</button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONFIRM MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="confirmModal" class="modal-overlay hidden">
    <div class="modal-box" style="text-align:center;max-width:420px;">
        <div style="font-size:2.5rem;margin-bottom:1rem;" id="confirmModalIcon">âš ï¸</div>
        <h3 style="color:var(--gold);font-family:'Playfair Display',serif;margin-bottom:1rem;" id="confirmModalTitle"></h3>
        <p style="color:var(--gold-light);margin-bottom:2rem;" id="confirmModalText"></p>
        <div class="btn-row" style="justify-content:center;">
            <button class="btn btn-danger" id="confirmModalYes" style="min-width:140px;">Ja, weiter</button>
            <button class="btn btn-secondary" onclick="closeModal('confirmModal')" style="min-width:140px;">Abbrechen</button>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STOCKS = [
    { id: 'CSBS',               name: 'CSBS' },
    { id: 'Rochartis',          name: 'Rochartis' },
    { id: 'HBB',                name: 'HBB' },
    { id: 'Richemontre',        name: 'Richemontre' },
    { id: 'Nestleau',           name: "Nest l'Ã©au" },
    { id: 'ZurichlerVers',      name: 'Zurichler Versicherungen' },
];

const STOCK_IDS   = STOCKS.map(s => s.id);
const STOCK_NAMES = Object.fromEntries(STOCKS.map(s => [s.id, s.name]));

function sn(id) { return STOCK_NAMES[id] || id; } // shorthand

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let G = null;   // game  (round, stockPrices, priceHistory)
let P = null;   // player
let needsRoundIncrement = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initApp() {
    try {
        const sg = localStorage.getItem('IBP_game');
        const sp = localStorage.getItem('IBP_player');
        if (sg && sp) {
            G = JSON.parse(sg);
            P = JSON.parse(sp);
            showGameDashboard();
        } else {
            showMainMenu();
        }
    } catch {
        clearStorage();
        showMainMenu();
    }
}

function clearStorage() {
    localStorage.removeItem('IBP_game');
    localStorage.removeItem('IBP_player');
}

function saveState() {
    localStorage.setItem('IBP_game',   JSON.stringify(G));
    localStorage.setItem('IBP_player', JSON.stringify(P));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ALL_SECTIONS = [
    'mainMenu','playerSetupSection','gameDashboard','businessDashboard',
    'tradingSection','tradeConfirmSection','specialActionsSection',
    'penaltySection','loanSection','dividendSection','bankruptcySection','finalDashboard'
];

function show(id) {
    ALL_SECTIONS.forEach(s => document.getElementById(s).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showMainMenu() {
    if (G && P) {
        showConfirm('ğŸ ', 'Zum HauptmenÃ¼?', 'Das Spiel bleibt gespeichert.', () => {
            show('mainMenu');
        });
        return;
    }
    show('mainMenu');
}

function startNewGame() { show('playerSetupSection'); document.getElementById('playerName').focus(); }
function showGameDashboard()     { show('gameDashboard');     renderGameInfo(); renderStockPriceInputs(); }
function showBusinessDashboard() { show('businessDashboard'); renderDashboard(); }
function showTradingSection()    { show('tradingSection');    renderTradingInfo(); renderTradingCards(); }
function showSpecialActions()    { show('specialActionsSection'); renderSpecialInfo(); }
function showPenaltyInterface()  { show('penaltySection');    renderPenaltyInfo(); updatePenaltyPreview(); }
function showDividendInterface() { show('dividendSection');   renderSectionInfo('dividendInfo','Dividenden-AusschÃ¼ttung','#00FF7F'); renderDividendInputs(); }
function showBankruptcyInterface(){ show('bankruptcySection');renderSectionInfo('bankruptcyInfo','Konkurs-Abwicklung','#FF6347'); renderBankruptcyInputs(); }
function proceedToTrading()      { showTradingSection(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYER SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupPlayer(e) {
    e.preventDefault();
    const name = document.getElementById('playerName').value.trim();
    const cash = parseInt(document.getElementById('startingCash').value);

    if (!name) { showAlert('setupAlert','Bitte einen Spielernamen eingeben.','error'); return; }
    if (!cash || cash < 1000 || cash > 1000000) {
        showAlert('setupAlert','Startkapital muss zwischen 1\'000 und 1\'000\'000 CHF liegen.','error');
        return;
    }

    const prices = Object.fromEntries(STOCK_IDS.map(id => [id, 100]));

    G = {
        round: 0,
        stockPrices: prices,
        priceHistory: [{ ...prices }],
    };

    P = {
        name, cash, initialCash: cash,
        portfolio:       Object.fromEntries(STOCK_IDS.map(id => [id, 0])),
        // FIFO cost basis: array of {amount, price, round}
        costBasis:       Object.fromEntries(STOCK_IDS.map(id => [id, []])),
        // Realized profit per stock (cumulative CHF)
        realizedPnL:     Object.fromEntries(STOCK_IDS.map(id => [id, 0])),
        transactions:    [],
        totalValue:      cash,
        valueHistory:    [cash],
        cashHistory:     [cash],
        loans:           [],
        totalDebt:       0,
        dividendHistory: [],
        penaltyHistory:  [],
        bankruptcyHistory: [],
    };

    needsRoundIncrement = true;
    saveState();
    showAlert('setupAlert','Spiel erfolgreich gestartet!','success');
    setTimeout(showGameDashboard, 1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PORTFOLIO & VALUE CALCULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function stockValue() {
    return STOCK_IDS.reduce((sum, id) => sum + (P.portfolio[id] || 0) * (G.stockPrices[id] || 0), 0);
}

function recalcTotalValue() {
    P.totalValue = P.cash + stockValue() - (P.totalDebt || 0);
}

function pushHistory() {
    const round = G.round;
    recalcTotalValue();
    // Extend arrays to current round index
    while (P.valueHistory.length <= round)  P.valueHistory.push(P.totalValue);
    while (P.cashHistory.length <= round)   P.cashHistory.push(P.cash);
    // Update current round slot
    P.valueHistory[round] = P.totalValue;
    P.cashHistory[round]  = P.cash;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FIFO realized P&L helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fifoSell(stockId, amount, sellPrice) {
    let toSell = amount;
    let realizedCost = 0;
    const newBasis = [];

    for (const lot of (P.costBasis[stockId] || [])) {
        if (toSell <= 0) { newBasis.push(lot); continue; }
        if (lot.amount <= toSell) {
            realizedCost += lot.amount * lot.price;
            toSell -= lot.amount;
        } else {
            realizedCost += toSell * lot.price;
            newBasis.push({ ...lot, amount: lot.amount - toSell });
            toSell = 0;
        }
    }
    P.costBasis[stockId] = newBasis;
    const realized = (sellPrice * amount) - realizedCost;
    P.realizedPnL[stockId] = (P.realizedPnL[stockId] || 0) + realized;
    return realized;
}

// Average cost basis of current holdings
function avgCost(stockId) {
    const lots = P.costBasis[stockId] || [];
    const totQty = lots.reduce((s, l) => s + l.amount, 0);
    if (totQty === 0) return 0;
    return lots.reduce((s, l) => s + l.amount * l.price, 0) / totQty;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FORMATTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fc(n) {
    return new Intl.NumberFormat('de-CH',{style:'currency',currency:'CHF',minimumFractionDigits:0,maximumFractionDigits:0}).format(n);
}

function fp(v) {
    return (v >= 0 ? '+' : '') + v.toFixed(1) + '%';
}

function fk(n) {
    const abs = Math.abs(n);
    if (abs >= 1e6) return (n/1e6).toFixed(1)+'M';
    if (abs >= 1e4) return (n/1e3).toFixed(0)+'k';
    return n.toFixed(0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showAlert(containerId, msg, type) {
    const el = document.getElementById(containerId);
    if (!el) return;
    el.innerHTML = `<div class="alert alert-${type}" role="alert">${msg}</div>`;
    if (type === 'success') setTimeout(() => { el.innerHTML = ''; }, 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INFO BARS  (shared helper)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderInfoBar(containerId, title, color, extraLine = '') {
    document.getElementById(containerId).innerHTML = `
        <div class="info-bar">
            <h3 style="color:${color};">${title}</h3>
            <p>Runde ${G.round} â€¢ Spieler: <strong>${P.name}</strong>
            ${extraLine ? ' â€¢ ' + extraLine : ''}</p>
        </div>`;
}

function renderSectionInfo(containerId, title, color) {
    renderInfoBar(containerId, title, color, `LiquiditÃ¤t: <strong>${fc(P.cash)}</strong>`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRICE MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGameInfo() {
    recalcTotalValue();
    renderInfoBar('gameInfo','Aktienpreis-Management','var(--gold)',
        `LiquiditÃ¤t: <strong>${fc(P.cash)}</strong> â€¢ VermÃ¶gen: <strong>${fc(P.totalValue)}</strong>`);
    document.getElementById('currentRound').textContent = G.round;
}

function renderStockPriceInputs() {
    const grid = document.getElementById('stockGrid');
    grid.innerHTML = '';
    STOCKS.forEach(({ id, name }) => {
        const eid = 'px_' + id;
        grid.insertAdjacentHTML('beforeend', `
            <div style="background:rgba(255,255,255,.05);border:1px solid var(--gold-dim);border-radius:8px;padding:1.5rem;">
                <label for="${eid}" style="font-weight:600;color:var(--gold);margin-bottom:.5rem;display:block;">${name}</label>
                <div style="display:flex;align-items:center;gap:.75rem;">
                    <input type="number" id="${eid}" class="form-control"
                           value="${G.stockPrices[id]}" min="0" max="1000" step="10" required style="flex:1;">
                    <span style="color:var(--gold-light);font-weight:600;">CHF</span>
                </div>
                <small style="color:var(--gold-light);display:block;margin-top:.25rem;">0 â€“ 1000 in 10er-Schritten</small>
            </div>`);
    });
}

function updateStockPrices(e) {
    e.preventDefault();

    if (needsRoundIncrement) {
        G.round += 1;
        needsRoundIncrement = false;
    }

    // Apply loan interest
    if (P.loans.length > 0) {
        P.loans.forEach(loan => {
            loan.totalOwed *= (1 + loan.interestRate / 100);
        });
        P.totalDebt = P.loans.reduce((s, l) => s + l.totalOwed, 0);
    }

    const newPrices = {};
    let err = false;

    STOCKS.forEach(({ id }) => {
        const inp = document.getElementById('px_' + id);
        const val = Number(inp.value);
        if (isNaN(val) || val < 0 || val > 1000 || val % 10 !== 0) {
            inp.style.borderColor = 'var(--red)';
            err = true;
        } else {
            inp.style.borderColor = 'var(--gold-dim)';
            newPrices[id] = val;
        }
    });

    if (err) {
        showAlert('stockPriceAlert','Preise mÃ¼ssen 0â€“1000 CHF in 10er-Schritten sein.','error');
        return;
    }

    G.stockPrices = newPrices;
    while (G.priceHistory.length <= G.round) G.priceHistory.push({ ...newPrices });
    G.priceHistory[G.round] = { ...newPrices };

    pushHistory();
    saveState();
    showAlert('stockPriceAlert','Preise aktualisiert! Weiter zum Dashboardâ€¦','success');
    setTimeout(showBusinessDashboard, 1400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUSINESS DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard() {
    recalcTotalValue();
    renderInfoBar('dashboardInfo','Business Intelligence Dashboard','var(--gold)');
    renderDashboardStats();
    renderLoansDash();
    renderLineChart();
    renderPortfolioAnalysis();
    renderTopPerformers();
}

function renderDashboardStats() {
    recalcTotalValue();
    const sv = stockValue();

    document.getElementById('totalValueStat').textContent    = fc(P.totalValue);
    document.getElementById('liquidityStat').textContent     = fc(P.cash);
    document.getElementById('portfolioValueStat').textContent = fc(sv);

    const absTV = Math.abs(P.totalValue) || 1;
    document.getElementById('liquidityRatio').textContent = (P.cash / absTV * 100).toFixed(1) + '% des VermÃ¶gens';

    // Last round perf
    let pr = 0;
    if (P.valueHistory.length >= 2) {
        const cur = P.valueHistory[P.valueHistory.length - 1];
        const prv = P.valueHistory[P.valueHistory.length - 2];
        pr = prv !== 0 ? ((cur - prv) / Math.abs(prv)) * 100 : 0;
    }
    const prEl = document.getElementById('perfRoundStat');
    prEl.textContent = fp(pr);
    prEl.className = 'stat-value ' + (pr >= 0 ? 'positive' : 'negative');
    prEl.style.fontSize = '1.4rem';

    // Total perf
    const pt = P.initialCash !== 0 ? ((P.totalValue - P.initialCash) / P.initialCash) * 100 : 0;
    const ptEl = document.getElementById('perfTotalStat');
    ptEl.textContent = fp(pt);
    ptEl.className = 'stat-value ' + (pt >= 0 ? 'positive' : 'negative');
    ptEl.style.fontSize = '1.4rem';
}

function renderLoansDash() {
    const wrap = document.getElementById('loanDisplayDash');
    if (!P.loans || P.loans.length === 0) { wrap.classList.add('hidden'); return; }
    wrap.classList.remove('hidden');

    let html = '<div style="display:grid;gap:.75rem;">';
    P.loans.forEach((l, i) => {
        html += `
            <div style="background:rgba(255,255,255,.05);border-left:4px solid var(--purple);padding:1rem;border-radius:8px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:.25rem;">
                    <span>Darlehen #${i+1}</span>
                    <span style="color:#FF6347;font-weight:600;">${fc(l.totalOwed)}</span>
                </div>
                <div style="color:var(--gold-light);font-size:.85rem;">
                    Runde ${l.round} â€¢ Zinssatz: ${l.interestRate.toFixed(2)}% â€¢ Ursprung: ${fc(l.principal)}
                </div>
            </div>`;
    });
    html += `</div>
        <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid rgba(106,13,173,.3);display:flex;justify-content:space-between;">
            <span style="color:var(--purple-light);font-weight:600;">Gesamtschulden:</span>
            <span style="color:#FF6347;font-weight:700;font-size:1.1rem;">${fc(P.totalDebt)}</span>
        </div>`;
    document.getElementById('loanDetailsDash').innerHTML = html;
}

function renderLineChart() {
    const el = document.getElementById('lineChart');
    // Show from round 1 onwards
    const vals = P.valueHistory.slice(1);
    if (vals.length === 0) {
        el.innerHTML = '<p style="color:var(--gold-light);text-align:center;padding-top:2rem;">Noch keine Daten</p>';
        return;
    }

    const W = el.clientWidth || 600, H = 260;
    const pad = { t:20, r:20, b:55, l:90 };
    const cw = W - pad.l - pad.r, ch = H - pad.t - pad.b;

    const maxV = Math.max(...vals);
    const minV = Math.min(0, ...vals);
    const range = maxV - minV || 1;

    const xOf = i => pad.l + (vals.length > 1 ? i * cw / (vals.length - 1) : cw / 2);
    const yOf = v => pad.t + ((maxV - v) / range) * ch;

    const pts = vals.map((v, i) => `${xOf(i)},${yOf(v)}`).join(' ');

    let dots = '';
    vals.forEach((v, i) => {
        const x = xOf(i), y = yOf(v);
        dots += `
            <circle cx="${x}" cy="${y}" r="5" fill="var(--gold)"/>
            <text x="${x}" y="${H - pad.b + 18}" fill="var(--gold-light)" text-anchor="middle" font-size="11">R${i+1}</text>
            <text x="${x}" y="${H - pad.b + 33}" fill="var(--cream)" text-anchor="middle" font-size="10" font-weight="600">${fk(v)}</text>`;
    });

    el.innerHTML = `
        <svg viewBox="0 0 ${W} ${H}" style="width:100%;height:100%;">
            <line x1="${pad.l}" y1="${pad.t}" x2="${pad.l}" y2="${H-pad.b}" stroke="rgba(212,175,55,.3)"/>
            <line x1="${pad.l}" y1="${H-pad.b}" x2="${W-pad.r}" y2="${H-pad.b}" stroke="rgba(212,175,55,.3)"/>
            <line x1="${pad.l}" y1="${pad.t}" x2="${W-pad.r}" y2="${pad.t}" stroke="rgba(212,175,55,.15)" stroke-dasharray="3,3"/>
            <line x1="${pad.l}" y1="${pad.t+ch*.5}" x2="${W-pad.r}" y2="${pad.t+ch*.5}" stroke="rgba(212,175,55,.15)" stroke-dasharray="3,3"/>
            <text x="${pad.l-8}" y="${pad.t+4}" fill="var(--gold-light)" text-anchor="end" font-size="11">CHF ${fk(maxV)}</text>
            <text x="${pad.l-8}" y="${pad.t+ch*.5+4}" fill="var(--gold-light)" text-anchor="end" font-size="11">CHF ${fk((maxV+minV)/2)}</text>
            <text x="${pad.l-8}" y="${H-pad.b}" fill="var(--gold-light)" text-anchor="end" font-size="11">CHF ${fk(minV)}</text>
            <polyline fill="none" stroke="var(--gold)" stroke-width="3" points="${pts}"/>
            ${dots}
        </svg>`;
}

function renderPortfolioAnalysis() {
    const el = document.getElementById('portfolioAnalysis');
    let total = 0;
    const holdings = [];

    STOCK_IDS.forEach(id => {
        const shares = P.portfolio[id] || 0;
        const price  = G.stockPrices[id] || 0;
        const value  = shares * price;
        if (shares > 0) {
            total += value;
            const avg = avgCost(id);
            const pct = avg > 0 ? ((price - avg) / avg) * 100 : 0;
            holdings.push({ id, shares, price, avg, value, pct });
        }
    });

    if (holdings.length === 0) {
        el.innerHTML = '<p style="color:var(--gold-light);text-align:center;">Keine Aktien im Portfolio</p>';
        return;
    }

    holdings.sort((a, b) => b.value - a.value);

    el.innerHTML = '<div style="display:grid;gap:1rem;">' + holdings.map(h => {
        const pctOfPortfolio = total > 0 ? (h.value / total) * 100 : 0;
        const pctColor = h.pct >= 0 ? 'var(--green)' : '#FF6347';
        return `
            <div style="background:rgba(255,255,255,.05);border-left:4px solid var(--gold);padding:1rem;border-radius:8px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;">
                    <span style="color:var(--gold);font-weight:600;">${sn(h.id)}</span>
                    <span style="font-weight:600;">${fc(h.value)}</span>
                </div>
                <div style="display:flex;justify-content:space-between;color:var(--gold-light);font-size:.9rem;">
                    <span>${h.shares} Stk. @ Ã˜ ${fc(h.avg > 0 ? h.avg : h.price)}</span>
                    <span>Kurs: ${fc(h.price)} <span style="color:${pctColor};">(${fp(h.pct)})</span></span>
                </div>
                <div class="performance-bar">
                    <div class="performance-fill" style="width:${Math.min(100, pctOfPortfolio)}%;"></div>
                    <span class="performance-label">${pctOfPortfolio.toFixed(1)}%</span>
                </div>
            </div>`;
    }).join('') + '</div>';
}

function renderTopPerformers() {
    const el = document.getElementById('topPerformers');
    const performers = STOCK_IDS
        .filter(id => P.realizedPnL[id] !== 0)
        .map(id => ({ id, profit: P.realizedPnL[id] }))
        .sort((a, b) => b.profit - a.profit);

    if (performers.length === 0) {
        el.innerHTML = '<p style="color:var(--gold-light);text-align:center;">Noch keine realisierten Gewinne/Verluste</p>';
        return;
    }

    const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    el.innerHTML = '<div style="display:grid;gap:.75rem;">' +
        performers.map((p, i) => `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:.75rem;background:rgba(255,255,255,.05);border-radius:8px;">
                <span>
                    ${medals[i] || ''} ${sn(p.id)}
                    ${i === 0 && p.profit > 0 ? '<span class="badge-top">TOP</span>' : ''}
                </span>
                <div style="text-align:right;">
                    <span style="color:${p.profit >= 0 ? 'var(--green)' : '#FF6347'};font-weight:600;">
                        ${p.profit >= 0 ? '+' : ''}${fc(p.profit)}
                    </span>
                    <br>
                    <span style="color:var(--gold-light);font-size:.82rem;">Realisiert</span>
                </div>
            </div>`).join('')
        + '</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTradingInfo() {
    recalcTotalValue();
    renderInfoBar('tradingInfo','Order-Book & Trading','var(--gold)',
        `LiquiditÃ¤t: <strong style="color:var(--gold);">${fc(P.cash)}</strong>`);
    document.getElementById('tradingRound').textContent = G.round;
}

function renderTradingCards() {
    const grid = document.getElementById('tradingGrid');
    grid.innerHTML = '';
    STOCKS.forEach(({ id, name }) => {
        const price    = G.stockPrices[id];
        const holdings = P.portfolio[id] || 0;
        const sid      = id;

        grid.insertAdjacentHTML('beforeend', `
            <div style="background:linear-gradient(145deg,rgba(255,255,255,.10),rgba(255,255,255,.05));border:2px solid var(--gold-dim);border-radius:12px;padding:1.5rem;">
                <div style="text-align:center;margin-bottom:1rem;">
                    <h4 style="color:var(--gold);font-family:'Playfair Display',serif;margin-bottom:.5rem;">${name}</h4>
                    <div style="display:flex;justify-content:space-between;color:var(--gold-light);font-size:.9rem;">
                        <span>Preis: <strong>${fc(price)}</strong></span>
                        <span>Besitz: <strong>${holdings} Stk.</strong></span>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;" class="trade-cols">
                    <div>
                        <label style="color:var(--gold-light);font-weight:600;font-size:.9rem;display:block;margin-bottom:.4rem;">ğŸ“ˆ Kaufen</label>
                        <div style="display:flex;gap:.25rem;">
                            <input type="number" id="buy_${sid}" class="form-control" placeholder="Anz." min="0" step="1" style="text-align:center;min-width:0;">
                            <button type="button" class="btn" onclick="setMax('buy','${sid}')" style="padding:8px 10px;min-width:auto;flex-shrink:0;">MAX</button>
                        </div>
                    </div>
                    <div>
                        <label style="color:var(--gold-light);font-weight:600;font-size:.9rem;display:block;margin-bottom:.4rem;">ğŸ“‰ Verkaufen</label>
                        <div style="display:flex;gap:.25rem;">
                            <input type="number" id="sell_${sid}" class="form-control" placeholder="Anz." min="0" max="${holdings}" step="1" style="text-align:center;min-width:0;">
                            <button type="button" class="btn" onclick="setMax('sell','${sid}')" style="padding:8px 10px;min-width:auto;flex-shrink:0;">MAX</button>
                        </div>
                    </div>
                </div>
                <div id="tp_${sid}" style="margin-top:.75rem;padding:.6rem;background:rgba(0,0,0,.25);border-radius:6px;text-align:center;color:var(--gold-light);font-size:.9rem;">
                    Menge eingeben fÃ¼r Vorschau
                </div>
            </div>`);

        const buyInp  = document.getElementById('buy_'  + sid);
        const sellInp = document.getElementById('sell_' + sid);

        buyInp.addEventListener('input', () => {
            if (buyInp.value  > 0) sellInp.value = '';
            renderTradePreview(id);
        });
        sellInp.addEventListener('input', () => {
            if (sellInp.value > 0) buyInp.value  = '';
            renderTradePreview(id);
        });
    });
}

function setMax(action, stockId) {
    const price = G.stockPrices[stockId];
    if (action === 'buy') {
        // Include revenue from all currently filled sell-inputs (netting)
        let pendingSellRevenue = 0;
        STOCK_IDS.forEach(id => {
            const s = parseInt(document.getElementById('sell_' + id)?.value) || 0;
            pendingSellRevenue += s * (G.stockPrices[id] || 0);
        });
        const netAvailable = P.cash + pendingSellRevenue;
        document.getElementById('buy_' + stockId).value  = Math.floor(netAvailable / price);
        document.getElementById('sell_' + stockId).value = '';
    } else {
        document.getElementById('sell_' + stockId).value = P.portfolio[stockId] || 0;
        document.getElementById('buy_'  + stockId).value = '';
    }
    renderTradePreview(stockId);
}

function renderTradePreview(stockId) {
    const buy  = parseInt(document.getElementById('buy_'  + stockId).value) || 0;
    const sell = parseInt(document.getElementById('sell_' + stockId).value) || 0;
    const price = G.stockPrices[stockId];
    const el   = document.getElementById('tp_' + stockId);

    // Calculate total pending sells across all stocks (for net liquidity display)
    let pendingSellRevenue = 0;
    STOCK_IDS.forEach(id => {
        const s = parseInt(document.getElementById('sell_' + id)?.value) || 0;
        pendingSellRevenue += s * (G.stockPrices[id] || 0);
    });
    const netAvailable = P.cash + pendingSellRevenue;

    if (buy > 0) {
        const cost = buy * price;
        const ok   = cost <= netAvailable;
        const hint = netAvailable > P.cash
            ? `<small style="color:var(--gold-light);">(inkl. ${fc(pendingSellRevenue)} VerkaufserlÃ¶s)</small>`
            : '';
        el.innerHTML = `<span style="color:${ok ? 'var(--gold)' : '#FF6347'};">
            ${buy} Ã— ${fc(price)} = ${fc(cost)} ${ok ? 'âœ…' : 'âŒ Nicht genug (verfÃ¼gbar: ' + fc(netAvailable) + ')'}
        </span>${hint}`;
    } else if (sell > 0) {
        el.innerHTML = `<span style="color:var(--gold);">${sell} Ã— ${fc(price)} = ${fc(sell * price)} âœ… (ErlÃ¶s fÃ¼r KÃ¤ufe nutzbar)</span>`;
    } else {
        el.textContent = 'Menge eingeben fÃ¼r Vorschau';
    }
}

function reviewTrades(e) {
    e.preventDefault();
    const trades = [];
    let totalCost = 0, totalRevenue = 0;

    for (const { id } of STOCKS) {
        const buy  = parseInt(document.getElementById('buy_'  + id).value) || 0;
        const sell = parseInt(document.getElementById('sell_' + id).value) || 0;
        const price = G.stockPrices[id];

        if (buy > 0 && sell > 0) {
            showAlert('tradingAlert', `Fehler bei ${sn(id)}: Kauf und Verkauf gleichzeitig nicht mÃ¶glich.`, 'error');
            return;
        }
        if (sell > (P.portfolio[id] || 0)) {
            showAlert('tradingAlert', `Fehler bei ${sn(id)}: Nur ${P.portfolio[id]} Stk. vorhanden.`, 'error');
            return;
        }
        if (buy  > 0) { totalCost    += buy  * price; trades.push({ id, action:'buy',  amount:buy,  price, total:buy*price  }); }
        if (sell > 0) { totalRevenue += sell * price; trades.push({ id, action:'sell', amount:sell, price, total:sell*price }); }
    }

    // Net check: sell proceeds count toward buying power in the same round
    const netCashAvailable = P.cash + totalRevenue;
    if (totalCost > netCashAvailable) {
        showAlert('tradingAlert',
            `Nicht genug LiquiditÃ¤t! BenÃ¶tigt: ${fc(totalCost)}, VerfÃ¼gbar nach VerkÃ¤ufen: ${fc(netCashAvailable)}`,
            'error');
        return;
    }

    if (trades.length === 0) {
        showAlert('tradingAlert', 'Keine Trades â€“ weiter zu speziellen Aktionenâ€¦', 'info');
        setTimeout(showSpecialActions, 1500);
        return;
    }

    P._pendingTrades   = trades;
    P._pendingCost     = totalCost;
    P._pendingRevenue  = totalRevenue;

    show('tradeConfirmSection');
    renderConfirmInfo();
    renderTradesSummary();
}

function renderConfirmInfo() {
    renderInfoBar('confirmInfo','Trade-BestÃ¤tigung','var(--gold)',`LiquiditÃ¤t: <strong>${fc(P.cash)}</strong>`);
}

function renderTradesSummary() {
    const trades   = P._pendingTrades || [];
    const net      = (P._pendingRevenue || 0) - (P._pendingCost || 0);
    const newCash  = P.cash + net;
    const sellFirst = net < 0 && (P._pendingRevenue || 0) > 0; // net buy using sell proceeds

    document.getElementById('tradesSummary').innerHTML =
        '<div style="display:grid;gap:.5rem;">' +
        trades.map(t => {
            const isBuy = t.action === 'buy';
            return `
                <div style="background:rgba(255,255,255,.05);border-left:4px solid ${isBuy ? '#00FF7F' : '#FF6347'};padding:.9rem;border-radius:4px;">
                    <div style="display:flex;justify-content:space-between;">
                        <span style="font-weight:600;">${isBuy ? 'ğŸ“ˆ KAUF' : 'ğŸ“‰ VERKAUF'} ${sn(t.id)}</span>
                        <span style="color:${isBuy ? 'var(--green)' : '#FF6347'};font-weight:600;">${fc(t.total)}</span>
                    </div>
                    <div style="color:var(--gold-light);font-size:.9rem;">${t.amount} Stk. Ã— ${fc(t.price)}</div>
                </div>`;
        }).join('') + '</div>';

    // Portfolio changes
    const changes = {};
    trades.forEach(t => { changes[t.id] = (changes[t.id] || 0) + (t.action==='buy' ? t.amount : -t.amount); });

    let changeHtml = '';
    Object.entries(changes).forEach(([id, delta]) => {
        const from = P.portfolio[id] || 0;
        changeHtml += `<div style="display:flex;justify-content:space-between;margin-bottom:.4rem;">
            <span>${sn(id)}:</span>
            <span style="color:${delta>0?'var(--green)':'#FF6347'};font-weight:600;">${from} â†’ ${from+delta} Stk. ${delta>0?'ğŸ“ˆ':'ğŸ“‰'}</span>
        </div>`;
    });

    document.getElementById('financialImpact').innerHTML = `
        <div style="display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));">
            <div>
                <strong style="color:var(--gold);">LiquiditÃ¤t</strong><br>
                Aktuell: ${fc(P.cash)}<br>
                ${sellFirst ? `<span style="color:var(--gold-light);font-size:.85rem;">nach VerkÃ¤ufen: ${fc(P.cash + (P._pendingRevenue||0))}</span><br>` : ''}
                <span style="color:${net>=0?'var(--green)':'#FF6347'};font-weight:600;">Nach allen Trades: ${fc(newCash)}</span>
            </div>
            <div>
                <strong style="color:var(--gold);">Cash Flow</strong><br>
                ${P._pendingRevenue > 0 ? `Einnahmen (Verkauf): <span style="color:var(--green);">${fc(P._pendingRevenue)}</span><br>` : ''}
                ${P._pendingCost    > 0 ? `Ausgaben (Kauf): <span style="color:#FF6347;">${fc(P._pendingCost)}</span><br>` : ''}
                Netto: <span style="color:${net>=0?'var(--green)':'#FF6347'};font-weight:600;">${fc(net)}</span>
            </div>
        </div>
        ${sellFirst ? `<div style="margin-top:.75rem;padding:.75rem;background:rgba(0,255,127,.08);border-left:3px solid var(--green);border-radius:4px;font-size:.9rem;color:var(--gold-light);">
            â„¹ï¸ VerkÃ¤ufe werden zuerst ausgefÃ¼hrt â€“ ErlÃ¶s steht sofort fÃ¼r KÃ¤ufe zur VerfÃ¼gung.
        </div>` : ''}
        ${changeHtml ? `<div style="margin-top:1rem;"><strong style="color:var(--gold);">Portfolio-Ã„nderungen</strong><br><br>${changeHtml}</div>` : ''}`;
}

function executeTrades() {
    const trades = P._pendingTrades || [];
    if (!trades.length) { showAlert('confirmAlert','Keine Trades vorhanden.','error'); return; }

    // Execute sells FIRST so proceeds are available for buys in same round
    const sells = trades.filter(t => t.action === 'sell');
    const buys  = trades.filter(t => t.action === 'buy');

    [...sells, ...buys].forEach(t => {
        if (t.action === 'buy') {
            P.cash -= t.total;
            P.portfolio[t.id] = (P.portfolio[t.id] || 0) + t.amount;
            if (!P.costBasis[t.id]) P.costBasis[t.id] = [];
            P.costBasis[t.id].push({ amount:t.amount, price:t.price, round:G.round });
        } else {
            P.cash += t.total;
            P.portfolio[t.id] -= t.amount;
            fifoSell(t.id, t.amount, t.price);
        }
        P.transactions.push({ round:G.round, type:t.action, id:t.id, amount:t.amount, price:t.price, total:t.total });
    });

    delete P._pendingTrades;
    delete P._pendingCost;
    delete P._pendingRevenue;

    pushHistory();
    saveState();
    showAlert('confirmAlert','âœ… Trades erfolgreich ausgefÃ¼hrt!','success');
    setTimeout(showSpecialActions, 1400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPECIAL ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSpecialInfo() {
    recalcTotalValue();
    renderInfoBar('specialInfo','Spezielle Aktionen','var(--gold)',
        `LiquiditÃ¤t: <strong>${fc(P.cash)}</strong> â€¢ VermÃ¶gen: <strong>${fc(P.totalValue)}</strong>`);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TRADER MODAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTraderModal() {
    // Populate dropdown
    const sel = document.getElementById('traderStock');
    sel.innerHTML = '<option value="">â€“ Aktie wÃ¤hlen â€“</option>' +
        STOCKS.map(s => `<option value="${s.id}">${s.name} â€“ ${fc(G.stockPrices[s.id])}</option>`).join('');
    document.getElementById('traderBuy').value   = '';
    document.getElementById('traderSell').value  = '';
    document.getElementById('traderPrice').value = '';
    document.getElementById('traderAlert').innerHTML = '';
    document.getElementById('traderPreview').textContent = 'WÃ¤hlen Sie eine Aktie und Menge';
    document.getElementById('traderModal').classList.remove('hidden');
}

function closeTraderModal(e) {
    if (e.target === document.getElementById('traderModal')) closeModal('traderModal');
}

function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
}

function updateTraderPreview() {
    const stockId  = document.getElementById('traderStock').value;
    const buy      = parseInt(document.getElementById('traderBuy').value)   || 0;
    const sell     = parseInt(document.getElementById('traderSell').value)  || 0;
    const custPx   = parseInt(document.getElementById('traderPrice').value) || 0;
    const el       = document.getElementById('traderPreview');

    if (!stockId) { el.textContent = 'WÃ¤hlen Sie eine Aktie'; return; }

    // Auto-fill price on stock selection
    if (!document.getElementById('traderPrice').value) {
        document.getElementById('traderPrice').value = G.stockPrices[stockId];
    }

    const price    = custPx > 0 ? custPx : G.stockPrices[stockId];
    const holdings = P.portfolio[stockId] || 0;

    if (buy > 0 && sell > 0) {
        el.innerHTML = '<span style="color:#FF6347;">âš ï¸ Kauf und Verkauf gleichzeitig nicht mÃ¶glich!</span>';
        return;
    }
    if (buy > 0) {
        const cost = buy * price;
        const ok   = cost <= P.cash;
        el.innerHTML = `<strong>ğŸ“ˆ Kauf:</strong> ${buy} Ã— ${fc(price)} = <span style="color:${ok?'var(--green)':'#FF6347'};">${fc(cost)} ${ok?'âœ…':'âŒ'}</span>
            <br><small style="color:var(--gold-light);">Besitz nach Kauf: ${holdings + buy} Stk.</small>`;
    } else if (sell > 0) {
        const rev = sell * price;
        const ok  = sell <= holdings;
        el.innerHTML = `<strong>ğŸ“‰ Verkauf:</strong> ${sell} Ã— ${fc(price)} = <span style="color:${ok?'var(--green)':'#FF6347'};">${fc(rev)} ${ok?'âœ…':'âŒ Nicht genug Stk.'}</span>`;
    } else {
        el.textContent = 'Menge eingeben fÃ¼r Vorschau';
    }
}

function executeTraderTrade(e) {
    e.preventDefault();
    const stockId  = document.getElementById('traderStock').value;
    const buy      = parseInt(document.getElementById('traderBuy').value)   || 0;
    const sell     = parseInt(document.getElementById('traderSell').value)  || 0;
    const custPx   = parseInt(document.getElementById('traderPrice').value) || 0;

    if (!stockId)                         { showAlert('traderAlert','Bitte Aktie auswÃ¤hlen.','error'); return; }
    if (buy === 0 && sell === 0)          { showAlert('traderAlert','Menge eingeben.','error'); return; }
    if (buy > 0 && sell > 0)             { showAlert('traderAlert','Kauf und Verkauf gleichzeitig nicht mÃ¶glich.','error'); return; }
    if (custPx > 0 && (custPx < 0 || custPx > 1000 || custPx % 10 !== 0)) {
        showAlert('traderAlert','Preis muss 0â€“1000 in 10er-Schritten sein.','error'); return;
    }

    const price    = custPx > 0 ? custPx : G.stockPrices[stockId];
    const holdings = P.portfolio[stockId] || 0;

    if (buy > 0) {
        const cost = buy * price;
        if (cost > P.cash) { showAlert('traderAlert','Nicht genug LiquiditÃ¤t.','error'); return; }
        P.cash -= cost;
        P.portfolio[stockId] = holdings + buy;
        if (!P.costBasis[stockId]) P.costBasis[stockId] = [];
        P.costBasis[stockId].push({ amount:buy, price, round:G.round });
        showAlert('traderAlert',`ğŸƒ Kauf erfolgreich: ${buy} ${sn(stockId)} fÃ¼r ${fc(cost)}`, 'success');
    } else {
        if (sell > holdings) { showAlert('traderAlert','Nicht genug Stk. im Besitz.','error'); return; }
        const rev = sell * price;
        P.cash += rev;
        P.portfolio[stockId] -= sell;
        fifoSell(stockId, sell, price);
        showAlert('traderAlert',`ğŸƒ Verkauf erfolgreich: ${sell} ${sn(stockId)} fÃ¼r ${fc(rev)}`, 'success');
    }

    P.transactions.push({ round:G.round, type:'trader', id:stockId, amount:buy||sell, price, action:buy>0?'buy':'sell' });
    pushHistory();
    saveState();
    setTimeout(() => { closeModal('traderModal'); showSpecialActions(); }, 1800);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DIVIDENDS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDividendInputs() {
    const grid = document.getElementById('dividendGrid');
    grid.innerHTML = '';
    STOCKS.forEach(({ id, name }) => {
        const h = P.portfolio[id] || 0;
        grid.insertAdjacentHTML('beforeend', `
            <div style="background:linear-gradient(145deg,rgba(0,255,127,.10),rgba(0,255,127,.05));border:2px solid var(--green);border-radius:12px;padding:1.5rem;">
                <h4 style="color:var(--green);margin-bottom:.5rem;font-family:'Playfair Display',serif;">${name}</h4>
                <div style="color:var(--gold-light);font-size:.9rem;margin-bottom:1rem;">Besitz: <strong>${h} Stk.</strong></div>
                <label style="color:var(--green);font-weight:600;margin-bottom:.4rem;display:block;font-size:.9rem;">ğŸ’° CHF pro Aktie</label>
                <input type="number" id="div_${id}" class="form-control" placeholder="0"
                       min="0" max="100" step="0.1" ${h===0?'disabled':''}>
                <div id="divp_${id}" style="margin-top:.5rem;color:var(--gold-light);font-size:.85rem;text-align:center;">
                    ${h===0 ? 'Keine Aktien' : 'Betrag eingeben'}
                </div>
            </div>`);
        if (h > 0) {
            document.getElementById('div_'+id).addEventListener('input', () => {
                const v = parseFloat(document.getElementById('div_'+id).value) || 0;
                document.getElementById('divp_'+id).innerHTML = v > 0
                    ? `<span style="color:var(--green);">ğŸ’° ${h} Ã— ${fc(v)} = ${fc(v*h)}</span>`
                    : 'Betrag eingeben';
            });
        }
    });
}

function processDividends(e) {
    e.preventDefault();
    let total = 0;
    const txs = [];

    STOCKS.forEach(({ id }) => {
        const v = parseFloat(document.getElementById('div_'+id)?.value) || 0;
        const h = P.portfolio[id] || 0;
        if (v > 0 && h > 0) {
            const amt = v * h;
            total += amt;
            txs.push({ id, perShare:v, amount:h, total:amt });
        }
    });

    if (total === 0) { showAlert('dividendAlert','Keine Dividenden eingegeben.','error'); return; }

    P.cash += total;
    txs.forEach(t => P.dividendHistory.push({ round:G.round, ...t }));
    pushHistory();
    saveState();
    showAlert('dividendAlert',`ğŸ’° ${fc(total)} Dividenden ausgeschÃ¼ttet!`,'success');
    setTimeout(showSpecialActions, 2000);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BANKRUPTCY
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBankruptcyInputs() {
    const grid = document.getElementById('bankruptcyGrid');
    grid.innerHTML = '';
    STOCKS.forEach(({ id, name }) => {
        const h = P.portfolio[id] || 0;
        grid.insertAdjacentHTML('beforeend', `
            <div style="background:linear-gradient(145deg,rgba(255,69,0,.10),rgba(255,69,0,.05));border:2px solid var(--orange);border-radius:12px;padding:1.5rem;">
                <h4 style="color:#FF6347;margin-bottom:.5rem;font-family:'Playfair Display',serif;">${name}</h4>
                <div style="color:var(--gold-light);font-size:.9rem;margin-bottom:1rem;">BestÃ¤nde: <strong>${h} Stk.</strong></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:.75rem;">
                    <div>
                        <label style="font-size:.85rem;color:#FF6347;font-weight:600;display:block;margin-bottom:.3rem;">ğŸ†˜ Zu retten</label>
                        <input type="number" id="rescue_${id}" class="form-control"
                               min="0" max="${h}" step="1" placeholder="Anz." ${h===0?'disabled':''}>
                    </div>
                    <div>
                        <label style="font-size:.85rem;color:#FF6347;font-weight:600;display:block;margin-bottom:.3rem;">ğŸ’¸ Kosten/Stk.</label>
                        <input type="number" id="cost_${id}" class="form-control"
                               min="0" step="1" placeholder="CHF" ${h===0?'disabled':''}>
                    </div>
                </div>
                <div id="bkp_${id}" style="padding:.6rem;background:rgba(0,0,0,.2);border-radius:6px;text-align:center;font-size:.85rem;color:var(--gold-light);">
                    ${h===0 ? 'Keine Aktien' : 'âœ… Kein Konkurs â€“ Rettungskosten eingeben'}
                </div>
            </div>`);

        if (h > 0) {
            const update = () => {
                const r   = parseInt(document.getElementById('rescue_'+id).value);
                const c   = parseFloat(document.getElementById('cost_'+id).value) || 0;
                const el  = document.getElementById('bkp_'+id);
                const rVal = isNaN(r) ? 0 : r;
                if (c > 0) {
                    const lost  = h - rVal;
                    const costs = rVal * c;
                    const ok    = costs <= P.cash && rVal <= h;
                    el.innerHTML = `<span style="color:${ok?'#FF6347':'#ccc'};">
                        âš ï¸ KONKURS AKTIV â€¢ Kosten: ${fc(costs)} ${costs<=P.cash?'âœ…':'âŒ'}<br>
                        ğŸ†˜ Gerettet: ${rVal} Stk. â€¢ ğŸ’¥ Verloren: ${lost} Stk.</span>`;
                } else {
                    el.innerHTML = `<span style="color:var(--green);">âœ… Kein Konkurs â€“ Aktien bleiben erhalten</span>`;
                }
            };
            document.getElementById('rescue_'+id).addEventListener('input', update);
            document.getElementById('cost_'+id).addEventListener('input', update);
        }
    });
}

function processBankruptcy(e) {
    e.preventDefault();
    const txs = [];
    let totalCost = 0;

    for (const { id } of STOCKS) {
        const r = parseInt(document.getElementById('rescue_'+id)?.value);
        const c = parseFloat(document.getElementById('cost_'+id)?.value) || 0;
        const h = P.portfolio[id] || 0;
        const rVal = isNaN(r) ? 0 : r;

        if (c > 0) {
            if (rVal > h) {
                showAlert('bankruptcyAlert', `Fehler bei ${sn(id)}: Nur ${h} Stk. vorhanden.`, 'error');
                return;
            }
            const stockCost = rVal * c;
            totalCost += stockCost;
            txs.push({ id, rescued:rVal, lost:h-rVal, costPerShare:c, total:stockCost });
        }
    }

    if (txs.length === 0) { showAlert('bankruptcyAlert','Keine Konkursaktionen eingegeben.','error'); return; }
    if (totalCost > P.cash) {
        showAlert('bankruptcyAlert', `Nicht genug LiquiditÃ¤t! BenÃ¶tigt: ${fc(totalCost)}, VerfÃ¼gbar: ${fc(P.cash)}`, 'error');
        return;
    }

    txs.forEach(t => {
        P.cash -= t.total;
        P.portfolio[t.id] = t.rescued;
        // Remove cost basis for lost shares (FIFO)
        if (t.lost > 0) fifoSell(t.id, t.lost, 0); // 0 price = full loss
        P.bankruptcyHistory.push({ round:G.round, ...t });
    });

    pushHistory();
    saveState();
    const summary = txs.map(t => `${sn(t.id)}: ${t.rescued} gerettet, ${t.lost} verloren`).join('<br>');
    showAlert('bankruptcyAlert', `ğŸ’¥ Konkurs abgewickelt!<br>${summary}<br>Gesamtkosten: ${fc(totalCost)}`, 'success');
    setTimeout(showSpecialActions, 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PENALTY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPenaltyInfo() {
    recalcTotalValue();
    const sv = stockValue();
    renderInfoBar('penaltyInfo','Strafzahlung','#FF6347',
        `LiquiditÃ¤t: <strong>${fc(P.cash)}</strong> â€¢ Portfolio: <strong>${fc(sv)}</strong>`);
}

function updatePenaltyPreview() {
    const pct   = parseFloat(document.getElementById('penaltyPercentage').value) || 0;
    const sv    = stockValue();
    const fine  = sv * pct / 100;
    const wrap  = document.getElementById('penaltyPreview');
    const liq   = document.getElementById('quickLiquidation');
    const btn   = document.getElementById('payPenaltyBtn');

    if (pct === 0) {
        wrap.innerHTML = '<p style="color:var(--gold-light);text-align:center;">Prozentsatz eingeben</p>';
        liq.classList.add('hidden');
        return;
    }

    const canPay = fine <= P.cash;
    wrap.innerHTML = `
        <h4 style="color:var(--gold);margin-bottom:1rem;">ğŸ’° Bussen-Details</h4>
        <div style="display:grid;gap:.4rem;">
            <div style="display:flex;justify-content:space-between;"><span>Portfolio-Wert:</span><strong>${fc(sv)}</strong></div>
            <div style="display:flex;justify-content:space-between;"><span>Busse (${pct}%):</span><strong style="color:#FF6347;">${fc(fine)}</strong></div>
            <div style="display:flex;justify-content:space-between;"><span>VerfÃ¼gbare LiquiditÃ¤t:</span><strong>${fc(P.cash)}</strong></div>
            ${!canPay ? `<div style="display:flex;justify-content:space-between;color:#FF6347;"><span>Fehlbetrag:</span><strong>${fc(fine - P.cash)}</strong></div>` : ''}
        </div>
        <div style="margin-top:1rem;padding:1rem;background:${canPay?'rgba(0,255,127,.1)':'rgba(255,69,0,.1)'};border-radius:8px;">
            <span style="color:${canPay?'var(--green)':'#FF6347'};">
                ${canPay ? 'âœ… Kann vollstÃ¤ndig aus LiquiditÃ¤t bezahlt werden' : 'âš ï¸ Nicht genug LiquiditÃ¤t! Bitte Aktien verkaufen.'}
            </span>
        </div>`;

    if (!canPay) { liq.classList.remove('hidden'); renderQuickLiquidation(); }
    else { liq.classList.add('hidden'); }

    btn.disabled = !canPay;
    btn.textContent = canPay ? 'ğŸ’¸ Busse Bezahlen' : 'âŒ Nicht genug LiquiditÃ¤t';
}

function renderQuickLiquidation() {
    const grid = document.getElementById('liquidationGrid');
    grid.innerHTML = '';
    STOCKS.forEach(({ id, name }) => {
        const h = P.portfolio[id] || 0;
        if (h === 0) return;
        const price = G.stockPrices[id];
        grid.insertAdjacentHTML('beforeend', `
            <div style="background:rgba(255,255,255,.05);border:1px solid var(--orange);border-radius:8px;padding:1rem;">
                <h5 style="color:#FF6347;margin-bottom:.25rem;">${name}</h5>
                <div style="color:var(--gold-light);font-size:.85rem;margin-bottom:.5rem;">${h} Stk. @ ${fc(price)}</div>
                <div style="display:flex;gap:.5rem;align-items:center;">
                    <input type="number" id="qs_${id}" class="form-control" placeholder="Anz."
                           min="0" max="${h}" step="1" style="flex:1;padding:.5rem;">
                    <button type="button" class="btn btn-orange" onclick="quickSell('${id}')" style="padding:.5rem 1rem;">Verkaufen</button>
                </div>
            </div>`);
    });
}

function quickSell(stockId) {
    const amt = parseInt(document.getElementById('qs_'+stockId).value) || 0;
    if (amt <= 0) { showAlert('penaltyAlert','UngÃ¼ltige Menge.','error'); return; }
    if (amt > (P.portfolio[stockId] || 0)) { showAlert('penaltyAlert','Nicht genug Stk. im Besitz.','error'); return; }

    const price = G.stockPrices[stockId];
    const rev   = amt * price;
    P.cash += rev;
    P.portfolio[stockId] -= amt;
    fifoSell(stockId, amt, price);
    P.transactions.push({ round:G.round, type:'quick_sell', id:stockId, amount:amt, price, total:rev });

    pushHistory();
    saveState();
    document.getElementById('qs_'+stockId).value = '';
    updatePenaltyPreview();
    showAlert('penaltyAlert', `âœ… ${amt} ${sn(stockId)} fÃ¼r ${fc(rev)} verkauft.`, 'success');
}

function processPenalty(e) {
    e.preventDefault();
    const pct  = parseFloat(document.getElementById('penaltyPercentage').value) || 0;
    if (pct <= 0 || pct > 70) { showAlert('penaltyAlert','Prozentsatz muss zwischen 0 und 70 liegen.','error'); return; }

    const sv   = stockValue();
    const fine = sv * pct / 100;
    if (P.cash < fine) { showAlert('penaltyAlert','Nicht genug LiquiditÃ¤t â€“ Aktien zuerst verkaufen.','error'); return; }

    P.cash -= fine;
    P.penaltyHistory.push({ round:G.round, pct, portfolioValue:sv, amount:fine });
    pushHistory();
    saveState();
    showAlert('penaltyAlert', `ğŸ’¸ Busse von ${fc(fine)} erfolgreich bezahlt!`, 'success');
    setTimeout(showBusinessDashboard, 2000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOANS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLoanInterface() {
    show('loanSection');
    renderInfoBar('loanInfo','CSBS Darlehensabteilung','var(--purple-light)');
    calcLoanTerms();
    showLoanTab('new');
    renderExistingLoans();
}

function showLoanTab(tab) {
    const isNew = tab === 'new';
    document.getElementById('loanForm').classList.toggle('hidden', !isNew);
    document.getElementById('repayForm').classList.toggle('hidden', isNew);
    document.getElementById('tabNewLoan').style.background  = isNew ? 'linear-gradient(145deg,#4B0082,var(--purple))' : 'linear-gradient(145deg,var(--bronze),#A0522D)';
    document.getElementById('tabRepayLoan').style.background = isNew ? 'linear-gradient(145deg,var(--bronze),#A0522D)' : 'linear-gradient(145deg,#32CD32,#228B22)';
    if (!isNew) {
        document.getElementById('availableCashDisplay').textContent = fc(P.cash);
        document.getElementById('totalDebtDisplay').textContent     = fc(P.totalDebt || 0);
        updateRepaymentPreview();
    }
}

function renderExistingLoans() {
    const wrap = document.getElementById('existingLoansDisplay');
    const list = document.getElementById('existingLoansList');
    if (!P.loans || P.loans.length === 0) { wrap.classList.add('hidden'); return; }
    wrap.classList.remove('hidden');
    list.innerHTML = '<div style="display:grid;gap:.75rem;">' +
        P.loans.map((l, i) => `
            <div style="background:rgba(255,255,255,.05);border-left:4px solid var(--danger);padding:1rem;border-radius:8px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:.25rem;">
                    <span>Darlehen #${i+1}</span>
                    <span style="color:#FF6347;font-weight:600;">${fc(l.totalOwed)}</span>
                </div>
                <div style="color:var(--gold-light);font-size:.85rem;">
                    Runde ${l.round} â€¢ ${l.interestRate.toFixed(2)}% Zinsen â€¢ Ursprung: ${fc(l.principal)}
                </div>
            </div>`).join('')
        + '</div>';
}

function calcLoanTerms() {
    recalcTotalValue();
    const perf = P.initialCash !== 0 ? ((P.totalValue - P.initialCash) / P.initialCash) * 100 : 0;
    let rate = 7.5
        - (P.totalValue - 100000) / 200000
        - perf / 10
        + Math.min((P.totalDebt && P.totalValue > 0 ? (P.totalDebt / Math.abs(P.totalValue)) * 5 : 0), 5);
    rate = Math.max(0.3, Math.min(13, rate));

    const maxLoan = Math.round(Math.max(100000, Math.abs(P.totalValue) * 4) / 10000) * 10000;

    document.getElementById('interestRateDisplay').textContent = rate.toFixed(2) + '%';
    document.getElementById('maxLoanDisplay').textContent = fc(maxLoan);
    document.getElementById('loanAmount').max = maxLoan;

    P._loanTerms = { rate, maxLoan, minLoan: 10000 };
    updateLoanPreview();
}

function updateLoanPreview() {
    if (!P._loanTerms) { calcLoanTerms(); return; }
    const { rate, maxLoan, minLoan } = P._loanTerms;
    const amt = parseInt(document.getElementById('loanAmount').value) || 0;
    const el  = document.getElementById('loanPreview');

    if (!amt) { el.innerHTML = '<p style="color:var(--gold-light);text-align:center;">Betrag eingeben</p>'; return; }
    if (amt < minLoan || amt > maxLoan) {
        el.innerHTML = `<p style="color:#FF6347;text-align:center;">Muss zwischen ${fc(minLoan)} und ${fc(maxLoan)} liegen.</p>`;
        return;
    }

    const interest = amt * rate / 100;
    el.innerHTML = `
        <h4 style="color:var(--purple-light);margin-bottom:1rem;">ğŸ“Š Konditionen</h4>
        <div style="display:grid;gap:.4rem;">
            <div style="display:flex;justify-content:space-between;"><span>Betrag:</span><strong>${fc(amt)}</strong></div>
            <div style="display:flex;justify-content:space-between;"><span>Zinssatz/Runde:</span><strong style="color:var(--purple-light);">${rate.toFixed(2)}%</strong></div>
            <div style="display:flex;justify-content:space-between;"><span>Zinsen/Runde:</span><strong style="color:#FF6347;">${fc(interest)}</strong></div>
            <div style="display:flex;justify-content:space-between;padding-top:.5rem;border-top:1px solid rgba(106,13,173,.3);">
                <span>Schuld nach 1 Runde:</span><strong style="color:#FF6347;">${fc(amt + interest)}</strong>
            </div>
        </div>
        <p style="color:var(--gold-light);font-size:.85rem;margin-top:1rem;">âš ï¸ Zinsen werden bei jeder PreisÃ¤nderung automatisch addiert.</p>`;
}

function updateRepaymentPreview() {
    const amt  = parseInt(document.getElementById('repayAmount').value) || 0;
    const el   = document.getElementById('repaymentPreview');
    const debt = P.totalDebt || 0;

    if (!amt) { el.innerHTML = '<p style="color:var(--gold-light);text-align:center;">Betrag eingeben</p>'; return; }
    if (amt > P.cash)  { el.innerHTML = `<p style="color:#FF6347;text-align:center;">Nicht genug LiquiditÃ¤t (${fc(P.cash)}).</p>`; return; }
    if (amt > debt)    { el.innerHTML = `<p style="color:#FF6347;text-align:center;">Ãœbersteigt Schulden (${fc(debt)}).</p>`; return; }

    el.innerHTML = `
        <h4 style="color:#32CD32;margin-bottom:1rem;">ğŸ“Š RÃ¼ckzahlung</h4>
        <div style="display:grid;gap:.4rem;">
            <div style="display:flex;justify-content:space-between;"><span>Betrag:</span><strong>${fc(amt)}</strong></div>
            <div style="display:flex;justify-content:space-between;"><span>Aktuelle Schulden:</span><strong style="color:#FF6347;">${fc(debt)}</strong></div>
            <div style="display:flex;justify-content:space-between;padding-top:.5rem;border-top:1px solid rgba(50,205,50,.3);">
                <span>Neue Schulden:</span><strong style="color:${debt-amt===0?'var(--green)':'#FF6347'};">${fc(debt-amt)}</strong>
            </div>
            <div style="display:flex;justify-content:space-between;"><span>Neue LiquiditÃ¤t:</span><strong>${fc(P.cash-amt)}</strong></div>
        </div>`;
}

function processLoan(e) {
    e.preventDefault();
    if (!P._loanTerms) { calcLoanTerms(); return; }
    const { rate, maxLoan, minLoan } = P._loanTerms;
    const amt = parseInt(document.getElementById('loanAmount').value) || 0;

    if (amt < minLoan || amt > maxLoan) {
        showAlert('loanAlert', `Betrag muss zwischen ${fc(minLoan)} und ${fc(maxLoan)} liegen.`, 'error');
        return;
    }

    P.loans.push({ round:G.round, principal:amt, interestRate:rate, totalOwed:amt });
    P.cash += amt;
    P.totalDebt = (P.totalDebt || 0) + amt;
    pushHistory();
    saveState();
    showAlert('loanAlert', `ğŸ¦ Darlehen ${fc(amt)} aufgenommen! Zinssatz: ${rate.toFixed(2)}%`, 'success');
    setTimeout(showBusinessDashboard, 2000);
}

function processRepayment(e) {
    e.preventDefault();
    const amt  = parseInt(document.getElementById('repayAmount').value) || 0;
    const debt = P.totalDebt || 0;

    if (amt <= 0 || amt > P.cash) { showAlert('loanAlert','UngÃ¼ltiger Betrag oder nicht genug LiquiditÃ¤t.','error'); return; }
    if (amt > debt)               { showAlert('loanAlert',`Ãœbersteigt Gesamtschulden (${fc(debt)}).`,'error'); return; }

    // Pay off highest-rate loans first
    P.loans.sort((a, b) => b.interestRate - a.interestRate);
    let remaining = amt;
    const newLoans = [];
    for (const loan of P.loans) {
        if (remaining <= 0)              { newLoans.push(loan); }
        else if (remaining >= loan.totalOwed) { remaining -= loan.totalOwed; }
        else { loan.totalOwed -= remaining; newLoans.push(loan); remaining = 0; }
    }
    P.loans = newLoans;
    P.cash     -= amt;
    P.totalDebt = Math.max(0, debt - amt);

    pushHistory();
    saveState();
    showAlert('loanAlert', `ğŸ’³ ${fc(amt)} zurÃ¼ckgezahlt! Verbleibende Schulden: ${fc(P.totalDebt)}`, 'success');
    setTimeout(showBusinessDashboard, 2000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONTINUE TO NEXT ROUND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function continueToNextRound() {
    needsRoundIncrement = true;
    saveState();
    showAlert('specialAlert', `â¡ï¸ Runde ${G.round} abgeschlossen! Zur nÃ¤chsten Rundeâ€¦`, 'success');
    setTimeout(showGameDashboard, 1800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRADER TIP-OFF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTraderTipOff() {
    const trades = P._pendingTrades || [];
    if (!trades.length) { alert('Keine Trades fÃ¼r Tip-Off vorhanden!'); return; }

    const t    = trades[Math.floor(Math.random() * trades.length)];
    const isBuy = t.action === 'buy';
    const color = isBuy ? 'var(--green)' : '#FF6347';

    document.getElementById('tipOffContent').innerHTML = `
        <p style="color:var(--gold-light);font-size:1.05rem;margin-bottom:1.5rem;font-style:italic;">
            "Psstâ€¦ ich habe gehÃ¶rt, dass jemand einen interessanten Trade plantâ€¦"
        </p>
        <div style="background:rgba(0,0,0,.5);border-radius:8px;padding:1.5rem;">
            <p style="font-size:1.2rem;margin-bottom:.75rem;">
                <strong>${P.name}</strong> ${isBuy ? 'ğŸ“ˆ' : 'ğŸ“‰'}
                <strong style="color:${color};">${isBuy ? 'KAUFT' : 'VERKAUFT'}</strong>
            </p>
            <p style="font-size:1.9rem;color:var(--gold);font-weight:bold;margin-bottom:.5rem;">
                ${t.amount} Ã— ${sn(t.id)}
            </p>
            <p style="color:var(--gold-light);">Ã  ${fc(t.price)}</p>
            <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--gold-dim);">
                <span style="font-size:1.4rem;color:${color};font-weight:bold;">
                    ${fc(t.total)}
                </span>
            </div>
        </div>`;

    document.getElementById('tipOffModal').classList.remove('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  END GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Custom confirm dialog (replaces browser confirm() which is blocked in iframes)
function showConfirm(icon, title, text, onYes) {
    document.getElementById('confirmModalIcon').textContent = icon;
    document.getElementById('confirmModalTitle').textContent = title;
    document.getElementById('confirmModalText').textContent = text;
    const btn = document.getElementById('confirmModalYes');
    btn.onclick = () => { closeModal('confirmModal'); onYes(); };
    document.getElementById('confirmModal').classList.remove('hidden');
}

function endGame() {
    showConfirm('ğŸ', 'Spiel beenden?', 'Das Spiel wird beendet und das Abschluss-Dashboard angezeigt.', () => {
        _doEndGame();
    });
}

function _doEndGame() {
    recalcTotalValue();

    // Capture all needed data into local variables BEFORE clearing state
    const snapshot = {
        name:       P.name,
        rounds:     G.round,
        totalValue: P.totalValue,
        cash:       P.cash,
        totalDebt:  P.totalDebt || 0,
        initialCash:P.initialCash,
        portfolio:  { ...P.portfolio },
        stockPrices:{ ...G.stockPrices },
        realizedPnL:{ ...P.realizedPnL },
        valueHistory: P.valueHistory.slice(),
    };

    const perf      = snapshot.initialCash !== 0 ? ((snapshot.totalValue - snapshot.initialCash) / snapshot.initialCash) * 100 : 0;
    const perfColor = perf >= 0 ? 'var(--green)' : '#FF6347';

    // Build portfolio rows
    const holdingsRows = STOCK_IDS
        .filter(id => (snapshot.portfolio[id] || 0) > 0)
        .map(id => {
            const shares = snapshot.portfolio[id];
            const price  = snapshot.stockPrices[id];
            const val    = shares * price;
            return `<div style="display:flex;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid rgba(212,175,55,.1);">
                <span>${sn(id)}</span>
                <span>${shares} Stk. Ã— ${fc(price)} = <strong>${fc(val)}</strong></span>
            </div>`;
        }).join('');

    // Realized P&L rows
    const pnlRows = STOCK_IDS
        .filter(id => snapshot.realizedPnL[id] !== 0)
        .sort((a, b) => snapshot.realizedPnL[b] - snapshot.realizedPnL[a])
        .map(id => `<div style="display:flex;justify-content:space-between;padding:.4rem 0;">
            <span>${sn(id)}</span>
            <span style="color:${snapshot.realizedPnL[id]>=0?'var(--green)':'#FF6347'};font-weight:600;">
                ${snapshot.realizedPnL[id]>=0?'+':''}${fc(snapshot.realizedPnL[id])}
            </span>
        </div>`).join('');

    document.getElementById('finalSummary').innerHTML = `
        <div style="text-align:center;margin-bottom:2rem;">
            <h3 style="color:var(--gold);font-size:1.8rem;margin-bottom:.5rem;">${snapshot.name}</h3>
            <p style="color:var(--gold-light);">${snapshot.rounds} Runden gespielt</p>
        </div>
        <div class="stats-grid" style="margin-bottom:2rem;">
            <div class="stat-card"><div class="stat-value">${fc(snapshot.totalValue)}</div><div class="stat-label">EndvermÃ¶gen</div></div>
            <div class="stat-card"><div class="stat-value" style="color:${perfColor};">${fp(perf)}</div><div class="stat-label">Gesamtperformance</div></div>
            <div class="stat-card"><div class="stat-value">${fc(snapshot.cash)}</div><div class="stat-label">LiquiditÃ¤t</div></div>
            <div class="stat-card"><div class="stat-value" style="color:${snapshot.totalDebt>0?'#FF6347':'var(--green)'};">${fc(snapshot.totalDebt)}</div><div class="stat-label">Schulden</div></div>
        </div>
        ${holdingsRows ? `<div style="background:rgba(0,0,0,.2);border-radius:12px;padding:1.5rem;margin-bottom:2rem;">
            <h3 style="color:var(--gold);margin-bottom:1rem;">ğŸ’¼ Portfolio bei Spielende</h3>
            ${holdingsRows}
        </div>` : ''}
        ${pnlRows ? `<div style="background:rgba(0,0,0,.2);border-radius:12px;padding:1.5rem;margin-bottom:2rem;">
            <h3 style="color:var(--gold);margin-bottom:1rem;">ğŸ† Realisierte Gewinne/Verluste</h3>
            ${pnlRows}
        </div>` : ''}
        <div class="chart-container" style="margin-bottom:0;">
            <h3 style="color:var(--gold);margin-bottom:1.5rem;">ğŸ“ˆ VermÃ¶gensverlauf</h3>
            <div id="finalChart" style="width:100%;height:240px;"></div>
        </div>`;

    // Clear state NOW (before show, so any accidental re-render won't use stale G/P)
    clearStorage();
    G = null; P = null;

    show('finalDashboard');

    // Defer chart render to next frame so the container has a real clientWidth
    requestAnimationFrame(() => {
        const el   = document.getElementById('finalChart');
        if (!el) return;
        const vals = snapshot.valueHistory.slice(1);
        if (vals.length === 0) {
            el.innerHTML = '<p style="color:var(--gold-light);text-align:center;padding-top:2rem;">Keine Verlaufsdaten</p>';
            return;
        }
        const W   = el.clientWidth || 560, H = 240;
        const pad = { t:20, r:20, b:55, l:90 };
        const cw  = W - pad.l - pad.r, ch = H - pad.t - pad.b;
        const maxV = Math.max(...vals), minV = Math.min(0, ...vals), range = maxV - minV || 1;
        const xOf  = i => pad.l + (vals.length > 1 ? i * cw / (vals.length - 1) : cw / 2);
        const yOf  = v => pad.t + ((maxV - v) / range) * ch;
        const pts  = vals.map((v, i) => `${xOf(i)},${yOf(v)}`).join(' ');
        let dots   = '';
        vals.forEach((v, i) => {
            const x = xOf(i), y = yOf(v);
            dots += `<circle cx="${x}" cy="${y}" r="5" fill="var(--gold)"/>
                <text x="${x}" y="${H-pad.b+18}" fill="var(--gold-light)" text-anchor="middle" font-size="11">R${i+1}</text>
                <text x="${x}" y="${H-pad.b+33}" fill="var(--cream)" text-anchor="middle" font-size="10" font-weight="600">${fk(v)}</text>`;
        });
        el.innerHTML = `<svg viewBox="0 0 ${W} ${H}" style="width:100%;height:100%;">
            <line x1="${pad.l}" y1="${pad.t}" x2="${pad.l}" y2="${H-pad.b}" stroke="rgba(212,175,55,.3)"/>
            <line x1="${pad.l}" y1="${H-pad.b}" x2="${W-pad.r}" y2="${H-pad.b}" stroke="rgba(212,175,55,.3)"/>
            <polyline fill="none" stroke="var(--gold)" stroke-width="3" points="${pts}"/>${dots}
        </svg>`;
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOTSTRAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
